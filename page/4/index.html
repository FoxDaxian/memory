<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">






















<link rel="stylesheet" href="/memory/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/memory/css/main.css?v=7.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/memory/images/apple-touch-icon-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/memory/images/favicon-32x32-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/memory/images/favicon-16x16-next.png?v=7.2.0">


  <link rel="mask-icon" href="/memory/images/logo.svg?v=7.2.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/memory/',
    scheme: 'Muse',
    version: '7.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
<meta name="keywords" content="博客 分享">
<meta property="og:type" content="website">
<meta property="og:title" content="fox的博客">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="fox的博客">
<meta property="og:description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="fox的博客">
<meta name="twitter:description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">





  
  
  <link rel="canonical" href="http://yoursite.com/page/4/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>fox的博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/memory/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">fox的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">github地址 -> https://github.com/FoxDaxian</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
      
    

    

    <a href="/memory/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/memory/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/memory/2021/05/09/tapable/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FoxDaxian">
      <meta itemprop="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
      <meta itemprop="image" content="/memory/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fox的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/memory/2021/05/09/tapable/" class="post-title-link" itemprop="url">tapable简析</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-05-09 23:37:00" itemprop="dateCreated datePublished" datetime="2021-05-09T23:37:00+00:00">2021-05-09</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/memory/categories/原理/" itemprop="url" rel="index"><span itemprop="name">原理</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>由于webpack底层使用Tapable创建和执行钩子，所以也大致了解下tapable的原理</p>
<p>Tapable使用es6语法翻新了一遍，目前都是基于类的方式编写的。我们先看下目录结构：</p>
<p><img src="https://github.com/FoxDaxian/FoxDaxian.github.io/blob/master/assets/08_tapable/contentTree.png?raw=true" alt="alt"><br>我们其实主要看<em>Hook.js</em>和<em>HookCodeFactory.js</em>就够了，其他的基本都是大同小异的，都是依赖于这两个基类，然后扩展Hook的compile方法和HookCodeFactory的content方法，下面直接上代码。<br>因为几乎是大同小异，所以我们这里以最简单的SyncHook为实例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"><span class="comment">// 基类</span></span><br><span class="line"><span class="keyword">const</span> Hook = <span class="built_in">require</span>(<span class="string">"./Hook"</span>);</span><br><span class="line"><span class="keyword">const</span> HookCodeFactory = <span class="built_in">require</span>(<span class="string">"./HookCodeFactory"</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncHookCodeFactory</span> <span class="keyword">extends</span> <span class="title">HookCodeFactory</span> </span>&#123;</span><br><span class="line">	content(&#123; onError, onResult, onDone, rethrowIfPossible &#125;) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.callTapsSeries(&#123;</span><br><span class="line">			onError: <span class="function">(<span class="params">i, err</span>) =&gt;</span> onError(err),</span><br><span class="line">			onDone,</span><br><span class="line">			rethrowIfPossible</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> factory = <span class="keyword">new</span> SyncHookCodeFactory();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncHook</span> <span class="keyword">extends</span> <span class="title">Hook</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 未提供的方法直接抛出异常提示</span></span><br><span class="line">	tapAsync() &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"tapAsync is not supported on a SyncHook"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tapPromise() &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"tapPromise is not supported on a SyncHook"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 为调用方法call、callAsync、promise提供依赖</span></span><br><span class="line">	compile(options) &#123;</span><br><span class="line">		factory.setup(<span class="keyword">this</span>, options);</span><br><span class="line">		<span class="keyword">return</span> factory.create(options);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = SyncHook;</span><br></pre></td></tr></table></figure>

<p>正如上面的代码所以，直观来看就是集成了两个基类，然后导出钩子函数，先从Hook说起：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> util = <span class="built_in">require</span>(<span class="string">"util"</span>);</span><br><span class="line"><span class="comment">//  抛出警告</span></span><br><span class="line"><span class="keyword">const</span> deprecateContext = util.deprecate(<span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;,</span><br><span class="line"><span class="string">"Hook.context is deprecated and will be removed"</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hook</span> </span>&#123;</span><br><span class="line">	<span class="keyword">constructor</span>(args = []) &#123;</span><br><span class="line">        <span class="comment">// 参数们</span></span><br><span class="line">		<span class="keyword">this</span>._args = args;</span><br><span class="line">        <span class="comment">// 类似监听模式下的队列</span></span><br><span class="line">		<span class="keyword">this</span>.taps = [];</span><br><span class="line">        <span class="comment">// 拦截器</span></span><br><span class="line">		<span class="keyword">this</span>.interceptors = [];</span><br><span class="line">        <span class="comment">// 初始化相关调用方法</span></span><br><span class="line">		<span class="keyword">this</span>.call = <span class="keyword">this</span>._call;</span><br><span class="line">		<span class="keyword">this</span>.promise = <span class="keyword">this</span>._promise;</span><br><span class="line">		<span class="keyword">this</span>.callAsync = <span class="keyword">this</span>._callAsync;</span><br><span class="line">        <span class="comment">// 自定义的方法队列</span></span><br><span class="line">		<span class="keyword">this</span>._x = <span class="literal">undefined</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	compile(options) &#123;</span><br><span class="line">        <span class="comment">// 必须重写compile方法</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Abstract: should be overriden"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 用于创建相关调用方法的私有方法</span></span><br><span class="line">	_createCall(type) &#123;</span><br><span class="line">        <span class="comment">// 被重写的compile方法</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.compile(&#123;</span><br><span class="line">			taps: <span class="keyword">this</span>.taps,</span><br><span class="line">			interceptors: <span class="keyword">this</span>.interceptors,</span><br><span class="line">			args: <span class="keyword">this</span>._args,</span><br><span class="line">			type: type</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_tap(type, options, fn) &#123;</span><br><span class="line">        <span class="comment">//   参数处理</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">"string"</span>) &#123;</span><br><span class="line">			options = &#123;</span><br><span class="line">				name: options</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> options !== <span class="string">"object"</span> || options === <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid tap options"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">typeof</span> options.name !== <span class="string">"string"</span> || options.name === <span class="string">""</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Missing name for tap"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">typeof</span> options.context !== <span class="string">"undefined"</span>) &#123;</span><br><span class="line">			deprecateContext();</span><br><span class="line">		&#125;</span><br><span class="line">		options = <span class="built_in">Object</span>.assign(&#123; type, fn &#125;, options);</span><br><span class="line">        <span class="comment">// 拦截器</span></span><br><span class="line">		options = <span class="keyword">this</span>._runRegisterInterceptors(options);</span><br><span class="line">		<span class="keyword">this</span>._insert(options);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tap(options, fn) &#123;</span><br><span class="line">		<span class="keyword">this</span>._tap(<span class="string">"sync"</span>, options, fn);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tapAsync(options, fn) &#123;</span><br><span class="line">		<span class="keyword">this</span>._tap(<span class="string">"async"</span>, options, fn);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tapPromise(options, fn) &#123;</span><br><span class="line">		<span class="keyword">this</span>._tap(<span class="string">"promise"</span>, options, fn);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 拦截器</span></span><br><span class="line">	_runRegisterInterceptors(options) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">const</span> interceptor <span class="keyword">of</span> <span class="keyword">this</span>.interceptors) &#123;</span><br><span class="line">			<span class="keyword">if</span> (interceptor.register) &#123;</span><br><span class="line">				<span class="keyword">const</span> newOptions = interceptor.register(options);</span><br><span class="line">				<span class="keyword">if</span> (newOptions !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">					options = newOptions;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> options;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	withOptions(options) &#123;</span><br><span class="line">		<span class="keyword">const</span> mergeOptions = <span class="function"><span class="params">opt</span> =&gt;</span></span><br><span class="line">			<span class="built_in">Object</span>.assign(&#123;&#125;, options, <span class="keyword">typeof</span> opt === <span class="string">"string"</span> ? &#123; <span class="attr">name</span>: opt &#125; : opt);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Prevent creating endless prototype chains</span></span><br><span class="line">		options = <span class="built_in">Object</span>.assign(&#123;&#125;, options, <span class="keyword">this</span>._withOptions);</span><br><span class="line">		<span class="keyword">const</span> base = <span class="keyword">this</span>._withOptionsBase || <span class="keyword">this</span>;</span><br><span class="line">		<span class="keyword">const</span> newHook = <span class="built_in">Object</span>.create(base);</span><br><span class="line"></span><br><span class="line">		newHook.tap = <span class="function">(<span class="params">opt, fn</span>) =&gt;</span> base.tap(mergeOptions(opt), fn);</span><br><span class="line">		newHook.tapAsync = <span class="function">(<span class="params">opt, fn</span>) =&gt;</span> base.tapAsync(mergeOptions(opt), fn);</span><br><span class="line">		newHook.tapPromise = <span class="function">(<span class="params">opt, fn</span>) =&gt;</span> base.tapPromise(mergeOptions(opt), fn);</span><br><span class="line">		newHook._withOptions = options;</span><br><span class="line">		newHook._withOptionsBase = base;</span><br><span class="line">		<span class="keyword">return</span> newHook;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	isUsed() &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.taps.length &gt; <span class="number">0</span> || <span class="keyword">this</span>.interceptors.length &gt; <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	intercept(interceptor) &#123;</span><br><span class="line">		<span class="keyword">this</span>._resetCompilation();</span><br><span class="line">		<span class="keyword">this</span>.interceptors.push(<span class="built_in">Object</span>.assign(&#123;&#125;, interceptor));</span><br><span class="line">		<span class="keyword">if</span> (interceptor.register) &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.taps.length; i++) &#123;</span><br><span class="line">				<span class="keyword">this</span>.taps[i] = interceptor.register(<span class="keyword">this</span>.taps[i]);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_resetCompilation() &#123;</span><br><span class="line">		<span class="keyword">this</span>.call = <span class="keyword">this</span>._call;</span><br><span class="line">		<span class="keyword">this</span>.callAsync = <span class="keyword">this</span>._callAsync;</span><br><span class="line">		<span class="keyword">this</span>.promise = <span class="keyword">this</span>._promise;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_insert(item) &#123;</span><br><span class="line">		<span class="keyword">this</span>._resetCompilation();</span><br><span class="line">		<span class="keyword">let</span> before;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">typeof</span> item.before === <span class="string">"string"</span>) &#123;</span><br><span class="line">			before = <span class="keyword">new</span> <span class="built_in">Set</span>([item.before]);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(item.before)) &#123;</span><br><span class="line">			before = <span class="keyword">new</span> <span class="built_in">Set</span>(item.before);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">let</span> stage = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">typeof</span> item.stage === <span class="string">"number"</span>) &#123;</span><br><span class="line">			stage = item.stage;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">let</span> i = <span class="keyword">this</span>.taps.length;</span><br><span class="line">		<span class="keyword">while</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			i--;</span><br><span class="line">			<span class="keyword">const</span> x = <span class="keyword">this</span>.taps[i];</span><br><span class="line">			<span class="keyword">this</span>.taps[i + <span class="number">1</span>] = x;</span><br><span class="line">			<span class="keyword">const</span> xStage = x.stage || <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">if</span> (before) &#123;</span><br><span class="line">				<span class="keyword">if</span> (before.has(x.name)) &#123;</span><br><span class="line">					before.delete(x.name);</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (before.size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (xStage &gt; stage) &#123;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			i++;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.taps[i] = item;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createCompileDelegate</span>(<span class="params">name, type</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">lazyCompileHook</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>[name] = <span class="keyword">this</span>._createCall(type);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>[name](...args);</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.defineProperties(Hook.prototype, &#123;</span><br><span class="line">	_call: &#123;</span><br><span class="line">		value: createCompileDelegate(<span class="string">"call"</span>, <span class="string">"sync"</span>),</span><br><span class="line">		configurable: <span class="literal">true</span>,</span><br><span class="line">		writable: <span class="literal">true</span></span><br><span class="line">	&#125;,</span><br><span class="line">	_callAsync: &#123;</span><br><span class="line">		value: createCompileDelegate(<span class="string">"callAsync"</span>, <span class="string">"async"</span>),</span><br><span class="line">		configurable: <span class="literal">true</span>,</span><br><span class="line">		writable: <span class="literal">true</span></span><br><span class="line">	&#125;,</span><br><span class="line">	_promise: &#123;</span><br><span class="line">		value: createCompileDelegate(<span class="string">"promise"</span>, <span class="string">"promise"</span>),</span><br><span class="line">		configurable: <span class="literal">true</span>,</span><br><span class="line">		writable: <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = Hook;</span><br></pre></td></tr></table></figure>

<p>我们需要用tap、tapAsync、tapPromise往队列中添加函数，然后使用call来调用，不过call会根据不同类型的钩子产出不同的函数，这也是tapable做的优化，而这些函数的产出这来自HookCodeFactory：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HookCodeFactory</span> </span>&#123;</span><br><span class="line">	<span class="keyword">constructor</span>(config) &#123;</span><br><span class="line">		<span class="keyword">this</span>.config = config;</span><br><span class="line">		<span class="keyword">this</span>.options = <span class="literal">undefined</span>;</span><br><span class="line">		<span class="keyword">this</span>._args = <span class="literal">undefined</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 创建相关的方法体，对不同的type进行判断</span></span><br><span class="line">    <span class="comment">// Fcuntion接受任意个参数，除最后一个，之前的都是函数的形参</span></span><br><span class="line">	create(options) &#123;</span><br><span class="line">		<span class="keyword">this</span>.init(options);</span><br><span class="line">		<span class="keyword">let</span> fn;</span><br><span class="line">		<span class="keyword">switch</span> (<span class="keyword">this</span>.options.type) &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">"sync"</span>:</span><br><span class="line">				fn = <span class="keyword">new</span> <span class="built_in">Function</span>(</span><br><span class="line">					<span class="keyword">this</span>.args(),</span><br><span class="line">					<span class="string">'"use strict";\n'</span> +</span><br><span class="line">						<span class="keyword">this</span>.header() +</span><br><span class="line">						<span class="keyword">this</span>.content(&#123;</span><br><span class="line">							onError: <span class="function"><span class="params">err</span> =&gt;</span> <span class="string">`throw <span class="subst">$&#123;err&#125;</span>;\n`</span>,</span><br><span class="line">							onResult: <span class="function"><span class="params">result</span> =&gt;</span> <span class="string">`return <span class="subst">$&#123;result&#125;</span>;\n`</span>,</span><br><span class="line">							onDone: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">								<span class="built_in">console</span>.log(<span class="string">'完成函数'</span>);</span><br><span class="line">							&#125;,</span><br><span class="line">							rethrowIfPossible: <span class="literal">true</span></span><br><span class="line">						&#125;)</span><br><span class="line">				);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">"async"</span>:</span><br><span class="line">				fn = <span class="keyword">new</span> <span class="built_in">Function</span>(</span><br><span class="line">					<span class="keyword">this</span>.args(&#123;</span><br><span class="line">						after: <span class="string">"_callback"</span></span><br><span class="line">					&#125;),</span><br><span class="line">					<span class="string">'"use strict";\n'</span> +</span><br><span class="line">						<span class="keyword">this</span>.header() +</span><br><span class="line">						<span class="keyword">this</span>.content(&#123;</span><br><span class="line">							onError: <span class="function"><span class="params">err</span> =&gt;</span> <span class="string">`_callback(<span class="subst">$&#123;err&#125;</span>);\n`</span>,</span><br><span class="line">							onResult: <span class="function"><span class="params">result</span> =&gt;</span> <span class="string">`_callback(null, <span class="subst">$&#123;result&#125;</span>);\n`</span>,</span><br><span class="line">							onDone: <span class="function"><span class="params">()</span> =&gt;</span> <span class="string">"_callback();\n"</span></span><br><span class="line">						&#125;)</span><br><span class="line">				);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">"promise"</span>:</span><br><span class="line">				<span class="keyword">let</span> code = <span class="string">""</span>;</span><br><span class="line">				code += <span class="string">'"use strict";\n'</span>;</span><br><span class="line">				code += <span class="string">"return new Promise((_resolve, _reject) =&gt; &#123;\n"</span>;</span><br><span class="line">				code += <span class="string">"var _sync = true;\n"</span>;</span><br><span class="line">				code += <span class="keyword">this</span>.header();</span><br><span class="line">				code += <span class="keyword">this</span>.content(&#123;</span><br><span class="line">					onError: <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">						<span class="keyword">let</span> code = <span class="string">""</span>;</span><br><span class="line">						code += <span class="string">"if(_sync)\n"</span>;</span><br><span class="line">						code += <span class="string">`_resolve(Promise.resolve().then(() =&gt; &#123; throw <span class="subst">$&#123;err&#125;</span>; &#125;));\n`</span>;</span><br><span class="line">						code += <span class="string">"else\n"</span>;</span><br><span class="line">						code += <span class="string">`_reject(<span class="subst">$&#123;err&#125;</span>);\n`</span>;</span><br><span class="line">						<span class="keyword">return</span> code;</span><br><span class="line">					&#125;,</span><br><span class="line">					onResult: <span class="function"><span class="params">result</span> =&gt;</span> <span class="string">`_resolve(<span class="subst">$&#123;result&#125;</span>);\n`</span>,</span><br><span class="line">					onDone: <span class="function"><span class="params">()</span> =&gt;</span> <span class="string">"_resolve();\n"</span></span><br><span class="line">				&#125;);</span><br><span class="line">				code += <span class="string">"_sync = false;\n"</span>;</span><br><span class="line">				code += <span class="string">"&#125;);\n"</span>;</span><br><span class="line">				fn = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="keyword">this</span>.args(), code);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.deinit();</span><br><span class="line">		<span class="keyword">return</span> fn;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 设置Hook中的_x变量</span></span><br><span class="line">	setup(instance, options) &#123;</span><br><span class="line">		instance._x = options.taps.map(<span class="function"><span class="params">t</span> =&gt;</span> t.fn);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @param &#123;&#123; type: "sync" | "promise" | "async", taps: Array&lt;Tap&gt;, interceptors: Array&lt;Interceptor&gt; &#125;&#125; options</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	init(options) &#123;</span><br><span class="line">		<span class="keyword">this</span>.options = options;</span><br><span class="line">		<span class="keyword">this</span>._args = options.args.slice();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	deinit() &#123;</span><br><span class="line">		<span class="keyword">this</span>.options = <span class="literal">undefined</span>;</span><br><span class="line">		<span class="keyword">this</span>._args = <span class="literal">undefined</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 创建函数顶部内容</span></span><br><span class="line">	header() &#123;</span><br><span class="line">		<span class="keyword">let</span> code = <span class="string">""</span>;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.needContext()) &#123;</span><br><span class="line">			code += <span class="string">"var _context = &#123;&#125;;\n"</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			code += <span class="string">"var _context;\n"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		code += <span class="string">"var _x = this._x;\n"</span>;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.options.interceptors.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			code += <span class="string">"var _taps = this.taps;\n"</span>;</span><br><span class="line">			code += <span class="string">"var _interceptors = this.interceptors;\n"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.options.interceptors.length; i++) &#123;</span><br><span class="line">			<span class="keyword">const</span> interceptor = <span class="keyword">this</span>.options.interceptors[i];</span><br><span class="line">			<span class="keyword">if</span> (interceptor.call) &#123;</span><br><span class="line">				code += <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.getInterceptor(i)&#125;</span>.call(<span class="subst">$&#123;<span class="keyword">this</span>.args(&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">					before: interceptor.context ? <span class="string">"_context"</span> : <span class="literal">undefined</span></span></span></span><br><span class="line"><span class="string"><span class="subst">				&#125;</span>)&#125;);\n`</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> code;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	needContext() &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">const</span> tap <span class="keyword">of</span> <span class="keyword">this</span>.options.taps) <span class="keyword">if</span> (tap.context) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	callTap(tapIndex, &#123; onError, onResult, onDone, rethrowIfPossible &#125;) &#123;</span><br><span class="line">		<span class="keyword">let</span> code = <span class="string">""</span>;</span><br><span class="line">		<span class="keyword">let</span> hasTapCached = <span class="literal">false</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.options.interceptors.length; i++) &#123;</span><br><span class="line">			<span class="keyword">const</span> interceptor = <span class="keyword">this</span>.options.interceptors[i];</span><br><span class="line">			<span class="keyword">if</span> (interceptor.tap) &#123;</span><br><span class="line">				<span class="keyword">if</span> (!hasTapCached) &#123;</span><br><span class="line">					code += <span class="string">`var _tap<span class="subst">$&#123;tapIndex&#125;</span> = <span class="subst">$&#123;<span class="keyword">this</span>.getTap(tapIndex)&#125;</span>;\n`</span>;</span><br><span class="line">					hasTapCached = <span class="literal">true</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				code += <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.getInterceptor(i)&#125;</span>.tap(<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">					interceptor.context ? <span class="string">"_context, "</span> : <span class="string">""</span></span></span></span><br><span class="line"><span class="string"><span class="subst">				&#125;</span>_tap<span class="subst">$&#123;tapIndex&#125;</span>);\n`</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		code += <span class="string">`var _fn<span class="subst">$&#123;tapIndex&#125;</span> = <span class="subst">$&#123;<span class="keyword">this</span>.getTapFn(tapIndex)&#125;</span>;\n`</span>;</span><br><span class="line">		<span class="keyword">const</span> tap = <span class="keyword">this</span>.options.taps[tapIndex];</span><br><span class="line">		<span class="keyword">switch</span> (tap.type) &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">"sync"</span>:</span><br><span class="line">				<span class="keyword">if</span> (!rethrowIfPossible) &#123;</span><br><span class="line">					code += <span class="string">`var _hasError<span class="subst">$&#123;tapIndex&#125;</span> = false;\n`</span>;</span><br><span class="line">					code += <span class="string">"try &#123;\n"</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (onResult) &#123;</span><br><span class="line">					code += <span class="string">`var _result<span class="subst">$&#123;tapIndex&#125;</span> = _fn<span class="subst">$&#123;tapIndex&#125;</span>(<span class="subst">$&#123;<span class="keyword">this</span>.args(&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">						before: tap.context ? <span class="string">"_context"</span> : <span class="literal">undefined</span></span></span></span><br><span class="line"><span class="string"><span class="subst">					&#125;</span>)&#125;);\n`</span>;</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					code += <span class="string">`_fn<span class="subst">$&#123;tapIndex&#125;</span>(<span class="subst">$&#123;<span class="keyword">this</span>.args(&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">						before: tap.context ? <span class="string">"_context"</span> : <span class="literal">undefined</span></span></span></span><br><span class="line"><span class="string"><span class="subst">					&#125;</span>)&#125;);\n`</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (!rethrowIfPossible) &#123;</span><br><span class="line">					code += <span class="string">"&#125; catch(_err) &#123;\n"</span>;</span><br><span class="line">					code += <span class="string">`_hasError<span class="subst">$&#123;tapIndex&#125;</span> = true;\n`</span>;</span><br><span class="line">					code += onError(<span class="string">"_err"</span>);</span><br><span class="line">					code += <span class="string">"&#125;\n"</span>;</span><br><span class="line">					code += <span class="string">`if(!_hasError<span class="subst">$&#123;tapIndex&#125;</span>) &#123;\n`</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (onResult) &#123;</span><br><span class="line">					code += onResult(<span class="string">`_result<span class="subst">$&#123;tapIndex&#125;</span>`</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (onDone &amp;&amp; onDone()) &#123;</span><br><span class="line">					code += onDone();</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (!rethrowIfPossible) &#123;</span><br><span class="line">					code += <span class="string">"&#125;\n"</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">"async"</span>:</span><br><span class="line">				<span class="keyword">let</span> cbCode = <span class="string">""</span>;</span><br><span class="line">				<span class="keyword">if</span> (onResult) cbCode += <span class="string">`(_err<span class="subst">$&#123;tapIndex&#125;</span>, _result<span class="subst">$&#123;tapIndex&#125;</span>) =&gt; &#123;\n`</span>;</span><br><span class="line">				<span class="keyword">else</span> cbCode += <span class="string">`_err<span class="subst">$&#123;tapIndex&#125;</span> =&gt; &#123;\n`</span>;</span><br><span class="line">				cbCode += <span class="string">`if(_err<span class="subst">$&#123;tapIndex&#125;</span>) &#123;\n`</span>;</span><br><span class="line">				cbCode += onError(<span class="string">`_err<span class="subst">$&#123;tapIndex&#125;</span>`</span>);</span><br><span class="line">				cbCode += <span class="string">"&#125; else &#123;\n"</span>;</span><br><span class="line">				<span class="keyword">if</span> (onResult) &#123;</span><br><span class="line">					cbCode += onResult(<span class="string">`_result<span class="subst">$&#123;tapIndex&#125;</span>`</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (onDone) &#123;</span><br><span class="line">					cbCode += onDone();</span><br><span class="line">				&#125;</span><br><span class="line">				cbCode += <span class="string">"&#125;\n"</span>;</span><br><span class="line">				cbCode += <span class="string">"&#125;"</span>;</span><br><span class="line">				code += <span class="string">`_fn<span class="subst">$&#123;tapIndex&#125;</span>(<span class="subst">$&#123;<span class="keyword">this</span>.args(&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">					before: tap.context ? <span class="string">"_context"</span> : <span class="literal">undefined</span>,</span></span></span><br><span class="line"><span class="string"><span class="subst">					after: cbCode</span></span></span><br><span class="line"><span class="string"><span class="subst">				&#125;</span>)&#125;);\n`</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">"promise"</span>:</span><br><span class="line">				code += <span class="string">`var _hasResult<span class="subst">$&#123;tapIndex&#125;</span> = false;\n`</span>;</span><br><span class="line">				code += <span class="string">`var _promise<span class="subst">$&#123;tapIndex&#125;</span> = _fn<span class="subst">$&#123;tapIndex&#125;</span>(<span class="subst">$&#123;<span class="keyword">this</span>.args(&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">					before: tap.context ? <span class="string">"_context"</span> : <span class="literal">undefined</span></span></span></span><br><span class="line"><span class="string"><span class="subst">				&#125;</span>)&#125;);\n`</span>;</span><br><span class="line">				code += <span class="string">`if (!_promise<span class="subst">$&#123;tapIndex&#125;</span> || !_promise<span class="subst">$&#123;tapIndex&#125;</span>.then)\n`</span>;</span><br><span class="line">				code += <span class="string">`  throw new Error('Tap function (tapPromise) did not return promise (returned ' + _promise<span class="subst">$&#123;tapIndex&#125;</span> + ')');\n`</span>;</span><br><span class="line">				code += <span class="string">`_promise<span class="subst">$&#123;tapIndex&#125;</span>.then(_result<span class="subst">$&#123;tapIndex&#125;</span> =&gt; &#123;\n`</span>;</span><br><span class="line">				code += <span class="string">`_hasResult<span class="subst">$&#123;tapIndex&#125;</span> = true;\n`</span>;</span><br><span class="line">				<span class="keyword">if</span> (onResult) &#123;</span><br><span class="line">					code += onResult(<span class="string">`_result<span class="subst">$&#123;tapIndex&#125;</span>`</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (onDone) &#123;</span><br><span class="line">					code += onDone();</span><br><span class="line">				&#125;</span><br><span class="line">				code += <span class="string">`&#125;, _err<span class="subst">$&#123;tapIndex&#125;</span> =&gt; &#123;\n`</span>;</span><br><span class="line">				code += <span class="string">`if(_hasResult<span class="subst">$&#123;tapIndex&#125;</span>) throw _err<span class="subst">$&#123;tapIndex&#125;</span>;\n`</span>;</span><br><span class="line">				code += onError(<span class="string">`_err<span class="subst">$&#123;tapIndex&#125;</span>`</span>);</span><br><span class="line">				code += <span class="string">"&#125;);\n"</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> code;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 创建call函数内容</span></span><br><span class="line">	callTapsSeries(&#123; onError, onResult, onDone, rethrowIfPossible &#125;) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.options.taps.length === <span class="number">0</span>) <span class="keyword">return</span> onDone();</span><br><span class="line">		<span class="keyword">const</span> firstAsync = <span class="keyword">this</span>.options.taps.findIndex(<span class="function"><span class="params">t</span> =&gt;</span> t.type !== <span class="string">"sync"</span>);</span><br><span class="line">		<span class="keyword">const</span> next = <span class="function"><span class="params">i</span> =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (i &gt;= <span class="keyword">this</span>.options.taps.length) &#123;</span><br><span class="line">				<span class="keyword">return</span> onDone();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">const</span> done = <span class="function"><span class="params">()</span> =&gt;</span> next(i + <span class="number">1</span>);</span><br><span class="line">			<span class="keyword">const</span> doneBreak = <span class="function"><span class="params">skipDone</span> =&gt;</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> (skipDone) <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">				<span class="keyword">return</span> onDone();</span><br><span class="line">			&#125;;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.callTap(i, &#123;</span><br><span class="line">				onError: <span class="function"><span class="params">error</span> =&gt;</span> onError(i, error, done, doneBreak),</span><br><span class="line">				onResult:</span><br><span class="line">					onResult &amp;&amp;</span><br><span class="line">					(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">						<span class="keyword">return</span> onResult(i, result, done, doneBreak);</span><br><span class="line">					&#125;),</span><br><span class="line">				onDone:</span><br><span class="line">					!onResult &amp;&amp;</span><br><span class="line">					(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">						<span class="keyword">return</span> done();</span><br><span class="line">					&#125;),</span><br><span class="line">				rethrowIfPossible:</span><br><span class="line">					rethrowIfPossible &amp;&amp; (firstAsync &lt; <span class="number">0</span> || i &lt; firstAsync)</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="keyword">return</span> next(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	args(&#123; before, after &#125; = &#123;&#125;) &#123;</span><br><span class="line">		<span class="keyword">let</span> allArgs = <span class="keyword">this</span>._args;</span><br><span class="line">		<span class="keyword">if</span> (before) allArgs = [before].concat(allArgs);</span><br><span class="line">		<span class="keyword">if</span> (after) allArgs = allArgs.concat(after);</span><br><span class="line">		<span class="keyword">if</span> (allArgs.length === <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> allArgs.join(<span class="string">", "</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	getTapFn(idx) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">`_x[<span class="subst">$&#123;idx&#125;</span>]`</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	getTap(idx) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">`_taps[<span class="subst">$&#123;idx&#125;</span>]`</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	getInterceptor(idx) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">`_interceptors[<span class="subst">$&#123;idx&#125;</span>]`</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = HookCodeFactory;</span><br></pre></td></tr></table></figure>

<p>核心内容都在这里，剩下的方法基本都大同小异，具体的代码细节并没有仔细去看，毕竟是别人写的，就好像你通过答案接触题目一样，感觉时间成本太高，所以仅仅是简单了解一下。<br>有一点很重要，比如SyncHook和SyncLoopHook这两种方法，他们的区别仅仅就是产出的函数内容不一样，前者是直接获取钩子函数然后调用，后者是一个do-while循环调用钩子函数，可想而知剩余的方法的区别也是方法内体，也就是说你需要更多的关注content方法的onResult这个参数</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/memory/2021/05/09/treeShaking/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FoxDaxian">
      <meta itemprop="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
      <meta itemprop="image" content="/memory/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fox的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/memory/2021/05/09/treeShaking/" class="post-title-link" itemprop="url">什么是tree shaking，它是怎样工作的？</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-05-09 23:37:00" itemprop="dateCreated datePublished" datetime="2021-05-09T23:37:00+00:00">2021-05-09</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/memory/categories/原理简析（翻译）/" itemprop="url" rel="index"><span itemprop="name">原理简析（翻译）</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>当javascript应用体积越来越大时，一个有利于减少体积的办法是拆分为不同的模块，伴随着模块化的产生，我们也可以进一步的移除多余的代码，比如那些虽然被应用，但是没有被实际用到的代码。tree shaking就是上述说法的一种实现，它通过去除所有引入但是并没有实际用到的代码来优化我们的最终打包结果的体积。</p>
<p>比如说，我们有一个工具文件，其中包含一些方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// math.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"add"</span>);</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">minus</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"minus"</span>);</span><br><span class="line">    <span class="keyword">return</span> a - b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">multiply</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"multiply"</span>);</span><br><span class="line">    <span class="keyword">return</span> a * b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">divide</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"divide"</span>);</span><br><span class="line">    <span class="keyword">return</span> a / b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在我们的应用入口文件中，我们仅仅引入其中某一个方法，比如 <code>add</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; add &#125; <span class="keyword">from</span> <span class="string">"./math"</span>;</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>假设我们使用webpack进行打包，下面是结果，我们仍然可以看到所有的方法，虽然我们仅仅想引入<code>add</code>方法</p>
<p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190924192611.png" alt></p>
<p>不过，一旦我们开启 <code>tree shaking</code>，就只有我们引入的<code>add</code>方法会出现在bundle中</p>
<p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190929145145.png" alt></p>
<hr>
<h3 id="tree-shaking的原理"><a href="#tree-shaking的原理" class="headerlink" title="tree shaking的原理"></a>tree shaking的原理</h3><p>尽管90年代就有了tree shaking的概念，但是对于前段来说，tree shaking真正可以使用是在引入 <code>es6-module</code> 后。因为tree shaking 仅仅能分析静态语法。<br>在 es6 modules 之前，我们有commonjs规范，可以通过<code>require()</code>语法引入，但是，require是动态的，意味着我们可以在if - else 中使用它。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myDynamicModule;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (condition) &#123;</span><br><span class="line">    myDynamicModule = <span class="built_in">require</span>(<span class="string">"foo"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    myDynamicModule = <span class="built_in">require</span>(<span class="string">"bar"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的是commonjs模块的语法，不过tree shaking无法使用，因为在程序运行之前无法判断哪个模块会被实际应用。也就是说语法分析不能识别。</p>
<p>es6引入了新的完全静态的语法，使用<code>import</code>发育，不在支持动态引入。(后来引入了的<code>import()</code>，返回promise，还是支持动态引入的.)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// not work</span></span><br><span class="line"><span class="keyword">if</span> (condition) &#123;</span><br><span class="line">    <span class="keyword">import</span> foo <span class="keyword">from</span> <span class="string">"foo"</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">import</span> bar <span class="keyword">from</span> <span class="string">"bar"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相反，我们只能定义所有的引入在if - else之外的全局环境内，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> foo <span class="keyword">from</span> <span class="string">"foo"</span>;</span><br><span class="line"><span class="keyword">import</span> bar <span class="keyword">from</span> <span class="string">"bar"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (condition) &#123;</span><br><span class="line">    <span class="comment">// do stuff with foo</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// do stuff with bar</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了其他的改进好处，新的语法有效的支持了tree shaking，任何代码不需要运行就可以通过语法解析判断出是否真正呗用到，以便进一步减少打包后的体积</p>
<h3 id="tree-shaking-甩掉了什么"><a href="#tree-shaking-甩掉了什么" class="headerlink" title="tree shaking 甩掉了什么"></a>tree shaking 甩掉了什么</h3><p>webpack中的tree shaking，尽可能的甩掉了所有未使用到的代码，例如，引入了但是没有实际应用的代码会被消除。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; add, multiply &#125; <span class="keyword">from</span> <span class="string">"./mathUtils"</span>;</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>上面的代码，multiply因为被实际应用，所以会被消除</p>
<p>即使对象上有定义的属性，但是如果没有被访问，也会被移除</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// myInfo.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> myInfo = &#123;</span><br><span class="line">    name: <span class="string">"Ire Aderinokun"</span>,</span><br><span class="line">    birthday: <span class="string">"2 March"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; myInfo &#125; <span class="keyword">from</span> <span class="string">"./myInfo.js"</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(myInfo.name);</span><br></pre></td></tr></table></figure>

<p>before: </p>
<p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190929151539.jpg" alt></p>
<p>after:</p>
<p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190929151547.png" alt></p>
<p>不过 tree shaking 并不能消除所有的代码，因为 tree shaking 只会处理方法和变量，看下面的例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// myClass.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">MyClass.prototype.saySome = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125; <span class="comment">// 副作用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 扩展数据的方法</span></span><br><span class="line"><span class="built_in">Array</span>.prototype.unique = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> MyClass</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> MyClass <span class="keyword">from</span> <span class="string">'./myClass'</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'index'</span>);</span><br></pre></td></tr></table></figure>

<p>这个时候就不会消除类文件myClass，因为会触发getter、setter，而getter、setter是不透明的，可能会有副作用<br><a href="https://zhuanlan.zhihu.com/p/32831172" target="_blank" rel="noopener">详情参考</a></p>
<p><a href="https://rollupjs.cn/repl?version=0.53.3&shareable=JTdCJTIybW9kdWxlcyUyMiUzQSU1QiU3QiUyMm5hbWUlMjIlM0ElMjJtYWluLmpzJTIyJTJDJTIyY29kZSUyMiUzQSUyMmltcG9ydCUyME15Q2xhc3MlMjBmcm9tJTIwJy4lMkZ0ZXN0JyUzQiU1Q24lNUNuY29uc29sZS5sb2coMTIzKSUyMiU3RCUyQyU3QiUyMm5hbWUlMjIlM0ElMjJjb21wb25lbnRzLmpzJTIyJTJDJTIyY29kZSUyMiUzQSUyMmV4cG9ydCUyMGNsYXNzJTIwUGVyc29uJTIwJTdCJTVDbiUyMCUyMGNvbnN0cnVjdG9yJTIwKCU3QiUyMG5hbWUlMkMlMjBhZ2UlMkMlMjBzZXglMjAlN0QpJTIwJTdCJTVDbiUyMCUyMCUyMCUyMHRoaXMuY2xhc3NOYW1lJTIwJTNEJTIwJ1BlcnNvbiclNUNuJTIwJTIwJTIwJTIwdGhpcy5uYW1lJTIwJTNEJTIwbmFtZSU1Q24lMjAlMjAlMjAlMjB0aGlzLmFnZSUyMCUzRCUyMGFnZSU1Q24lMjAlMjAlMjAlMjB0aGlzLnNleCUyMCUzRCUyMHNleCU1Q24lMjAlMjAlN0QlNUNuJTIwJTIwZ2V0TmFtZSUyMCgpJTIwJTdCJTVDbiUyMCUyMCUyMCUyMHJldHVybiUyMHRoaXMubmFtZSU1Q24lMjAlMjAlN0QlNUNuJTdEJTVDbmV4cG9ydCUyMGNsYXNzJTIwQXBwbGUlMjAlN0IlNUNuJTIwJTIwY29uc3RydWN0b3IlMjAoJTdCJTIwbW9kZWwlMjAlN0QpJTIwJTdCJTVDbiUyMCUyMCUyMCUyMHRoaXMuY2xhc3NOYW1lJTIwJTNEJTIwJ0FwcGxlJyU1Q24lMjAlMjAlMjAlMjB0aGlzLm1vZGVsJTIwJTNEJTIwbW9kZWwlNUNuJTIwJTIwJTdEJTVDbiUyMCUyMGdldE1vZGVsJTIwKCklMjAlN0IlNUNuJTIwJTIwJTIwJTIwcmV0dXJuJTIwdGhpcy5tb2RlbCU1Q24lMjAlMjAlN0QlNUNuJTdEJTIyJTdEJTJDJTdCJTIybmFtZSUyMiUzQSUyMnRlc3QuanMlMjIlMkMlMjJjb2RlJTIyJTNBJTIyJTVDbmV4cG9ydCUyMGNsYXNzJTIwTXlDbGFzcyUyMCU3QiU3RCU1Q24lNUNuTXlDbGFzcy5wcm90b3R5cGUuc2F5U29tZSUyMCUzRCUyMGZ1bmN0aW9uJTIwKCklMjAlN0IlN0QlNUNuJTVDbkFycmF5LnByb3RvdHlwZS51bmlxdWUlMjAlM0QlMjBmdW5jdGlvbiUyMCgpJTIwJTdCJTdEJTVDbiU1Q24lMjIlN0QlNUQlMkMlMjJvcHRpb25zJTIyJTNBJTdCJTIyZm9ybWF0JTIyJTNBJTIydW1kJTIyJTJDJTIybW9kdWxlTmFtZSUyMiUzQSUyMm15QnVuZGxlJTIyJTJDJTIyZ2xvYmFscyUyMiUzQSU3QiU3RCUyQyUyMm5hbWUlMjIlM0ElMjJteUJ1bmRsZSUyMiUyQyUyMmFtZCUyMiUzQSU3QiUyMmlkJTIyJTNBJTIyJTIyJTdEJTdEJTJDJTIyZXhhbXBsZSUyMiUzQW51bGwlN0Q=" target="_blank" rel="noopener">rollup在线转换</a></p>
<p>也许你会说我们能判断是否是原生方法，进而进行排除，其实不然，我们可以这样</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="string">'a'</span>;</span><br><span class="line">a += <span class="string">'rr'</span>;</span><br><span class="line">a += <span class="string">'ay'</span>;</span><br></pre></td></tr></table></figure>

<p>一句话就是，因为js本身是动态语言，所以情况太多，处理起来会有风险，tree shaking 的本意是优化，而不是影响，所以不是所有的代码都可以tree shaking</p>
<h3 id="关于-‘side-effects’"><a href="#关于-‘side-effects’" class="headerlink" title="关于 ‘side effects’"></a>关于 ‘side effects’</h3><p>中文直译：副作用<br>什么是副作用：对当前包意外产生任意影响就是副作用</p>
<p>一个典型的具有副作用的形式是 pollfills，因为它在window上增加了各种宿主环境不支持的最新方法，所以不能添加side effects</p>
<h3 id="如何tree-shake"><a href="#如何tree-shake" class="headerlink" title="如何tree shake"></a>如何tree shake</h3><p>webpack目前支持通过设置mode来开启，比如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    ...,</span><br><span class="line">    mode: <span class="string">"production"</span>,</span><br><span class="line">    ...,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>webpack老版本依赖uglifyjs</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/memory/2021/05/09/vfFont/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FoxDaxian">
      <meta itemprop="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
      <meta itemprop="image" content="/memory/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fox的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/memory/2021/05/09/vfFont/" class="post-title-link" itemprop="url">variable fonts - 更小更灵活的字体</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-05-09 23:37:00" itemprop="dateCreated datePublished" datetime="2021-05-09T23:37:00+00:00">2021-05-09</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/memory/categories/原理/" itemprop="url" rel="index"><span itemprop="name">原理</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="原文链接"><a href="#原文链接" class="headerlink" title="原文链接"></a><a href="https://github.com/FoxDaxian/memory/issues/4" target="_blank" rel="noopener">原文链接</a></h2><p>variable fonts（下文中vf为缩写）是数字时代制作的字体技术，用更小的文件大小在web上提供更丰富的排版，但是一项新的技术往往伴随着新的挑战和复杂未知的情况。不过，我们要拥抱技术，那么怎么才能使用它呢？</p>
<p>让我们从以下几个问题去学习一下variable fonts。</p>
<ul>
<li><a href="#part_one">什么是variable fonts?</a></li>
<li><a href="#part_two">variable fonts能做什么</a></li>
<li><a href="#part_three">拉伸或者扭曲字体会不会有不好的效果和影响？</a></li>
<li><a href="#part_four">variable fonts有哪些优点？</a></li>
<li><a href="#part_five">怎么在web上使用variable fonts？</a></li>
<li><a href="#part_six">有哪些潜在的缺陷需要注意？</a></li>
<li><a href="#part_seven">variable fonts何时才会相对成熟？</a></li>
</ul>
<h3 id="什么是variable-fonts"><a href="#什么是variable-fonts" class="headerlink" title="什么是variable fonts?"></a><a id="part_one">什么是variable fonts?</a></h3><p>有人解释它为一个存在多种字体格式单字体文件。一般来说，字体的不同格式，比如斜体、粗细、拉伸存储在分开的单个文件内，而现在，你可以存储多种字体格式在一个openType可变字体文件内，正因为如此，这个vf文件相对来说体积会更小。</p>
<p><img src="https://foxdaxian.github.io/assets/02_variableFonts/static-font-files-vs-variable-font-files.png" alt="资源"></p>
<p align="center">多个静态字体文件可以被存储到一个vf文件</p>

<p>因为只有一种排版的<code>轮廓点</code>，所以文件体积很小。这些点决定了文字的直接表现。修改<code>轮廓点</code>的位置意味着能够动态的在浏览器里改变文字的样子。这使得在半粗体和粗体之间的转换成为可能。向下面这样：</p>
<p><img src="https://foxdaxian.github.io/assets/02_variableFonts/variable-fonts-interpolation.gif" alt="资源"></p>
<p align="center">修改vf字体的例子，这些`轮廓点`的数量没有变化，仅仅是位置发生了改变</p>

<p>在各种<code>轴(将一个可修改范围抽象化为一条(x)轴，或者说横坐标)</code>上可以以非常小的数值进行改变，比如<code>粗细轴</code>，一点点的修改就会发生很大的风格变化，像<code>regular</code>和<code>font-weight: 700</code>之间有其他的值可以进行指定。</p>
<p><img src="https://foxdaxian.github.io/assets/02_variableFonts/variable-fonts-named-instances-along-weight-axis.png" alt="资源"></p>
<p>一个vf字体可以有很多类似的<code>轴</code>，比如增加一个<code>身高轴</code>，就能延伸出更多风格的字体。也可以想想成为一个有x和y的坐标轴，当x轴的可修改范围为50，y轴的可修改范围为500的时候，你就会得到25000中不同风格的字体，并且文件大小也很可观。</p>
<p><img src="https://foxdaxian.github.io/assets/02_variableFonts/variable-fonts-venn-weight-axis-width-axis.png" alt="资源"></p>
<p align="center">各种各样的字体</p>



<h3 id="variable-fonts能做什么？"><a href="#variable-fonts能做什么？" class="headerlink" title="variable fonts能做什么？"></a><a id="part_two">variable fonts能做什么？</a></h3><p>这个得根据字体的设计来决定，字体的设计提供了各种各种可以被修改的<code>轴</code>，比如粗细，长短以及任何合理范畴之内的。下面提供五个常用的<code>保留轴</code>:</p>
<ul>
<li>wdth: 用于修改字的宽窄</li>
<li>wght: 用于修改字的粗细</li>
<li>ital: 是否倾斜，0为非倾斜，1为斜体</li>
<li>slnt: 用于修改字的倾斜程度</li>
<li>opsz: 对于字形的修改(待确认)</li>
</ul>
<p>尽管宽窄、粗细是更为常见的<code>供修改轴</code>，但是也有一些<code>自定义轴</code>，比如<code>衬线(衬线是字的笔画开始和结束部分的额外装饰)轴</code>等。</p>
<p><img src="https://foxdaxian.github.io/assets/02_variableFonts/variable-fonts-weight-width-slant-axis-morphing.gif" alt="资源"></p>
<p align="center">通过改变`轴`生成的动画，有没有很酷炫？</p>

<h3 id="拉伸或者扭曲字体会不会有不好的效果和影响？"><a href="#拉伸或者扭曲字体会不会有不好的效果和影响？" class="headerlink" title="拉伸或者扭曲字体会不会有不好的效果和影响？"></a><a id="part_three">拉伸或者扭曲字体会不会有不好的效果和影响？</a></h3><p>当vf字体改变宽窄、粗细或者其他维度的时候，不会造成不好的影响。但是如果换做<code>transform: scaleX(0.5)</code>，就会发生不好的影响，因为它直接修改了字体的设计，设计师看了会打人。</p>
<p>为什么拉伸或者扭曲字体是一个很严重的问题？因为字体设计师在每个字符的协调上下了很多心血，所以这样的字体符合正常的审美。而草率的拉伸或者扭曲字体会导致设计师的心血功亏一篑。即使修改之后的不同是很微小的，但是也会影响字体整体的外观和感觉。</p>
<p><img src="https://foxdaxian.github.io/assets/02_variableFonts/variable-font-vs-distorted-stretched-font.png" alt="资源"></p>
<p align="center">仔细看上面这张图中的字母O，下面的O已经超出蓝色范围，而上面的依旧保持的很好。吐槽，本人没觉得有啥美感的丢失</p>

<h3 id="variable-fonts有哪些优点？"><a href="#variable-fonts有哪些优点？" class="headerlink" title="variable fonts有哪些优点？"></a><a id="part_four">variable fonts有哪些优点？</a></h3><h5 id="最明显的优点，或许你已经想到了，就是提供丰富的自定义web字体"><a href="#最明显的优点，或许你已经想到了，就是提供丰富的自定义web字体" class="headerlink" title="最明显的优点，或许你已经想到了，就是提供丰富的自定义web字体"></a>最明显的优点，或许你已经想到了，就是提供丰富的自定义web字体</h5><p>网站开发者可以利用不同风格的字体去突出某些部分的趣味性和重要性，网站可以以编辑设计的方式处理更多的排版，提供更丰富的视觉展示和个性化方案。我创建了一个<a href="https://zeichenschatz.net/demos/vf/variable-web-typo/" target="_blank" rel="noopener">测试网站</a>，在这个网站上，我限制颜色风格，换句话说，我仅仅用了4中左右的颜色来表现网站的层次感，然后用了多大18中的字体去丰富网站。在我看来，这样比减少样式风格更加简介和独特。你可以点击右下角按钮来切换不同的字体主题，获得不同的体验。</p>
<p><img src="https://foxdaxian.github.io/assets/02_variableFonts/variable-fonts-on-the-web-demo-page-its-time-for-variable-web-typography.jpg" alt="资源"></p>
<p align="center">一个使用字体变换改变网站风格的测试网站</p>

<h4 id="更小的文件体积"><a href="#更小的文件体积" class="headerlink" title="更小的文件体积"></a>更小的文件体积</h4><p>vf字体用更小的文件带来更多的可选风格。比如你想使用三四种不同粗细的字体，你可以用vf字体来获得更小文件体积的收益。举个例子：<a href="https://sz-magazin.sueddeutsche.de/" target="_blank" rel="noopener">Süddeutsche Zeitung Magazin</a><br>该网站的字体加起来一共有236kb大小，其中四中不同粗细的字体加起来共166kb，如果换用vf字体，可以较少到80kb，<strong>足足减少了50%！</strong></p>
<p><img src="https://foxdaxian.github.io/assets/02_variableFonts/web-fonts-loaded-for-sz-magazin-sueddeutsche-de.jpg" alt="资源"></p>
<p align="center">如果使用vf字体，至少可以节约一半的带宽</p>

<h4 id="细颗粒度的控制"><a href="#细颗粒度的控制" class="headerlink" title="细颗粒度的控制"></a>细颗粒度的控制</h4><p>vf字体在如何渲染字体上提供细颗粒度的控制，你可以设置<code>font-weight:430</code>来提供更好地效果。因为这是一个可选的，所以像<code>font-weight:bold</code>这样的方式，仍然是奏效的</p>
<h4 id="更好地文字适配"><a href="#更好地文字适配" class="headerlink" title="更好地文字适配"></a>更好地文字适配</h4><p>如果vf字体提供<code>宽窄轴</code>操作能力，你可以让文字在移动设备上有更好的可读性。在宽一点的屏幕上，也能更好地利用空间。这个例子可以很清晰的展示这种效果: <a href="https://zeichenschatz.net/demos/vf/width/" target="_blank" rel="noopener">browser example</a></p>
<h4 id="与动画结合"><a href="#与动画结合" class="headerlink" title="与动画结合"></a>与动画结合</h4><p>所有<code>轴</code>都可以通过css来产生一个过渡的动画效果。这能让你的网站带来很酷和充满活力的效果。在<a href="https://developer.microsoft.com/en-us/microsoft-edge/testdrive/demos/variable-fonts/" target="_blank" rel="noopener">微软示例</a>页面中，你可以通过滚动来查看令人印象深刻的动画效果。</p>
<h4 id="一种更重视视觉美的文字"><a href="#一种更重视视觉美的文字" class="headerlink" title="一种更重视视觉美的文字"></a>一种更重视视觉美的文字</h4><p>这个概念来自印刷技术，通常指在小字号的时候更加可读，大字号的时候更加富有个性。在金属活字时期(使用金属作为载体的活字印刷术)，只能通过修改的文字尺寸来进行优化。后来，通过数字化技术，你可以设计一个适配所有尺寸的字体。现在相同的情况随着vf字体的出现得以解决。例如，小字号的时候笔画可以更粗一点，这意味着更低的对比度使可读性更高。另一方面，当大字号的情况下，空间更多，所以有更多的操纵性，和对比度。类似的变化在vf字体中可以在单一文件内逐渐产生。<br><img src="https://foxdaxian.github.io/assets/02_variableFonts/variable-font-optical-size-voto-serif-variable.png" alt="资源"></p>
<h3 id="怎么在web上使用variable-fonts？"><a href="#怎么在web上使用variable-fonts？" class="headerlink" title="怎么在web上使用variable fonts？"></a><a id="part_five">怎么在web上使用variable fonts？</a></h3><ol>
<li><p>找到可用的vf字体<br> 这个技术还是非常积极地，所以，如果你想使用它，你首先要找到相关资源。这有一个<a href="http://v-fonts.com/" target="_blank" rel="noopener">资源</a>可以供你使用，在这个网站里你能尝试很多vf字体，很多都是在github开源，并且可以直接下载的。<a href="https://docs.google.com/spreadsheets/d/1ycxOqpcPA9NmCWcNbmxiY-KHEh820MucI1eO6QkKLOE/htmlview#gid=0" target="_blank" rel="noopener">这也有一些很不错的资源</a></p>
</li>
<li><p>整合到你的网站中的样式表内<br> 2018上半年，超过一般的浏览器已经<a href="https://caniuse.com/#search=variable%20fonts" target="_blank" rel="noopener">支持</a>的很好了。</p>
<p> 通过<code>@font-face</code>引入到页面内：</p>
 <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">font-face</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: <span class="string">'VennVF'</span>;</span><br><span class="line">    <span class="attribute">src</span>: <span class="built_in">url</span>(<span class="string">'VennVF_W.woff2'</span>) <span class="built_in">format</span>(<span class="string">'woff2-variations'</span>),</span><br><span class="line">        <span class="built_in">url</span>(<span class="string">'VennVF_W.woff2'</span>) <span class="built_in">format</span>(<span class="string">'woff2'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 找到字体可变<code>轴</code>和可变范围，根据设计的不同的vf都有不同的<code>轴</code>和不同的范围，如果你不知道vf字体能做什么改变，你可以使用<a href="https://wakamaifondue.com/" target="_blank" rel="noopener">在线工具</a>，他也可以帮你生成现成的css。<br> 然后我们进行css的开发，不过在这之前，先说一下即将在css4字体模块中增加的可以设置vf字体的<code>高级属性</code>：</p>
<ul>
<li><p><code>font-weight</code>：可以设置1-999的任意数值</p>
</li>
<li><p><code>font-stretch</code>：是一个百分比的值，100%是正常的，50%是紧缩的，200%是拉伸的，其对应的关键字应该可以使用，这对印刷来说是可怕的，因为它不能拉伸字体，拉伸字体会导致不好的结果，但是vf的改变是在涉及范围内的拉伸，是可以接受的。</p>
</li>
<li><p><code>font-style</code>：一个倾斜的属性，从-90deg到90deg，当然关键字也是可以使用。90deg看起来是奇怪的，8deg是大部分字体中采用的最大值。</p>
</li>
<li><p><code>font-optical-sizing</code>：这是一个新的属性，有两个可选属性<code>auto</code>和<code>none</code>。一般来说，浏览器会设置为auto，但你也可以设置为none</p>
<p>不是所有vf字体都能控制上面的属性，这得根据字体的设计和可用范围来决定。我做了一些测试，safari支持<code>font-weight</code>和<code>font-stretch</code>，并且，如果optical可用，它会自动打开optical sizing。但是使用<code>font-style: italic</code>的结果是，没有更新vf字体的italic<code>轴</code>范围。</p>
<p>只有在sarari上，这些高级属性兼容的还可以。所以，如果想保证稳定性，你需要使用一个低级的属性：<code>font-variation-settings</code>，你可以设置四部分，其实和上面的差不多。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">p</span> &#123;</span><br><span class="line">	<span class="attribute">font-family</span>: <span class="string">"VennVF"</span>;</span><br><span class="line">	<span class="attribute">font-variation-settings</span>: <span class="string">"wght"</span> <span class="number">550</span>, <span class="string">"wdth"</span> <span class="number">125</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码改变字体粗细为550，还有宽窄为125。在不远的将来，你或许可以使用高级属性来得到同样的效果：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">p</span> &#123;</span><br><span class="line">	<span class="attribute">font-family</span>: <span class="string">"VennVF"</span>;</span><br><span class="line">	<span class="attribute">font-weight</span>: <span class="number">550</span>;</span><br><span class="line">	<span class="attribute">font-stretch</span>: <span class="number">125%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然，vf字体其实还有更多的自定义<code>轴</code>可以使用，都可以使用<code>font-variation-setting</code>属性来设置：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">h1</span> &#123;</span><br><span class="line">	<span class="attribute">font-family</span>: <span class="string">'VennVF'</span>, sans-serif;</span><br><span class="line">	<span class="attribute">font-variation-settings</span>: <span class="string">"TRMC"</span> <span class="number">0</span>, <span class="string">"SKLA"</span> <span class="number">0</span>, <span class="string">"SKLB"</span> <span class="number">0</span>, <span class="string">"TRME"</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果看起来像这样：</p>
<p><img src="https://foxdaxian.github.io/assets/02_variableFonts/variable-font-decovar-coustom-axis-morphing.gif" alt="资源"></p>
</li>
</ul>
</li>
<li><p>兼容不支持vf字体的浏览器</p>
<p> 如果你现在就想使用vf字体的话，在不支持的版本上，网站风格会和你想象中的完全不一样，所以我们需要一个回退方案，这个利用的css的特性查询功能：</p>
 <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">supports</span> (font-variation-settings: normar)&#123;</span><br><span class="line">	<span class="comment">/* set some property */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <a href="https://caniuse.com/#feat=css-featurequeries" target="_blank" rel="noopener">点击查看@supports的各浏览器兼容</a>，个人认为兼容还是可以的。<br> 然后，像下面这样设置vf，就可以适配大部分浏览器了：</p>
 <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">	<span class="attribute">font-family</span>: <span class="string">'Venn'</span>, sans-serif;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="keyword">supports</span> (font-variation-settings: normal) &#123;</span><br><span class="line">	<span class="selector-tag">body</span> &#123;</span><br><span class="line">		<span class="attribute">font-family</span>: <span class="string">'VennVF'</span>, sans-serif;</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 解释一下：首先上面的body为正常的字体，下面为积极地做法，如果支持<code>font-variation-settings</code>，那么就采取vf字体，然后可以设置一些具体的字体细节。否则会静默失败。<br> 可能有人会用:not来配合@supports，有时候匹配成功不是因为not，而是因为@supports不支持，所以尽量避免。</p>
</li>
</ol>
<h3 id="有哪些潜在的缺陷需要注意？"><a href="#有哪些潜在的缺陷需要注意？" class="headerlink" title="有哪些潜在的缺陷需要注意？"></a><a id="part_six">有哪些潜在的缺陷需要注意？</a></h3><p>vf字体为web字体带来了新的活力和发灰控件，但是，一项新的技术往往会伴随着很多我们需要注意的问题。</p>
<ul>
<li>太多的选项</li>
<li>更多的与web无关的字体只是需要学习</li>
<li>vf字体不一定总会对性能有所提高</li>
<li>你也许仍然需要多个字体文件以适配某些字体，比如罗马字体和斜体</li>
<li>可能会因为著作权、许可证而造成其他问题</li>
</ul>
<h3 id="variable-fonts何时才会相对成熟？"><a href="#variable-fonts何时才会相对成熟？" class="headerlink" title="variable fonts何时才会相对成熟？"></a><a id="part_seven">variable fonts何时才会相对成熟？</a></h3><p>2018年大部分浏览器都已经支持了，很快移动设备也会支持，因为vf会节约很大的带宽。我期待2019年vf字体能够替换静态字体被用在各个web站点中。adobe和谷歌会在推动这项技术中一定会占主要部分，因为他们同样需要减少字体文件大小，虽然不知道这件事什么时候会发生。但是一定会很快。<br>我对文件大小没有太大的兴趣，我更多的兴趣实在使用更少的样色主题和更多的字体去设置网站的风格，像这个<a href="https://zeichenschatz.net/demos/vf/variable-web-typo/" target="_blank" rel="noopener">网站</a>。</p>
<h5 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h5><ul>
<li><a href="https://www.zeichenschatz.net/typografie/implementing-a-variable-font-with-fallback-web-fonts.html" target="_blank" rel="noopener">更好地方案去使用vf字体</a></li>
<li><a href="https://www.zeichenschatz.net/typografie/how-to-start-with-variable-fonts-on-the-web.html" target="_blank" rel="noopener">vf字体详细说明</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/35822169" target="_blank" rel="noopener">可变字体</a></li>
<li><a href="https://thetype.com/page/8/?s=%E5%AD%97%E4%BD%93" target="_blank" rel="noopener">字体历史</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/memory/2021/05/09/vue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FoxDaxian">
      <meta itemprop="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
      <meta itemprop="image" content="/memory/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fox的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/memory/2021/05/09/vue/" class="post-title-link" itemprop="url">vue简析</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-05-09 23:37:00" itemprop="dateCreated datePublished" datetime="2021-05-09T23:37:00+00:00">2021-05-09</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/memory/categories/原理/" itemprop="url" rel="index"><span itemprop="name">原理</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h3><p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190703224933.png" alt></p>
<h3 id="响应式分析"><a href="#响应式分析" class="headerlink" title="响应式分析"></a>响应式分析</h3><p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190703224948.png" alt></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/memory/2021/05/09/webComponent/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FoxDaxian">
      <meta itemprop="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
      <meta itemprop="image" content="/memory/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fox的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/memory/2021/05/09/webComponent/" class="post-title-link" itemprop="url">web component</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-05-09 23:37:00" itemprop="dateCreated datePublished" datetime="2021-05-09T23:37:00+00:00">2021-05-09</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/memory/categories/原理/" itemprop="url" rel="index"><span itemprop="name">原理</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">my-btn</span> <span class="attr">click-fnname</span>=<span class="string">"whenClick"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">slot</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"text"</span>&gt;</span>123<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">my-btn</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">template</span> <span class="attr">class</span>=<span class="string">"template"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">            <span class="comment">/* 指代当前宿主 */</span></span></span><br><span class="line"><span class="css">            <span class="selector-pseudo">:host</span> &#123;</span></span><br><span class="line">                display: block;</span><br><span class="line">                width: 100px;</span><br><span class="line">                height: 40px;</span><br><span class="line"><span class="css">                <span class="selector-tag">border</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-tag">rgba</span>(0, 0, 0, <span class="selector-class">.4</span>);</span></span><br><span class="line">                border-radius: 10px;</span><br><span class="line">                text-align: center;</span><br><span class="line">                line-height: 40px;</span><br><span class="line">                cursor: pointer;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">            <span class="selector-pseudo">:host(</span><span class="selector-pseudo">:hover)</span> &#123;</span></span><br><span class="line">                border-color: blue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">            <span class="selector-class">.slotBox</span> &#123;</span></span><br><span class="line">                color: red;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"slotBox"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">slot</span> <span class="attr">name</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">".slotText"</span>&gt;</span>默认的slot展示<span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> config = &#123;</span></span><br><span class="line"><span class="javascript">            <span class="comment">// ...</span></span></span><br><span class="line">            funcs: &#123;</span><br><span class="line">                whenClick() &#123;</span><br><span class="line"><span class="javascript">                    <span class="built_in">console</span>.log(<span class="string">'我被点击了'</span>);</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="javascript">            <span class="comment">// ...</span></span></span><br><span class="line">        &#125;;</span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> customTemplate = (<span class="function"><span class="keyword">function</span> (<span class="params">config</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">HTMLElement</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 监听可以更新的属性</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">static</span> <span class="keyword">get</span> observedAttributes() &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">return</span> [<span class="string">'click-fnname'</span>];</span></span><br><span class="line">                &#125;</span><br><span class="line"><span class="javascript">                <span class="keyword">constructor</span>() &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">super</span>();</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">this</span>._clickFnname = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                        <span class="built_in">console</span>.log(<span class="string">'默认点击事件'</span>);</span></span><br><span class="line">                    &#125;</span><br><span class="line"><span class="javascript">                    <span class="comment">// this 就是当前这个自定义的标签</span></span></span><br><span class="line"><span class="javascript">                    <span class="keyword">this</span>.template = <span class="built_in">document</span>.querySelector(<span class="string">'.template'</span>);</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">this</span>.shadow = <span class="keyword">this</span>.attachShadow(&#123;</span></span><br><span class="line"><span class="javascript">                        mode: <span class="string">'open'</span></span></span><br><span class="line">                    &#125;)</span><br><span class="line"><span class="javascript">                    <span class="comment">// 添加template到shadow dom</span></span></span><br><span class="line"><span class="javascript">                    <span class="keyword">this</span>.shadow.appendChild(<span class="built_in">document</span>.importNode(<span class="keyword">this</span>.template.content, <span class="literal">true</span>))</span></span><br><span class="line">                &#125;</span><br><span class="line"><span class="javascript">                <span class="comment">// 当被添加的时候会被触发</span></span></span><br><span class="line">                connectedCallback() &#123;</span><br><span class="line"><span class="javascript">                    <span class="built_in">console</span>.log(<span class="string">'调用了'</span>);</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">this</span>.addEventListener(<span class="string">'click'</span>, <span class="keyword">this</span>._clickFnname)</span></span><br><span class="line">                &#125;</span><br><span class="line"><span class="javascript">                <span class="comment">// 接绑的时候调用</span></span></span><br><span class="line">                disconnectedCallback() &#123;</span><br><span class="line"><span class="javascript">                    <span class="built_in">console</span>.log(<span class="string">'disconnectedCallback'</span>);</span></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"><span class="javascript">                <span class="comment">// 自定义标签属性改变时触发</span></span></span><br><span class="line">                attributeChangedCallback(name, oldValue, newValue) &#123;</span><br><span class="line"><span class="javascript">                    <span class="keyword">switch</span> (name) &#123;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">case</span> <span class="string">'click-fnname'</span>:</span></span><br><span class="line"><span class="javascript">                            <span class="comment">// 获取全局下的事件</span></span></span><br><span class="line"><span class="javascript">                            <span class="keyword">this</span>._clickFnname = config.funcs[newValue];</span></span><br><span class="line"><span class="javascript">                            <span class="keyword">break</span>;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">default</span>:</span></span><br><span class="line"><span class="javascript">                            <span class="keyword">break</span>;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)(config);</span><br><span class="line"><span class="javascript">        customElements.define(<span class="string">'my-btn'</span>, customTemplate);</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>参考链接: <a href="https://hacks.mozilla.org/2018/11/the-power-of-web-components/" target="_blank" rel="noopener">英文</a> | <a href="https://www.zcfy.cc/article/an-introduction-to-custom-elements-dev-community" target="_blank" rel="noopener">中文</a> | <a href="https://github.com/mdn/web-components-examples" target="_blank" rel="noopener">一些例子</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/memory/2021/05/09/webp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FoxDaxian">
      <meta itemprop="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
      <meta itemprop="image" content="/memory/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fox的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/memory/2021/05/09/webp/" class="post-title-link" itemprop="url">webp</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-05-09 23:37:00" itemprop="dateCreated datePublished" datetime="2021-05-09T23:37:00+00:00">2021-05-09</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/memory/categories/原理/" itemprop="url" rel="index"><span itemprop="name">原理</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>2010年，谷歌发布了一种新的图片格式：<a href="https://developers.google.com/speed/webp/" target="_blank" rel="noopener">WebP</a>，它是可以当初png和jpg的一种替代格式，在不损失图片质量的前提下，会尽可能的减少文件大小.</p>
<h4 id="WebP有哪些优点呢？"><a href="#WebP有哪些优点呢？" class="headerlink" title="WebP有哪些优点呢？"></a>WebP有哪些优点呢？</h4><p>由于WebP提供的性能和优点，它简直完美。不像其他屙屎，WebP有无损和有损两个压缩方式，还支持动画和透明度</p>
<table>
<thead>
<tr>
<th></th>
<th>WebP</th>
<th>png</th>
<th>jpg</th>
<th>gif</th>
</tr>
</thead>
<tbody><tr>
<td>Lossy compression</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>x</td>
</tr>
<tr>
<td>Lossless compression</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>Transparency</td>
<td>√</td>
<td>√</td>
<td>x</td>
<td>√</td>
</tr>
<tr>
<td>Animation</td>
<td>√</td>
<td>x</td>
<td>x</td>
<td>√</td>
</tr>
</tbody></table>
<p>即使有这么多的优点，webp依然提供比其他格式更小的文件大小，在<a href="https://developers.google.com/speed/webp/docs/c_study#results" target="_blank" rel="noopener">这个测试中</a>，web有损图片比jpg格式要小30%，无损图片要比png格式小25。</p>
<h4 id="怎么转换到webp格式呢"><a href="#怎么转换到webp格式呢" class="headerlink" title="怎么转换到webp格式呢"></a>怎么转换到webp格式呢</h4><ol>
<li><p>在线工具</p>
<ol>
<li><a href="https://squoosh.app/" target="_blank" rel="noopener">squoosh</a></li>
<li><a href="https://image.online-convert.com/convert-to-webp" target="_blank" rel="noopener">online-convert.com</a></li>
</ol>
</li>
<li><p>命令行工具<br> <a href="https://www.npmjs.com/package/cwebp" target="_blank" rel="noopener">cwebp</a>是一个不错的工具，可以转换图片到webp格式</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cwebp -q [图片大小] [输入] -o [输出]</span></span><br><span class="line">cwebp -q <span class="number">75</span> image.png -o image.webp</span><br></pre></td></tr></table></figure>
</li>
<li><p>node工具<br> <a href="https://github.com/imagemin/imagemin" target="_blank" rel="noopener">imagemin</a>，还有它的插件<a href="https://github.com/imagemin/imagemin-webp" target="_blank" rel="noopener">imagemin-webp</a>，是一个转换图片到webp格式的工具<br> 下面这个例子将所有的png和jpg图片转成webp</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* convert-to-webp.js */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> imagemin = <span class="built_in">require</span>(<span class="string">"imagemin"</span>);</span><br><span class="line"><span class="keyword">const</span> webp = <span class="built_in">require</span>(<span class="string">"imagemin-webp"</span>);</span><br><span class="line"></span><br><span class="line">imagemin([<span class="string">"*.png"</span>, <span class="string">"*.jpg"</span>], <span class="string">"images"</span>, &#123;</span><br><span class="line">  use: [</span><br><span class="line">    webp(&#123; <span class="attr">quality</span>: <span class="number">75</span>&#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>sketch<br> 可以使用sketch导出webp格式的图片</p>
</li>
</ol>
<h4 id="当下环境如何在开发中使用webp格式呢"><a href="#当下环境如何在开发中使用webp格式呢" class="headerlink" title="当下环境如何在开发中使用webp格式呢"></a>当下环境如何在开发中使用webp格式呢</h4><p>可以先查看一下webp的<a href="https://caniuse.com/#search=webp" target="_blank" rel="noopener">兼容性</a><br>可以看到，当今各端支持率已高达70%多，虽然webp有这么多的有点，但是也不能直接使用，而不提供一种向后兼容的方式，否则在不支持的浏览器中，用户体验会很差。<br>我们可以使用HTML5中的<picture>元素，该标签允许为单张图片提供多个源。想下面这样</picture></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;picture&gt;</span><br><span class="line">    &lt;source type=<span class="string">"image/webp"</span> srcset=<span class="string">"image.webp"</span>&gt;</span><br><span class="line">    &lt;source type=<span class="string">"image/jpeg"</span> srcset=<span class="string">"image.jpg"</span>&gt;</span><br><span class="line">    &lt;img src=<span class="string">"image.jpg"</span> alt=<span class="string">"My Image"</span>&gt;</span><br><span class="line">&lt;<span class="regexp">/picture&gt;</span></span><br></pre></td></tr></table></figure>

<p>source标签作为不同的源，img标签作为当浏览器不支持时的一种回退方案，当前<picture>支持率高达85%以上</picture></p>
<p>除了html的办法，当然还有其他方案，比如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> isSupportWebp = !![].map &amp;&amp; <span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>).toDataURL(<span class="string">'image/webp'</span>).indexOf(<span class="string">'data:image/webp'</span>) == <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(isSupportWebp);</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.isSupportWebp = <span class="literal">false</span>;<span class="comment">//是否支持</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> img = <span class="keyword">new</span> Image(); </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getResult</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//如果进入加载且图片宽度为1(通过图片宽度值判断图片是否可以显示)</span></span><br><span class="line">        <span class="built_in">window</span>.isSupportWebp = event &amp;&amp; event.type === <span class="string">'load'</span> ? img.width == <span class="number">1</span> : <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    img.onerror = getResult;</span><br><span class="line">    img.onload = getResult;</span><br><span class="line">    <span class="comment">// 如果可以在那么则支持</span></span><br><span class="line">    img.src = <span class="string">'data:image/webp;base64,UklGRiQAAABXRUJQVlA4IBgAAAAwAQCdASoBAAEAAwA0JaQAA3AA/vuUAAA='</span>;</span><br></pre></td></tr></table></figure>

<p><a href="https://developers.google.com/speed/webp/" target="_blank" rel="noopener">webp官网</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/memory/2021/05/09/wxminiPrograme/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FoxDaxian">
      <meta itemprop="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
      <meta itemprop="image" content="/memory/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fox的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/memory/2021/05/09/wxminiPrograme/" class="post-title-link" itemprop="url">微信小程序简析</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-05-09 23:37:00" itemprop="dateCreated datePublished" datetime="2021-05-09T23:37:00+00:00">2021-05-09</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/memory/categories/原理/" itemprop="url" rel="index"><span itemprop="name">原理</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h4><p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/11_wx/naotu.png" alt="demo"></p>
<h4 id="优化点："><a href="#优化点：" class="headerlink" title="优化点："></a>优化点：</h4><p>最直接的方式的控制小程序的大小，比如制定代码规范和通用组件的控制<br>分包： 包括分包、分包预加载、独立分包<br>某些请求进行前置，比如某些量级很小的数据、用户必定会点击的页面的数据预请求<br>利用微信提供的缓存 storage<br>避免白屏，将一些静态或极少更新的状态传递给下一页，并结合骨架图进行页面的框架展示<br>控制setdata的使用次数和传达数据大小，建议一定少于64kb<br>减少WXML中非必须节点的使用<br>合理使用onpagescroll</p>
<h4 id="分包介绍"><a href="#分包介绍" class="headerlink" title="分包介绍"></a>分包介绍</h4><p>本质上是按需加载，分为主包和分包，主包会运行app等公共方法和加载一些公共资源。当进入某个分包页面的时候，才会按需下载并执行展示出来。</p>
<p>目前小程序所有分包大小不超过8M</p>
<p>单个分包/主包不能超过2M</p>
<h4 id="主要应用"><a href="#主要应用" class="headerlink" title="主要应用"></a>主要应用</h4><p>小程序首次启动的下载和加载时间大大缩短</p>
<h4 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h4><p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/11_wx/demo.png" alt="demo"></p>
<h4 id="参数解释："><a href="#参数解释：" class="headerlink" title="参数解释："></a>参数解释：</h4><p>pages：主包</p>
<p>subpackages：分包</p>
<p>root：分包根目录 → 分包所在的目录<br>name：分包别名 →  预下载的时候可以引用该别名，方便<br>pages：相对于root的分包路径，可包含多个<br>preloadRule：开启分包预下载，key - value形式，key代表某个页面，比如上图中的index主页面，当进入该页面的时候，需要预下载哪些分包</p>
<p>packages：需要下载的分包，数组形式<br>network：可以指定只有在某些网络下才会下载，默认是wifi</p>
<p>关于独立分包：独立分支只需要在subpackages中的添加 independent: true 即可，注意不要依赖主包和其他分包的内容，可能无法获取全局数据，因为主包可能未加载，不过可以在独立主包中定义一个全局数据，等加载主要的时候会与主包和全局数据进行合并，</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/memory/2019/08/09/babelOut/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FoxDaxian">
      <meta itemprop="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
      <meta itemprop="image" content="/memory/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fox的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/memory/2019/08/09/babelOut/" class="post-title-link" itemprop="url">分析babel的输出</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-08-09 12:00:00" itemprop="dateCreated datePublished" datetime="2019-08-09T12:00:00+00:00">2019-08-09</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2021-05-09 23:37:00" itemprop="dateModified" datetime="2021-05-09T23:37:00+00:00">2021-05-09</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/memory/categories/解析/" itemprop="url" rel="index"><span itemprop="name">解析</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">  (<span class="function"><span class="keyword">function</span>(<span class="params">modules</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 缓存对象</span></span><br><span class="line">    <span class="keyword">var</span> installedModules = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// require方法</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__webpack_require__</span>(<span class="params">moduleId</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 是否命中缓存</span></span><br><span class="line">        <span class="keyword">if</span> (installedModules[moduleId]) &#123;</span><br><span class="line">            <span class="keyword">return</span> installedModules[moduleId].exports;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 新建 + 缓存</span></span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">module</span> = (installedModules[moduleId] = &#123;</span><br><span class="line">            i: moduleId,</span><br><span class="line">            l: <span class="literal">false</span>,</span><br><span class="line">            exports: &#123;&#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行module方法</span></span><br><span class="line">        modules[moduleId].call(</span><br><span class="line">            <span class="built_in">module</span>.exports,</span><br><span class="line">            <span class="built_in">module</span>,</span><br><span class="line">            <span class="built_in">module</span>.exports,</span><br><span class="line">            __webpack_require__</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 标志是否已加载模块，之后缓存里会走</span></span><br><span class="line">        <span class="built_in">module</span>.l = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">module</span>.exports;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// expose the modules object (__webpack_modules__)</span></span><br><span class="line">    __webpack_require__.m = modules;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// expose the module cache</span></span><br><span class="line">    __webpack_require__.c = installedModules;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置commonjs导出的对象上的a的值</span></span><br><span class="line">    __webpack_require__.d = <span class="function"><span class="keyword">function</span>(<span class="params">exports, name, getter</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!__webpack_require__._hasOwnProperty(exports, name)) &#123;</span><br><span class="line">            <span class="comment">// 利用 getter 可以通过a获取到module的值</span></span><br><span class="line">            <span class="built_in">Object</span>.defineProperty(exports, name, &#123;</span><br><span class="line">                enumerable: <span class="literal">true</span>,</span><br><span class="line">                <span class="keyword">get</span>: getter</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    // 定义 __esModule 标志</span><br><span class="line">    __webpack_require__.r = function(exports) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">Symbol</span> !== <span class="string">'undefined'</span> &amp;&amp; <span class="built_in">Symbol</span>.toStringTag) &#123;</span><br><span class="line">            <span class="built_in">Object</span>.defineProperty(exports, <span class="built_in">Symbol</span>.toStringTag, &#123;</span><br><span class="line">                value: <span class="string">'Module'</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">Object</span>.defineProperty(exports, <span class="string">'__esModule'</span>, &#123;<span class="attr">value</span>: <span class="literal">true</span>&#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 适配commonjs规范</span></span><br><span class="line">    <span class="comment">// 导出的为 require.a =&gt; 执行 getter函数 获得导出的内容</span></span><br><span class="line">    __webpack_require__.n = <span class="function"><span class="keyword">function</span>(<span class="params">module</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> getter =</span><br><span class="line">            <span class="built_in">module</span> &amp;&amp; <span class="built_in">module</span>.__esModule</span><br><span class="line">                ? <span class="function"><span class="keyword">function</span> <span class="title">getDefault</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                      <span class="keyword">return</span> <span class="built_in">module</span>[<span class="string">'default'</span>];</span><br><span class="line">                  &#125;</span><br><span class="line">                : <span class="function"><span class="keyword">function</span> <span class="title">getModuleExports</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                      <span class="keyword">return</span> <span class="built_in">module</span>;</span><br><span class="line">                  &#125;;</span><br><span class="line">        __webpack_require__.d(getter, <span class="string">'a'</span>, getter);</span><br><span class="line">        <span class="keyword">return</span> getter;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Object.prototype.hasOwnProperty.call</span></span><br><span class="line">    __webpack_require__._hasOwnProperty = <span class="function"><span class="keyword">function</span>(<span class="params">object, property</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Object</span>.prototype.hasOwnProperty.call(object, property);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)(&#123;&#125;)</span><br></pre></td></tr></table></figure>

<p>概述下上面打包后的代码，是一个立即执行函数，接受的参数是一个对象，对象的key为引入的模块路径，对应的value为导出的内容，不过babel会根据ejs or cjs来进行不同的适配导出。<br>iife函数内为：</p>
<ol>
<li>installedModules 闭包环境缓存模块对象</li>
<li><strong>webpack_require</strong> 变种的require方法</li>
<li><strong>webpack_require</strong>.d 适配commonjs的转换方法</li>
<li><strong>webpack_require</strong>.r 给babel转换的es6模块增加标志，也就是通过该方法来设置区分ejs 和 cjs的标志</li>
<li><em>_webpack_require</em>.n 根据 __esModule 导出</li>
</ol>
<p>举例说明:</p>
<p>我们有以下几个文件，内容都很简单。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// es6.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    type: <span class="string">'esjs'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// commonjs.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    type: <span class="string">'commonjs'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">import</span> es6 <span class="keyword">from</span> <span class="string">'./es6'</span>;</span><br><span class="line"><span class="keyword">import</span> conmon <span class="keyword">from</span> <span class="string">'./commonjs'</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">require</span>(<span class="string">'./es6'</span>));</span><br><span class="line"><span class="built_in">console</span>.log(es6, <span class="string">'import来的'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">require</span>(<span class="string">'./commonjs'</span>));</span><br><span class="line"><span class="built_in">console</span>.log(conmon, <span class="string">'import来的'</span>);</span><br></pre></td></tr></table></figure>

<p>通过webpack打包后的输出内容我们只取上面iife函数的参数部分，并去掉eval来提升可读性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bundle.js</span></span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">modules</span>)</span>&#123;</span><br><span class="line"><span class="comment">// ******</span></span><br><span class="line"><span class="comment">// 巴拉巴拉</span></span><br><span class="line"><span class="comment">// ******</span></span><br><span class="line">    <span class="comment">// Load entry module and return exports</span></span><br><span class="line">    <span class="keyword">return</span> __webpack_require__((__webpack_require__.s = <span class="string">'./index.js'</span>));</span><br><span class="line">&#125;)(&#123;</span><br><span class="line">    <span class="string">'./commonjs.js'</span>: <span class="function"><span class="keyword">function</span>(<span class="params">module, exports</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">module</span>.exports = &#123;<span class="attr">type</span>: <span class="string">'commonjs'</span>&#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'./es6.js'</span>: <span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>&#123;</span><br><span class="line">        __webpack_require__.r(__webpack_exports__);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 相当于 module.exports.default，这就是为什么我们require的时候，需要加上 .default</span></span><br><span class="line">        __webpack_exports__[<span class="string">'default'</span>] = &#123;</span><br><span class="line">            type: <span class="string">'esjs'</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'./index.js'</span>: <span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>&#123;</span><br><span class="line">        __webpack_require__.r(__webpack_exports__);</span><br><span class="line">        <span class="keyword">var</span> es6FromImport = __webpack_require__(<span class="string">'./es6.js'</span>);</span><br><span class="line">        <span class="keyword">var</span> commonjsFromImport = __webpack_require__(</span><br><span class="line">            <span class="string">'./commonjs.js'</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">var</span> commonjsFromImport_default = __webpack_require__.n(</span><br><span class="line">            commonjsFromImport</span><br><span class="line">        );</span><br><span class="line">        <span class="built_in">console</span>.log(__webpack_require__(<span class="string">'./es6.js'</span>));</span><br><span class="line">        <span class="built_in">console</span>.log(es6FromImport[<span class="string">'default'</span>], <span class="string">'import来的'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(__webpack_require__(<span class="string">'./commonjs.js'</span>));</span><br><span class="line">        <span class="built_in">console</span>.log(</span><br><span class="line">            commonjsFromImport_default.a,</span><br><span class="line">            <span class="string">'import来的'</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>一点点分析，从入口开始 =&gt; <strong>webpack_require</strong>(‘./index.js’)<br>首先会查看是否命中缓存，如果命中，那理所当然直接返回，否则进行新建 + 缓存的操作，边边角角直接略过，咱们看下面这个方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 新建</span></span><br><span class="line"><span class="keyword">var</span> <span class="built_in">module</span> = (installedModules[moduleId] = &#123;</span><br><span class="line">    i: moduleId,</span><br><span class="line">    l: <span class="literal">false</span>,</span><br><span class="line">    exports: &#123;&#125; </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 赋值</span></span><br><span class="line">modules[moduleId].call(</span><br><span class="line">    <span class="built_in">module</span>.exports,</span><br><span class="line">    <span class="built_in">module</span>,</span><br><span class="line">    <span class="built_in">module</span>.exports,</span><br><span class="line">    __webpack_require__</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导出</span></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">module</span>.exports;</span><br></pre></td></tr></table></figure>

<p>首先新建，并创建默认的导出对象，这也就说明了为什么文件没有导出，默认是{}的问题，然后，利用call传递函数执行上下文环境，并传入module, module.exports, <strong>webpack_require</strong> 参数，最后return了module中的exports的值。</p>
<p>来看关键的赋值这一步。<br>针对es6js，因为你是export default，所以babel会增加一个__esModule变量，进行ejs的标识，因为我们导出的时候，会根据ejs规范，导出得对象赋值到default上，如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 赋值 __esModule</span></span><br><span class="line">__webpack_require__.r(__webpack_exports__);</span><br><span class="line">__webpack_exports__[<span class="string">'default'</span>] = &#123;</span><br><span class="line">    type: <span class="string">'esjs'</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>当我们使用ejs规范import的时候，babel会进行default的读取，所以我们可以直接获取到我们想要的值，然后如果你使用require的话，babel会按照commonjs直接进行读取，所以会导致我们需要 .default 才能拿到我们真正想要的值，结果如下</p>
<p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190809213447.png" alt></p>
<p>针对cjs，由于使用cjs规范，所以我们的导出是不涉及default的，即</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123; <span class="attr">type</span>: <span class="string">'commonjs'</span> &#125;</span><br></pre></td></tr></table></figure>

<p>其实我们直接导出即可，因为 <strong>webpack_require</strong> 的返回值就是 module.exports。<br>不过打包后的代码用 <strong>webpack_require</strong>.n 对commonjs的导出做了处理，判断是否为 es6 规范的导出，如果是那么导出default，不是直接导出module.exports，然后使用 getter 设置返回函数的a属性，获取a属性即返回cjs module的导出，猜测这是对es6 import的统一处理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// require</span></span><br><span class="line"><span class="keyword">var</span> commonjsFromImport = __webpack_require__(<span class="string">'./commonjs.js'</span>);</span><br><span class="line"><span class="comment">// 设置getter</span></span><br><span class="line"><span class="keyword">var</span> commonjsFromImport_default = __webpack_require__.n(commonjsFromImport);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(commonjsFromImport_default.a, <span class="string">'import来的'</span>);</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190809215548.png" alt></p>
<h3 id="简单总结"><a href="#简单总结" class="headerlink" title="简单总结"></a>简单总结</h3><p>require 对 ejs 规范的导出不是很友好，换句话说，考虑的很单一，所以会有default的问题<br>import 适配的 ejs 和 cjs，会根据 __esModule 进行导出的判断，返回使用者真正想要的</p>
<p>不过进步一认证，发现如果是ejs的导出，会直接导出<strong>webpack_export</strong>[‘default’]，也就是 module.export.defualt，看起来不需要处理 __esModule 的请求，暂时还不清楚到底是怎么回事。有缘窃听下回分解吧。</p>
<p>具体babel是怎么解析的，暂时不涉及，只分析结果，得出一点点结论。</p>
<h4 id="小提示"><a href="#小提示" class="headerlink" title="小提示"></a>小提示</h4><p>类似这种的代码 (0, foo.bar)() 相当于 foo.bar.call(winodw|global|this)  改变执行时的上下文环境</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/memory/2019/08/05/regReplace/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FoxDaxian">
      <meta itemprop="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
      <meta itemprop="image" content="/memory/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fox的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/memory/2019/08/05/regReplace/" class="post-title-link" itemprop="url">string.prototype.replace 特殊符号</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-08-05 12:00:00" itemprop="dateCreated datePublished" datetime="2019-08-05T12:00:00+00:00">2019-08-05</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2021-05-09 23:37:00" itemprop="dateModified" datetime="2021-05-09T23:37:00+00:00">2021-05-09</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/memory/categories/介绍/" itemprop="url" rel="index"><span itemprop="name">介绍</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>$$ =&gt; 代表 $</li>
</ol>
<p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190805193728.png" alt></p>
<ol start="2">
<li><p>$&amp; =&gt; 代表匹配的内容</p>
<p>$n =&gt; 代表正则匹配的第n个括号内的内容，意味着replace第一个参数为必须为正则</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190805194116.png" alt></p>
<ol start="3">
<li>$` =&gt; 代表匹配之前的所有内容</li>
</ol>
<p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190805194258.png" alt></p>
<ol start="4">
<li>$’ =&gt; 代表匹配之后的所有内容</li>
</ol>
<p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190805194509.png" alt></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/memory/2019/07/29/cookieless/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FoxDaxian">
      <meta itemprop="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
      <meta itemprop="image" content="/memory/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fox的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/memory/2019/07/29/cookieless/" class="post-title-link" itemprop="url">cookieless记录用户信息？</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-07-29 12:00:00" itemprop="dateCreated datePublished" datetime="2019-07-29T12:00:00+00:00">2019-07-29</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2021-05-09 23:37:00" itemprop="dateModified" datetime="2021-05-09T23:37:00+00:00">2021-05-09</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/memory/categories/畅想/" itemprop="url" rel="index"><span itemprop="name">畅想</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="cookie是什么："><a href="#cookie是什么：" class="headerlink" title="cookie是什么："></a>cookie是什么：</h4><p>cookie是由web服务器保存在用户浏览器（客户端）上的小文件，它可以包含用户信息，用户操作信息等等，无论何时访问服务器，只要同源，就能携带到服务端</p>
<h4 id="常见方式"><a href="#常见方式" class="headerlink" title="常见方式"></a>常见方式</h4><ol>
<li>一般：请求一个接口，返回是否登录，如果登录成功，服务器(set-cookie)设置cookie到浏览器，以后请求api会继续请求</li>
<li>jwt：将用户id.payload.签证进行加密，并且注入到客户端cookie，之后每次请求会在服务端解析该cookie，并获取对应的用户数据，由于存在客户端，所以解放了服务端，减少服务端压力。也可以将该cookie放到根域名下，这样就可以登录一次，遍地开花。</li>
</ol>
<h4 id="可以看到，常见的方式都是利用cookie（或者浏览器storage），这样你的信息还是会被看到，如果别人获取到你的cookie也有办法进行破解甚至直接复制登录。那么有没有办法不借用cookie来记录用户信息的？"><a href="#可以看到，常见的方式都是利用cookie（或者浏览器storage），这样你的信息还是会被看到，如果别人获取到你的cookie也有办法进行破解甚至直接复制登录。那么有没有办法不借用cookie来记录用户信息的？" class="headerlink" title="可以看到，常见的方式都是利用cookie（或者浏览器storage），这样你的信息还是会被看到，如果别人获取到你的cookie也有办法进行破解甚至直接复制登录。那么有没有办法不借用cookie来记录用户信息的？"></a>可以看到，常见的方式都是利用cookie（或者浏览器storage），这样你的信息还是会被看到，如果别人获取到你的cookie也有办法进行破解甚至直接复制登录。那么有没有办法不借用cookie来记录用户信息的？</h4><hr>
<h4 id="利用缓存存储用户信息"><a href="#利用缓存存储用户信息" class="headerlink" title="利用缓存存储用户信息"></a>利用缓存存储用户信息</h4><ol>
<li>优点：安全可靠</li>
<li>缺点：依赖服务端</li>
</ol>
<h4 id="原理概述："><a href="#原理概述：" class="headerlink" title="原理概述："></a>原理概述：</h4><p>请求一个资源，如果设置cache-control、lastmodify、etag等，会进行缓存相关的判定：</p>
<ol>
<li>cache-control：是否强缓存，如果命中直接读取浏览器缓存的上次返回内容</li>
<li>last-modify：如果未命中强缓存，进行时间的判断，如果有if-modified-since并且和last-modify那么读取缓存，否则重新拉取资源</li>
<li>etag：如果未命中强缓存，通过etag唯一标志福来判断是否需要拉取最新资源，etag一般用文件内容的hash加密后内容，如果是大文件，个人建议使用文件大小+最后修改时间作为唯一标志<br>综上所述，如果我们请求一个很小的资源文件，例如1字节的图片，服务端设置cache-control: max-age=0，跳过强缓存，服务端设置etag，保证每次都做协商缓存，然后根据etag的变化来决定是否需要拉新(记录用户信息)，如果etag没有变化，那么就读取缓存(缓存记录用户信息)</li>
</ol>
<p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190729114108.png" alt></p>
<h4 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> KoaBody = <span class="built_in">require</span>(<span class="string">'koa-body'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> glob = <span class="built_in">require</span>(<span class="string">'glob'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> baseDate = &#123;</span><br><span class="line">    visitCount: <span class="number">1</span>,</span><br><span class="line">    date: <span class="literal">undefined</span>,</span><br><span class="line">    info: <span class="string">''</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">app.use(KoaBody());</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">    <span class="comment">// 更新资源</span></span><br><span class="line">    <span class="keyword">if</span> (ctx.req.url === <span class="string">'/updateInfo'</span> &amp;&amp; ctx.req.method === <span class="string">'POST'</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">'./session.json'</span>);</span><br><span class="line">        session.info = ctx.request.body.info;</span><br><span class="line">        <span class="keyword">await</span> writeFile(<span class="string">'session.json'</span>, <span class="built_in">JSON</span>.stringify(session));</span><br><span class="line">        ctx.body = &#123;</span><br><span class="line">            code: <span class="number">1</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> imgType = glob</span><br><span class="line">        .sync(<span class="string">'*.+(jpg|png)'</span>)</span><br><span class="line">        .map(<span class="function"><span class="params">file</span> =&gt;</span> path.resolve(<span class="string">'/'</span>, file));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((fileIndex = imgType.indexOf(ctx.req.url)) !== <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> res = ctx.response;</span><br><span class="line">        <span class="keyword">const</span> req = ctx.req;</span><br><span class="line">        res.type = path.extname(imgType[fileIndex]).slice(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">const</span> filePath = path.join(<span class="string">'./'</span>, imgType[fileIndex]);</span><br><span class="line">        res.set(<span class="string">'cache-control'</span>, <span class="string">'public, max-age=0'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> session;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            session = <span class="built_in">require</span>(<span class="string">'./session.json'</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            session = &#123;...baseDate&#125;;</span><br><span class="line">            session.date = <span class="keyword">new</span> <span class="built_in">Date</span>().toLocaleString();</span><br><span class="line">            <span class="keyword">await</span> writeFile(<span class="string">'session.json'</span>, <span class="built_in">JSON</span>.stringify(session));</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// use force refresh to clear etag, because if serve set etag,</span></span><br><span class="line">            <span class="comment">// browser will carry if-none-match field in request header. and we can use if-none-match to judge somethine</span></span><br><span class="line">            <span class="comment">// etag 大文件一般用文件大小 + 修改时间 来生成，而不是读取文件内容</span></span><br><span class="line">            md5 = convertMd5(<span class="built_in">JSON</span>.stringify(session));</span><br><span class="line">            res.etag = md5;</span><br><span class="line">            <span class="keyword">if</span> (req.headers[<span class="string">'if-none-match'</span>]) &#123;</span><br><span class="line">                <span class="comment">// console.log('缓存');</span></span><br><span class="line">                session.visitCount = +session.visitCount + <span class="number">1</span>;</span><br><span class="line">                session.date = <span class="keyword">new</span> <span class="built_in">Date</span>().toLocaleString();</span><br><span class="line">                <span class="keyword">await</span> writeFile(<span class="string">'./session.json'</span>, <span class="built_in">JSON</span>.stringify(session));</span><br><span class="line">                res.status = <span class="number">304</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// console.log('清除缓存');</span></span><br><span class="line">                session.visitCount = <span class="number">1</span>;</span><br><span class="line">                session.date = <span class="keyword">new</span> <span class="built_in">Date</span>().toLocaleString();</span><br><span class="line">                session.info = <span class="string">''</span>;</span><br><span class="line">                <span class="keyword">await</span> writeFile(<span class="string">'./session.json'</span>, <span class="built_in">JSON</span>.stringify(session));</span><br><span class="line">                ctx.body = fs.createReadStream(filePath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<h4 id="运行demo"><a href="#运行demo" class="headerlink" title="运行demo"></a>运行demo</h4><p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190729114709.gif" alt></p>
<p>有问题欢迎交流</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/memory/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/memory/">1</a><span class="space">&hellip;</span><a class="page-number" href="/memory/page/3/">3</a><span class="page-number current">4</span>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">FoxDaxian</p>
              <div class="site-description motion-element" itemprop="description">遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/memory/archives/">
                
                    <span class="site-state-item-count">40</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">categories</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">FoxDaxian</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.2.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/memory/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/memory/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/memory/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/memory/js/utils.js?v=7.2.0"></script>

  <script src="/memory/js/motion.js?v=7.2.0"></script>



  
  


  <script src="/memory/js/schemes/muse.js?v=7.2.0"></script>



  

  


  <script src="/memory/js/next-boot.js?v=7.2.0"></script>


  

  

  

  



  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
