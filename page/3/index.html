<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">






















<link rel="stylesheet" href="/memory/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/memory/css/main.css?v=7.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/memory/images/apple-touch-icon-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/memory/images/favicon-32x32-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/memory/images/favicon-16x16-next.png?v=7.2.0">


  <link rel="mask-icon" href="/memory/images/logo.svg?v=7.2.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/memory/',
    scheme: 'Muse',
    version: '7.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
<meta name="keywords" content="博客 分享">
<meta property="og:type" content="website">
<meta property="og:title" content="fox的博客">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="fox的博客">
<meta property="og:description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="fox的博客">
<meta name="twitter:description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">





  
  
  <link rel="canonical" href="http://yoursite.com/page/3/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>fox的博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/memory/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">fox的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">github地址 -> https://github.com/FoxDaxian</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
      
    

    

    <a href="/memory/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/memory/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/memory/2021/05/09/ast/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FoxDaxian">
      <meta itemprop="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
      <meta itemprop="image" content="/memory/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fox的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/memory/2021/05/09/ast/" class="post-title-link" itemprop="url">js <=> ast</=></a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-05-09 23:37:00" itemprop="dateCreated datePublished" datetime="2021-05-09T23:37:00+00:00">2021-05-09</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/memory/categories/原理/" itemprop="url" rel="index"><span itemprop="name">原理</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>语言一般分为编译型语言和解释性语言</p>
<ul>
<li>编译型语言：先编译在执行，例如做好饭在吃<br>大致步骤为：词法分析 -&gt; 语法分析 -&gt; 语义检查 -&gt; 代码优化和字节码生成</li>
<li>解释性语言：涮火锅<br>大致步骤为：词法分析 -&gt; 语法分析 -&gt; 语法树，然后直接解释执行了</li>
</ul>
<hr>
<p>加深理解，学习了一下用js写一个解析器，转换成ast抽象结构树，在写编译器转换成汇编语言的过程。<br>包括下面几个功能：</p>
<ul>
<li>解析</li>
<li>汇编代码生成</li>
<li>系统调用</li>
</ul>
<h4 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h4><p>解析函数应该返回ast，一个代表输入的数据结构，比如我们想要<figure class="highlight plain"><figcaption><span>1 (+ 2 3))```转换成```['+', 1 ['+', 2, 3]]```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">```javascript</span><br><span class="line">module.exports.parse = function parse(program) &#123;</span><br><span class="line">    const tokens = [];</span><br><span class="line">    let currentToken = &apos;&apos;;</span><br><span class="line"></span><br><span class="line">    for (let i = 0; i &lt; program.length; i++) &#123;</span><br><span class="line">        const char = program.charAt(i);</span><br><span class="line"></span><br><span class="line">        switch (char) &#123;</span><br><span class="line">            case &apos;(&apos;:</span><br><span class="line">                // 递归</span><br><span class="line">                const [parsed, rest] = parse(program.substring(i + 1));</span><br><span class="line">                // 把已经解析好的塞入数组中</span><br><span class="line">                tokens.push(parsed);</span><br><span class="line">                // 置空剩余参数，因为递归</span><br><span class="line">                program = rest;</span><br><span class="line">                i = 0;</span><br><span class="line">                break;</span><br><span class="line">            case &apos;)&apos;:</span><br><span class="line">                // 去掉多余的右括号</span><br><span class="line">                tokens.push(+currentToken || currentToken);</span><br><span class="line">                // return 直接阻止函数继续运行，直接返回</span><br><span class="line">                return [tokens, program.substring(i + 1)];</span><br><span class="line">                break;</span><br><span class="line">            case &apos; &apos;:</span><br><span class="line">                // 遇到空格则全部塞入tokens</span><br><span class="line">                tokens.push(+currentToken || currentToken);</span><br><span class="line">                currentToken = &apos;&apos;;</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                currentToken += char;</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // 如果第二个参数不为&apos;&apos;，这解析过程有误</span><br><span class="line">    return [tokens, &apos;&apos;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>简单测试：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">JSON</span>.stringify(parse(<span class="string">'(- 2 (+ 4 5))'</span>), <span class="literal">null</span>, <span class="number">0</span>) <span class="comment">// [[["-",2,["+",4,5]]],""]</span></span><br></pre></td></tr></table></figure>

<h4 id="汇编相关"><a href="#汇编相关" class="headerlink" title="汇编相关"></a>汇编相关</h4><p>汇编使我们能使用的最低级的编程语言，是兼顾可读性和1:1对应相应二进制的，cpu可直接解释的语言。<br>可使用<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">汇编主要的数据结构是寄存器(cpu存储的临时变量)和程序堆栈。程序中的每个函数都会访问相同的寄存器，但是也有一些更实用更耐用的寄存器，比如```RAX```、```RDI```等等。</span><br><span class="line">来了解一下我们会用到的一些汇编功能：</span><br><span class="line">- MOV：移动寄存器内容到另外一个，或者存储字面量到寄存器中</span><br><span class="line">- ADD：合并两个寄存器的内容到第一个寄存器</span><br><span class="line">- PUSH：将寄存器中的内容放置到堆栈中</span><br><span class="line">- POP：移除堆栈里最顶层的内容，并存储到寄存器中</span><br><span class="line">- CALL：访问堆栈中的一部分，并且开始执行</span><br><span class="line">- RET：访问并调用一个堆栈并返回调用之后的下一个指令的评估</span><br><span class="line">- SYSCALL：和call差不多，不过有```kernel```处理</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### 汇编代码生成</span><br><span class="line"></span><br><span class="line">话不多说，上代码</span><br><span class="line">```javascript</span><br><span class="line">// 代码转换部分</span><br><span class="line">function emit(depth, code) &#123;</span><br><span class="line">    const indent = new Array(depth + 1).map(() =&gt; &apos;&apos;).join(&apos;  &apos;);</span><br><span class="line">    console.log(indent + code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function compile_argument(arg, destination) &#123;</span><br><span class="line">    // 如果是数组，则递归</span><br><span class="line">    if (Array.isArray(arg)) &#123;</span><br><span class="line">        compile_call(arg[0], arg.slice(1), destination);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 否则直接存储代码</span><br><span class="line">    emit(1, `MOV $&#123;destination&#125;, $&#123;arg&#125;`);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const BUILTIN_FUNCTIONS = &#123; &apos;+&apos;: &apos;plus&apos; &#125;;</span><br><span class="line">const PARAM_REGISTERS = [&apos;RDI&apos;, &apos;RSI&apos;, &apos;RDX&apos;];</span><br><span class="line"></span><br><span class="line">function compile_call(fun, args, destination) &#123;</span><br><span class="line">	// 入栈</span><br><span class="line">    args.forEach((_, i) =&gt; emit(1, `PUSH $&#123;PARAM_REGISTERS[i]&#125;`));</span><br><span class="line">	// 递归</span><br><span class="line">    args.forEach((arg, i) =&gt; compile_argument(arg, PARAM_REGISTERS[i]));</span><br><span class="line">	// 执行部分</span><br><span class="line">    emit(1, `CALL $&#123;BUILTIN_FUNCTIONS[fun] || fun&#125;`);</span><br><span class="line">	// 出栈</span><br><span class="line">    args.forEach((_, i) =&gt; emit(1, `POP $&#123;PARAM_REGISTERS[args.length - i - 1]&#125;`));</span><br><span class="line">	// 如果提供，这转移到相应的寄存器</span><br><span class="line">    if (destination) &#123;</span><br><span class="line">        emit(1, `MOV $&#123;destination&#125;, RAX`);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    emit(0, &apos;&apos;); // 优化格式</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function emit_prefix() &#123;</span><br><span class="line">	// 常规前缀</span><br><span class="line">    emit(1, &apos;.global _main\n&apos;);</span><br><span class="line"></span><br><span class="line">    emit(1, &apos;.text\n&apos;);</span><br><span class="line"></span><br><span class="line">    emit(0, &apos;plus:&apos;);</span><br><span class="line">    emit(1, &apos;ADD RDI, RSI&apos;);</span><br><span class="line">    emit(1, &apos;MOV RAX, RDI&apos;);</span><br><span class="line">    emit(1, &apos;RET\n&apos;);</span><br><span class="line"></span><br><span class="line">    emit(0, &apos;_main:&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const os = require(&apos;os&apos;);</span><br><span class="line"></span><br><span class="line">const SYSCALL_MAP = os.platform() === &apos;darwin&apos; ? &#123;</span><br><span class="line">    &apos;exit&apos;: &apos;0x2000001&apos;,</span><br><span class="line">&#125; : &#123;</span><br><span class="line">    &apos;exit&apos;: 60,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">function emit_postfix() &#123;</span><br><span class="line">	// 常规后缀</span><br><span class="line">	emit(1, &apos;MOV RDI, RAX&apos;); // Set exit arg</span><br><span class="line">	emit(1, `MOV RAX, $&#123;SYSCALL_MAP[&apos;exit&apos;]&#125;`); // Set syscall number</span><br><span class="line">	emit(1, &apos;SYSCALL&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module.exports.compile = function parse(ast) &#123;</span><br><span class="line">    emit_prefix();</span><br><span class="line">    compile_call(ast[0], ast.slice(1));</span><br><span class="line">    emit_postfix();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>简单测试：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">node ulisp.js <span class="string">'(+ 3 (+ 2 1))'</span></span><br><span class="line">  .global _main</span><br><span class="line"></span><br><span class="line">  .text</span><br><span class="line"></span><br><span class="line">plus:</span><br><span class="line">  ADD RDI, RSI</span><br><span class="line">  MOV RAX, RDI</span><br><span class="line">  RET</span><br><span class="line"></span><br><span class="line">_main:</span><br><span class="line">  PUSH RDI</span><br><span class="line">  PUSH RSI</span><br><span class="line">  MOV RDI, <span class="number">3</span></span><br><span class="line">  PUSH RDI</span><br><span class="line">  PUSH RSI</span><br><span class="line">  MOV RDI, <span class="number">2</span></span><br><span class="line">  MOV RSI, <span class="number">1</span></span><br><span class="line">  CALL plus</span><br><span class="line">  POP RSI</span><br><span class="line">  POP RDI</span><br><span class="line">  MOV RSI, RAX</span><br><span class="line"></span><br><span class="line">  CALL plus</span><br><span class="line">  POP RSI</span><br><span class="line">  POP RDI</span><br><span class="line"></span><br><span class="line">  MOV RDI, RAX</span><br><span class="line">  MOV RAX, <span class="number">0x2000001</span></span><br><span class="line">  SYSCALL</span><br></pre></td></tr></table></figure>

<h4 id="整合并调用"><a href="#整合并调用" class="headerlink" title="整合并调用"></a>整合并调用</h4><p>我们可以将生成的汇编代码输出到文件中，并使用gcc进行调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ node ulisp.js <span class="string">'(+ 3 (+ 2 1))'</span> &gt; program.S</span><br><span class="line">$ gcc -mstackrealign -masm=intel -o program program.s</span><br><span class="line">$ ./program</span><br><span class="line">$ echo $?</span><br><span class="line"><span class="number">6</span></span><br></pre></td></tr></table></figure>

<hr>
<p>大概就是这样，中的来说可以对编译语言有一个浅显的理解，或许日后会用到<br><a href="http://notes.eatonphil.com/compiler-basics-lisp-to-assembly.html" target="_blank" rel="noopener">参考链接</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/memory/2021/05/09/qps&tps/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FoxDaxian">
      <meta itemprop="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
      <meta itemprop="image" content="/memory/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fox的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/memory/2021/05/09/qps&tps/" class="post-title-link" itemprop="url">qps和tps</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-05-09 23:37:00" itemprop="dateCreated datePublished" datetime="2021-05-09T23:37:00+00:00">2021-05-09</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/memory/categories/原理/" itemprop="url" rel="index"><span itemprop="name">原理</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="几个概念"><a href="#几个概念" class="headerlink" title="几个概念"></a>几个概念</h3><ul>
<li>吞吐率(RPS)<br>  计算公式: 吞吐率 = 总请求数 / 处理这些请求的总完成时间</li>
<li>最大吞吐率(QPS)<br>  计算公式: qps = 请求查询数 / 秒<br>  每秒查询率QPS是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准</li>
<li>并发连接数<br>  就是服务器某个时刻所接受的所有请求数目</li>
<li>并发用户数<br>  一个用户可能产生多个回话，所以并发用户数和并发连接数并不重复，并发用户数是指服务器某个时刻所能接受的用户数（类似uv）</li>
<li>TPS(每秒传输的事物数)<br>  TPS也就是单位时间内，服务器能处理的最大事务数<br>  一个事务是指一个客户机想服务器发送请求，然后服务器做出反应并进行响应的过程</li>
</ul>
<h3 id="概念浅析"><a href="#概念浅析" class="headerlink" title="概念浅析"></a>概念浅析</h3><ul>
<li>QPS: Queries Per Second，意思是 每秒查询率，是一台服务器每秒能够响应的查询次数，是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准。</li>
<li>TPS: Transactions Per Second的缩写，也就是事物数/每秒，这个完整的事务包括了用户请求服务器、服务器内部处理、服务器返回信息给用户三个过程。它是软件测试结果的衡量单位，一个事务是指一个客户端，想服务器发送请求，然后服务器做出反应的过程。客户端发送请求时开始计时，收到服务器响应后，结束计时，以此来计算使用的时间和完成的事务个数，最终利用这些信息来估计得分。</li>
</ul>
<h3 id="计算QPS"><a href="#计算QPS" class="headerlink" title="计算QPS"></a>计算QPS</h3><ul>
<li>原理：每天80%的访问集中在20%的时间里，这20%的时间叫做峰值时间。</li>
<li>公式: (总pv数 * 80%) / (每天秒数 * 20%) = 峰值时间每秒请求数(QPS)</li>
<li>机器：峰值时间每秒QPS / 单台机器的QPS = 需要的机器数量<br>  问： 每天300w PV 的单台机器上，这台机器需要多少QPS<br>  答： (3000000 * 0.8) / ( 86400 * 0.2) = 139(QPS) 至少需要 139 QPS<br>  问： 如果一台机器的QPS是58，需要几台机器支持<br>  答： 139 / 58 = 3 至少三台</li>
</ul>
<p><a href="https://juejin.im/post/5b827cbbe51d4538c021f2da" target="_blank" rel="noopener">如何对node进行评测、压测</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/memory/2021/05/09/readStream/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FoxDaxian">
      <meta itemprop="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
      <meta itemprop="image" content="/memory/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fox的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/memory/2021/05/09/readStream/" class="post-title-link" itemprop="url">node可读流</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-05-09 23:37:00" itemprop="dateCreated datePublished" datetime="2021-05-09T23:37:00+00:00">2021-05-09</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/memory/categories/初出茅庐/" itemprop="url" rel="index"><span itemprop="name">初出茅庐</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>流（stream）是 Node.js 中处理流式数据的抽象接口。 stream 模块用于构建实现了流接口的对象。</p>
<p>Node.js 提供了多种流对象。 例如，HTTP 服务器的请求和 process.stdout 都是流的实例。</p>
<p>流可以是可读的、可写的、或者可读可写的。 所有的流都是 EventEmitter 的实例。</p>
<p>访问 stream 模块：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> stream = <span class="built_in">require</span>(<span class="string">'stream'</span>);</span><br></pre></td></tr></table></figure>

<p>尽管理解流的工作方式很重要，但是 stream 模块主要用于开发者创建新类型的流实例。 对于以消费流对象为主的开发者，极少需要直接使用 stream 模块。</p>
<p>Node.js 中有四种基本的流类型：</p>
<ul>
<li>Writable - 可写入数据的流（例如 fs.createWriteStream()）。</li>
<li>Readable - 可读取数据的流（例如 fs.createReadStream()）。</li>
<li>Duplex - 可读又可写的流（例如 net.Socket）。</li>
<li>Transform - 在读写过程中可以修改或转换数据的 Duplex 流（例如 zlib.createDeflate()）。</li>
</ul>
<p>此外，该模块还包括实用函数 stream.pipeline()、stream.finished() 和 stream.Readable.from()。</p>
<p>盗图<br><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20191014212453.jpg" alt></p>
<h3 id="如何获取内存中的流"><a href="#如何获取内存中的流" class="headerlink" title="如何获取内存中的流"></a>如何获取内存中的流</h3><p>可写流和可读流都会在内部的缓冲器中存储数据，可以分别使用的 writable.writableBuffer 或 readable.readableBuffer 来获取。<br><a href="http://nodejs.cn/api/stream.html#stream_buffering" target="_blank" rel="noopener">细节</a></p>
<h3 id="可读流"><a href="#可读流" class="headerlink" title="可读流"></a>可读流</h3><h4 id="两种模式"><a href="#两种模式" class="headerlink" title="两种模式"></a>两种模式</h4><ul>
<li>流动模式(不用打，自己动)：数据<code>自动</code>从底层系统读取，并通过EventEmitter接口的事件尽可能快的提供刚给应用程序</li>
<li>暂停模式(打一下，动一下)：必须显示调用<code>stream.read()</code>读取数据块</li>
</ul>
<p>其实，所有可读流<code>初始</code>的时候都处于<code>暂停模式</code>，不过可以通过以下方法切换到流动模式</p>
<ul>
<li>添加 <code>data</code> 事件句柄。</li>
<li>调用 <code>stream.resume()</code> 方法。</li>
<li>调用 <code>stream.pipe()</code> 方法将数据发送到可写流。</li>
</ul>
<p>当然，能切到<code>暂停模式</code>，肯定也能切到<code>流动模式</code></p>
<ul>
<li>如果没有管道目标，则调用 <code>stream.pause()</code></li>
<li>如果有管道目标，则移除所有的管道目标。调用<code>stream.unpipe()</code>可以移除多个管道目标。</li>
</ul>
<p>为了向后兼容，移除 ‘data’ 事件句柄不会自动地暂停流。</p>
<p>如果有管道目标，一旦目标变为 drain 状态并请求接收数据时，则调用 stream.pause() 也不能保证流会保持暂停模式。</p>
<p>如果可读流切换到流动模式，且没有可用的消费者来处理数据，则数据将会丢失。 例如，当调用 readable.resume() 时，没有监听 ‘data’ 事件或 ‘data’ 事件句柄已移除。</p>
<p>添加 <code>readable</code> 事件句柄会使流自动停止流动，并通过 <code>readable.read()</code> 消费数据。 如果 <code>readable</code> 事件句柄被移除，且存在 <code>data</code> 事件句柄，则流会再次开始流动</p>
<h3 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h3><h4 id="流动模式"><a href="#流动模式" class="headerlink" title="流动模式"></a>流动模式</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> rs = fs.createReadStream(path.join(__dirname, <span class="string">'./1.txt'</span>))</span><br><span class="line"></span><br><span class="line">rs.setEncoding(<span class="string">'utf8'</span>)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'data'</span>, (data) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(data)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="暂停模式"><a href="#暂停模式" class="headerlink" title="暂停模式"></a>暂停模式</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> rs = fs.createReadStream(path.join(__dirname, <span class="string">'./1.txt'</span>))</span><br><span class="line"></span><br><span class="line">rs.setEncoding(<span class="string">'utf8'</span>)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'readable'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> d = rs.read(<span class="number">1</span>) <span class="comment">// 要读取的数据的字节数。</span></span><br><span class="line">    <span class="built_in">console</span>.log(d)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="read方法：-参数-可选-size"><a href="#read方法：-参数-可选-size" class="headerlink" title="read方法： 参数 可选 [size]"></a>read方法： 参数 可选 [size]</h3><p>如果没有指定 size 参数，则返回内部缓冲中的所有数据。</p>
<p>使用 <code>readable.read()</code> 处理数据时， while 循环是必需的。<br>read方法消耗的是内存中的数据</p>
<p>当read方法返回的是<code>null</code>的时候，会触发 流监听的 <code>end</code> 事件<br>不使用read消耗内存中的流数据，则不会触发end</p>
<p>预览一波</p>
<p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20191014220028.png" alt></p>
<p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20191014220036.png" alt></p>
<h3 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">process.stdin.setEncoding(<span class="string">'utf8'</span>);</span><br><span class="line"></span><br><span class="line">process.stdin.on(<span class="string">'readable'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> chunk;</span><br><span class="line">    <span class="keyword">while</span> ((chunk = process.stdin.read()) !== <span class="literal">null</span>) &#123;</span><br><span class="line">        process.stdout.write(<span class="string">`数据: <span class="subst">$&#123;chunk&#125;</span>长度<span class="subst">$&#123;chunk.length&#125;</span>\n`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">process.stdin.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">    process.stdout.write(<span class="string">'结束\n'</span>);</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上面的代码作用是读取用户在terminal上的输出，然后输出内容和长度，但是执行的时候，总是无法执行到end，不仅如此，就算内容为空，返回的长度也不为0，这让我很疑惑。</p>
<p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20191014220334.gif" alt></p>
<p>最后发现是坚挺的<code>end</code>事件，只有当read方法返回为null的时候才会触发，所以没有触发，而问题就在于返回的内容是换行符，不同系统下换行符不一样，mac下是<code>\n</code>，所以我们需要处理一下read返回的内容，然后手动end<br>查看字符串中回车符可以使用:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(chunk));</span><br></pre></td></tr></table></figure>

<p>修正后的代码为:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">process.stdin.setEncoding(<span class="string">'utf8'</span>);</span><br><span class="line"></span><br><span class="line">process.stdin.on(<span class="string">'readable'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> chunk;</span><br><span class="line">    <span class="keyword">while</span> ((chunk = process.stdin.read()) !== <span class="literal">null</span>) &#123;</span><br><span class="line">        chunk = chunk.replace(<span class="regexp">/\n/g</span>, <span class="string">''</span>);</span><br><span class="line">        <span class="keyword">if</span> (!chunk.length) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'输入为空'</span>);</span><br><span class="line">            <span class="keyword">return</span> process.stdin.emit(<span class="string">'end'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        process.stdout.write(<span class="string">`数据: <span class="subst">$&#123;chunk&#125;</span>长度<span class="subst">$&#123;chunk.length&#125;</span>\n`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">process.stdin.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">    process.stdout.write(<span class="string">'结束\n'</span>);</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行结果:<br><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20191014221044.gif" alt></p>
<p><a href="http://nodejs.cn/api/stream.html#stream_readable_streams" target="_blank" rel="noopener">中文文档</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/memory/2021/05/09/webpack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FoxDaxian">
      <meta itemprop="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
      <meta itemprop="image" content="/memory/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fox的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/memory/2021/05/09/webpack/" class="post-title-link" itemprop="url">webpack - 优化阻塞渲染的css</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-05-09 23:37:00" itemprop="dateCreated datePublished" datetime="2021-05-09T23:37:00+00:00">2021-05-09</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/memory/categories/原理/" itemprop="url" rel="index"><span itemprop="name">原理</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">随着浏览器的日新月异，网页的性能和速度越来越好，并且对于用户体验来说也越来越重要。</span><br><span class="line">现在有很多优化页面的办法，比如：静态资源的合并和压缩，code splitting，DNS预读取等等。</span><br><span class="line">本文介绍的是另一种优化方法：首屏阻塞css优化</span><br></pre></td></tr></table></figure>

<h5 id="原理："><a href="#原理：" class="headerlink" title="原理："></a>原理：</h5><p>首先我们了解一下页面的基本渲染流程（<a href="https://juejin.im/post/5b88ddca6fb9a019c7717096" target="_blank" rel="noopener">参考</a>）：<br>webkit渲染过程：<br><img src="https://user-gold-cdn.xitu.io/2018/9/3/1659db14e773f9cc?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="webkit渲染过程"><br>Gecko渲染过程:<br><img src="https://user-gold-cdn.xitu.io/2018/9/3/1659db14e7df8a8f?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="gecko渲染过程"><br>那么，为什么要做这种优化呢？上面的流程图就是原因：首先解析html生成dom树，同时解析css生成css树，之后结合两者生成渲染树，然后渲染到屏幕上。不但如此，如果css后面有其他javascript，并且css加载时间过长，也会阻塞后面的js执行，因为js可能会操作dom节点或者css样式，所以需要等待render树完成。那么，如果我们能优化css，那么就能大大减少页面渲染出来的时间，从而提升pv，增加黏性，走向编码巅峰。。。</p>
<hr>
<h5 id="怎么做呢："><a href="#怎么做呢：" class="headerlink" title="怎么做呢："></a>怎么做呢：</h5><p>目前我知道的比较实用的办法是webpack集成<a href="https://github.com/addyosmani/critical" target="_blank" rel="noopener">critical</a>，critical是一个提取关键css，内联到html中，并且使用preload和noscript兼容加载非关键css的工具。<br>那么，我们开门见山，直接从webpack配置开始：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> HtmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">'html-webpack-plugin'</span>); <span class="comment">// 创建html来服务你的资源</span></span><br><span class="line"><span class="keyword">const</span> MiniCssExtractPlugin = <span class="built_in">require</span>(<span class="string">'mini-css-extract-plugin'</span>); <span class="comment">// 提取css到分离的文件，需要webpack4</span></span><br><span class="line"><span class="keyword">const</span> HtmlCriticalWebpackPlugin = <span class="built_in">require</span>(<span class="string">'html-critical-webpack-plugin'</span>); <span class="comment">// 集成critical的html-webpack-plugin版本</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于设置Chromium，因为Chromium使用npm或者yarn经常有问题</span></span><br><span class="line">process.env[<span class="string">'PUPPETEER_EXECUTABLE_PATH'</span>] =</span><br><span class="line">    <span class="string">'你电脑中的Chromium地址'</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    mode: <span class="string">'none'</span>,</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">                <span class="comment">// 使用MiniCssExtractPlugin.loader代替style-loader</span></span><br><span class="line">                use: [MiniCssExtractPlugin.loader, <span class="string">'css-loader'</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">                use: &#123;</span><br><span class="line">                    loader: <span class="string">'babel-loader'</span>,</span><br><span class="line">                    options: &#123;</span><br><span class="line">                        presets: [<span class="string">'@babel/preset-env'</span>]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> HtmlWebpackPlugin(&#123; <span class="attr">template</span>: <span class="string">'./index.html'</span> &#125;),</span><br><span class="line">        <span class="keyword">new</span> MiniCssExtractPlugin(&#123;&#125;),</span><br><span class="line">        <span class="keyword">new</span> HtmlCriticalWebpackPlugin(&#123;</span><br><span class="line">            base: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">            src: <span class="string">'index.html'</span>,</span><br><span class="line">            dest: <span class="string">'index.html'</span>,</span><br><span class="line">            inline: <span class="literal">true</span>,</span><br><span class="line">            minify: <span class="literal">true</span>,</span><br><span class="line">            extract: <span class="literal">true</span>,</span><br><span class="line">            width: <span class="number">375</span>,</span><br><span class="line">            height: <span class="number">565</span>,</span><br><span class="line">            <span class="comment">// 确保调用打包后的JS文件</span></span><br><span class="line">            penthouse: &#123;</span><br><span class="line">                blockJSRequests: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>然后是html文件：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"div"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h2</span>&gt;</span>hello world<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"mask"</span>&gt;</span>这是一个弹窗<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>接着是css文件：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.div</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100vh</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: red;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">h2</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: blue;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.mask</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">500px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">500px</span>;</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">right</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">margin</span>: auto;</span><br><span class="line">	<span class="attribute">background-color</span>: yellowgreen;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行webpack后，查看打包后的html文件：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// 省略...</span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">    <span class="selector-class">.div</span> &#123;</span></span><br><span class="line">        width: 200px;</span><br><span class="line">        height: 100vh;</span><br><span class="line">        background-color: red;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="css">    <span class="selector-class">.mask</span> &#123;</span></span><br><span class="line">        width: 500px;</span><br><span class="line">        height: 500px;</span><br><span class="line">        display: none;</span><br><span class="line">        position: absolute;</span><br><span class="line">        top: 0;</span><br><span class="line">        left: 0;</span><br><span class="line">        bottom: 0;</span><br><span class="line">        right: 0;</span><br><span class="line">        margin: auto;</span><br><span class="line"><span class="css">        <span class="selector-tag">background-color</span>: <span class="selector-id">#9acd32</span>;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span></span></span><br><span class="line"><span class="tag">    <span class="attr">href</span>=<span class="string">"main.80dc2a9c.css"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">rel</span>=<span class="string">"preload"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">as</span>=<span class="string">"style"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">onload</span>=<span class="string">"this.onload=null;this.rel='stylesheet'"</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">noscript</span>&gt;</span><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"main.80dc2a9c.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>/&gt;</span><span class="tag">&lt;/<span class="name">noscript</span>&gt;</span></span><br><span class="line">// 省略...</span><br></pre></td></tr></table></figure>

<h4 id="代码仓库在此，点击fork进行实战练习"><a href="#代码仓库在此，点击fork进行实战练习" class="headerlink" title="代码仓库在此，点击fork进行实战练习"></a><a href="https://github.com/FoxDaxian/webpack4" target="_blank" rel="noopener">代码仓库在此，点击fork进行实战练习</a></h4><p>可以看到，h2标签的css样式没有出现在内联style里，而是出现在main.[hash].css中，因为它不再所设置首屏范围内，这就是所谓的首屏css优化。</p>
<h5 id="相关内容"><a href="#相关内容" class="headerlink" title="相关内容"></a>相关内容</h5><p>在上面打包后的html文件里，我们看到了有一个link内有<code>rel=&quot;preload&quot; as=&quot;style&quot;</code>字段，紧接着下面就有一个<code>noscript</code>标签，这两个是做什么的呢？</p>
<ul>
<li><code>rel=&quot;preload&quot; as=&quot;style&quot;</code>： 用于进行页面预加载，<code>rel=&quot;preload&quot;</code>通知浏览器开始获取非关键CSS以供之后用。其关键在于，<code>preload</code>不阻塞渲染，无论资源是否加载完成，浏览器都会接着绘制页面。并且，搭配as使用，可以指定将要预加载内容的类型，可以让浏览器：<ol>
<li>更精确地优化资源加载优先级。</li>
<li>匹配未来的加载需求，在适当的情况下，重复利用同一资源。</li>
<li>为资源应用正确的内容安全策略。</li>
<li>为资源设置正确的 Accept 请求头。</li>
</ol>
</li>
<li><code>noscript</code>：如果页面上的脚本类型不受支持或者当前在浏览器中关闭了脚本，则在HTML <code>&lt;noscript&gt;</code> 元素中定义脚本未被执行时的替代内容。换句话说，就是当浏览器不支持js脚本或者用户主动关闭脚本，那么就会展示<code>noscript</code>里的内容，而<a href="https://github.com/addyosmani/critical" target="_blank" rel="noopener">critical</a>则是利用这一点做了向后兼容</li>
</ul>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p>利用<a href="https://github.com/addyosmani/critical" target="_blank" rel="noopener">critical</a>可以大大提高页面渲染速度，但是由于其使用puppeteer，所以下载安装比较麻烦，上面的webpack中使用设置env中puppeteer位置的方法解决了这一问题。</p>
<p>文中如若有不对的地方，还望之处，共同交流。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/memory/2021/05/09/regexp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FoxDaxian">
      <meta itemprop="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
      <meta itemprop="image" content="/memory/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fox的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/memory/2021/05/09/regexp/" class="post-title-link" itemprop="url">正则表达式</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-05-09 23:37:00" itemprop="dateCreated datePublished" datetime="2021-05-09T23:37:00+00:00">2021-05-09</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/memory/categories/介绍/" itemprop="url" rel="index"><span itemprop="name">介绍</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>所有的语言的正则表达式还有一些更强大的功能，比如</p>
<p>1、子表达式的索引和回溯<br>2、回溯引用在replace中的应用<br>3、（肯定 | 否定）向前查找<br>4、（肯定 | 否定）向后查找 ===&gt; JS不支持<br>5、条件查找 ===&gt;JS不支持 Orz……</p>
<p>下面说的均是JS的正则</p>
<hr>
<p>一、子表达式的索引和回溯</p>
<p>JS中用括号括起来的大部分都可以成为一个子表达式（按照先后顺序从1到n），而整个正则则是第0个子表达式</p>
<p>例如：var reg = /(好).*?\1/g;  ===&gt;  这里的“（好）”就是正个reg的  第一个  子表达式，后面的“\1”就代表着前面的第一个子表达式，因为是 1 嘛！</p>
<p>让我们来匹配点什么：var str =”你好吗？我很好！”;</p>
<p>str.match(reg) ===&gt; 返回结果：[“好吗？我很好”]</p>
<p>这里看到了，从第一个“好”，匹配到第二个好，这也就是我理解的子表达式的索引和回溯（我是这么叫它的）。</p>
<p>补一句，reg里面的“*?”是懒惰匹配，就是尽量少的匹配，懒惰匹配的原理就是在修饰符的后面几个“？”，因为“？”是匹配0次或者1次嘛，so你懂得。</p>
<p>二、回溯引用在replace中的应用</p>
<p>直接从简单的例子入手：</p>
<p>正则表达式：var reg = /-(\w)/g;</p>
<p>匹配str：var str =”my-love”;</p>
<p>输出：console.log(str.replace(reg,function($0,$1) {</p>
<p>console.log($0);</p>
<p>console.log($1);</p>
<p>}));</p>
<p>结果如下图：</p>
<p>控制台结果</p>
<p>个人分析图如下：</p>
<p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190722172802.png" alt></p>
<p>分析图</p>
<p>相信看了上面的分析，大家也能明白个七八，只要在replace中的函数中 return $1.toLowerCase()，是不是就完成了将带横线的字符转为驼峰字符的功能？大家试一下就会了解。</p>
<p>这里面的“$1”我理解为正则里面的“/1”，也就是说和“/1”的思路是差不多的，只不过应该用到replace中，不过好像也只能用到replace中，其他方面我还没接触到。</p>
<p>三、（肯定 | 否定）向前查找</p>
<p>先问大家一个问题，如果给大家一段话，里面有数字、中文和40$，要求匹配$前面的数字并且不能匹配后面没有$符号的数字，大家会如何匹配呢？（先想一想）</p>
<p>就上面的问题来举例子，从例子入手：</p>
<p>匹配的str：var str =”我出50$买灵能100%第二季”;</p>
<p>正则表达式：var reg = /\d+(?=$)/g;</p>
<p>输出：console.log(str.match(reg));</p>
<p>结果为：[“50”]</p>
<p>这个结果就是我们想要的，而“(?=$)”就是所谓的（肯定）正向查找。</p>
<p>我的理解是：“(?=$)”的“?=”的“=”后面是要匹配的关键字，如果匹配到，就用“\d+”（也就是(?=$)之前的）来匹配关键字之前的字符串或者其他。但是最后不会包含这个关键字哦。现在看起来是不是特别贴合这个名字“向前查找”。</p>
<p>那么（否定）向前查找呢？</p>
<p>还是那个例子只不过把正则表达式换一下</p>
<p>正则表达式：var reg = /\d+(?!$)/g; ===&gt; 注意 这里 将“?=”变为“?!”</p>
<p>返回结果：[“5”, “100”]</p>
<p>为什么是这个结果呢？因为是否定的，也就是取反，从“?!”中的“!”可以看出，匹配的是 数字 加 $ 之外的数字，那么为什么会返回5呢，这个我猜想是懒惰匹配的，所以会匹配“0$”，将前面的“5”抛弃了，并且返回了被匹配字符串的所以其他数字，就是这样喵。</p>
<p>四、（肯定 | 否定）向后查找 和 条件查找不支持，所以就没必要说了。有兴趣的可以自己去看看。</p>
<p>以上内容均属个人简洁，不对的地方望指出，最后祝大家在前端之路上越来越顺利。</p>
<p>没有了<del>~</del></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/memory/2021/05/09/rem/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FoxDaxian">
      <meta itemprop="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
      <meta itemprop="image" content="/memory/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fox的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/memory/2021/05/09/rem/" class="post-title-link" itemprop="url">rem移动端适配</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-05-09 23:37:00" itemprop="dateCreated datePublished" datetime="2021-05-09T23:37:00+00:00">2021-05-09</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/memory/categories/原理/" itemprop="url" rel="index"><span itemprop="name">原理</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>移动端适配，老生常谈的问题，这次再谈一次。<br>闲话少说，直奔正题。</p>
<h3 id="一些像素概念"><a href="#一些像素概念" class="headerlink" title="一些像素概念"></a>一些像素概念</h3><ol>
<li>物理像素：即实际的每一个物理像素，也就是移动设备上每一个物理显示单元（点）</li>
<li>设备逻辑像素（css中的px）：可以理解为一个虚拟的相对的显示块，与物理像素有着一定的比例关系，也就是下面的设备像素比</li>
<li>设备像素比（dpr）：= 物理像素 / 设备独立像素(px)<br>如果dpr为1的话，那么1px = 1物理像素，x轴y轴加起来就是1<img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190618215518.png" alt><br>如果dpr为2的话，那么1px = 2物理像素，x轴y轴加起来就是4<br><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190618215524.png" alt><br>以此类推<br>在js中可以通过<code>window.devicePixelRatio</code>获取当前设备的dpr。</li>
</ol>
<p>这里说明一下，无论dpr多大，1px的大小通常来说是一致的，这也就意味着，随着dpr的增大，物理像素点会越来越小，这样才能容纳更多的物理像素，才能更高清，更retina<br><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190618215817.gif" alt></p>
<hr>
<p>说完基本概念，来说一下几个问题：</p>
<h4 id="retina屏图片模糊"><a href="#retina屏图片模糊" class="headerlink" title="retina屏图片模糊"></a>retina屏图片模糊</h4><p>首先普及一下位图像素：一个位图像素是图片的最小数据单元，每一个单元都包含具体的显示信息（色彩，透明度，位置等等）<br>那为什么在dpr高的retina屏上反而会模糊呢？看图~<br><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190618221043.jpg" alt><br>在1dpr的屏幕上，位图像素和物理像素一一对应没什么问题，但是在retina屏上，由于一个px由4个甚至更多的物理像素组成，并且单个位图像素不能进一步分割，所以会出现就近取色的情况，如果取色不均，那么就会导致图片模糊。<br>对于这种情况，只能采用@2x、@3x这样的倍图来适配高清展示，这样侧向说明了为什么照着iphone6做的ui稿不是375，而是750的问题。<br>虽然这样在dpr为1的屏幕上会导致1个物理像素上有4个位图像素，但是这种情况的取色算法更优，影响不大，不做讨论。</p>
<h4 id="1px的粗细问题"><a href="#1px的粗细问题" class="headerlink" title="1px的粗细问题"></a>1px的粗细问题</h4><p>由于1px的实际大小是一样的，只是里面的物理像素数量不同，所以如果直接写1px是没问题的，不会出现粗细不同的情况，但是这样一来retina的优势也rem的作用也就没了，其实还是dpr的问题，dpr为1，那么1px就是一个物理像素，但是在retina中。1px实际可能有4、9个物理像素，ui想要的其实是1个物理像素，而不是1px，不过由于不是素所有的手机都能适配0.x，所以曲线救国，采用<code>scale</code>缩放或者设置meta都可以<br><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190618223230.jpg" alt></p>
<hr>
<h3 id="viewport"><a href="#viewport" class="headerlink" title="viewport"></a>viewport</h3><h4 id="三个概念："><a href="#三个概念：" class="headerlink" title="三个概念："></a>三个概念：</h4><ol>
<li>layout viewport</li>
<li>visual viewport</li>
<li>ideal viewport</li>
</ol>
<h5 id="layout-viewport"><a href="#layout-viewport" class="headerlink" title="layout viewport"></a>layout viewport</h5><p>最开始，pc上的页面是无法再移动端正常显示的，因为屏幕太小，会挤作一团，所以就有了viewport的概念，又称<code>布局视口</code>（虚拟视口），这个视口大小接近于pc，大部分都是980px。</p>
<h5 id="visual-viewport"><a href="#visual-viewport" class="headerlink" title="visual viewport"></a>visual viewport</h5><p>有了<code>布局视口</code>，还缺一个承载它的真是视口，也就是移动设备的可视区域-<code>视觉视口</code>（物理视口）,这个尺寸随着设备的不同也有不同。这样在<code>视觉视口</code>中创建了一个<code>布局视口</code>，类似<code>overscroll:scroll;</code>这样，可以通过滚动拖拽、缩放扩大进行较好的访问体验。</p>
<h5 id="ideal-viewport"><a href="#ideal-viewport" class="headerlink" title="ideal viewport"></a>ideal viewport</h5><p>像上面的体验在早些年可能比较多，但是近几年几乎很少了，还是归咎于用户体验，所以，我们还需要一个视口-<code>理想视口</code>（同样是虚拟视口），不过这个理想视口的大小是等于<code>布局视口</code>的，这样用户就能得到更好的浏览体验。</p>
<hr>
<h3 id="一个特性"><a href="#一个特性" class="headerlink" title="一个特性"></a>一个特性</h3><p>viewport有六种可以设置的常用属性：</p>
<ol>
<li><p>width：定义layout viewport的宽度，如果不设置，大部分情况下默认是980</p>
</li>
<li><p>height：非常用</p>
</li>
<li><p>initial-scale：可以以某个比例将页面缩放\放大，你也可以用它来设置<code>ideal viewport</code>：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">'viewport'</span> <span class="attr">content</span>=<span class="string">'initial-scale=1'</span> /&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>maximum-scale：限制最大放大比例</p>
</li>
<li><p>minimum-scale：限制最小缩小比例</p>
</li>
<li><p>user-scalable：是否允许用户放大\缩小页面，默认为yes</p>
</li>
</ol>
<hr>
<h3 id="rem适配方案"><a href="#rem适配方案" class="headerlink" title="rem适配方案"></a>rem适配方案</h3><p>先说原理，通过meta修正1px对应的物理像素数量，在根据统一的设计稿来生成html上的动态font-size，根据dpr构造字体等误差较大的样式的mixin</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第一版:</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initRem</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> meta = <span class="built_in">document</span>.querySelector(<span class="string">'meta[name="viewport"]'</span>);;</span><br><span class="line">  <span class="keyword">const</span> html = <span class="built_in">document</span>.documentElement;</span><br><span class="line">  <span class="keyword">const</span> cliW = html.clientWidth;</span><br><span class="line">  <span class="keyword">const</span> dpr = <span class="built_in">window</span>.devicePixelRatio || <span class="number">1</span>;</span><br><span class="line">  meta.setAttribute(<span class="string">'name'</span>, <span class="string">'viewport'</span>);</span><br><span class="line">  meta.setAttribute(</span><br><span class="line">      <span class="string">'content'</span>,</span><br><span class="line">      <span class="string">`width=<span class="subst">$&#123;cliW * dpr&#125;</span>, initial-scale=<span class="subst">$&#123;<span class="number">1</span> <span class="regexp">/</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">          dpr&#125; ,maximum-scale=$&#123;1 /</span> dpr&#125;</span>, minimum-scale=<span class="subst">$&#123;<span class="number">1</span> <span class="regexp">/</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">          dpr&#125;,user-scalable=no`</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">  );</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">  html.setAttribute('data-dpr', dpr);</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">  /</span><span class="regexp">/ 这样计算的好处是，你可以直接用ui的px/</span><span class="number">100</span>得到的就是rem大小，方便快捷，无需mixin</span></span></span><br><span class="line"><span class="string"><span class="subst">  html.style.fontSize = <span class="number">10</span> <span class="regexp">/ 75 * cliW * dpr + 'px';</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">&#125;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">initRem();</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">window.onresize = window.onorientationchange = initRem();</span></span></span></span><br></pre></td></tr></table></figure>

<p>对于引入的第三方ui组件，需要使用px2rem转换工具去做整体转换，比如<a href="https://github.com/cuth/postcss-pxtorem" target="_blank" rel="noopener">postcss-pxtorem</a></p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="http://www.html-js.com/article/Mobile-terminal-H5-mobile-terminal-HD-multi-screen-adaptation-scheme%203041" target="_blank" rel="noopener">移动端高清，多屏适配</a><br><a href="http://helloweb.wang/qianduankaifa/3549.html" target="_blank" rel="noopener">viewport详解</a><br><a href="http://www.ayqy.net/blog/%E5%AE%8C%E5%85%A8%E7%90%86%E8%A7%A3px-dpr-dpi-dip/" target="_blank" rel="noopener">完全理解px dpr dpi dip</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/memory/2021/05/09/rgbConvertHSL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FoxDaxian">
      <meta itemprop="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
      <meta itemprop="image" content="/memory/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fox的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/memory/2021/05/09/rgbConvertHSL/" class="post-title-link" itemprop="url">RGB <=> HSL</=></a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-05-09 23:37:00" itemprop="dateCreated datePublished" datetime="2021-05-09T23:37:00+00:00">2021-05-09</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/memory/categories/原理/" itemprop="url" rel="index"><span itemprop="name">原理</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>首先我们需要了解两种颜色模式：</p>
<ul>
<li>RGB</li>
<li>HSL</li>
</ul>
<h3 id="RGB"><a href="#RGB" class="headerlink" title="RGB"></a>RGB</h3><p>顾名思义，red，green，blue的首字母缩写。RGB是添加剂颜色系统，意味着哪个色值高，最终颜色会更趋向与哪个。如果色值相等，那么趋向于灰色，为0则是黑色，255则是白色。<br>一种替换方案是你可以用十六进制表示，也就是说将各个色值从十进制转换成十六进制。比如：</p>
<p><code>rgb(50, 100, 0)</code> =&gt; <code>#326400</code></p>
<p>不过，RGB很难阅读，或者直观的知道最终的颜色，所以又有了HSL，一种更直观的颜色表示形式。</p>
<h3 id="HSL"><a href="#HSL" class="headerlink" title="HSL"></a>HSL</h3><p>同样，HSL也是首字母缩写：hue，saturation，light。</p>
<ul>
<li>hue：色相 - 色彩的基本属性，单位是角度，所以，我们可以用一个圆环表示出所有的色相<br><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/10_about_color_mode/hue.jpg" alt="12"></li>
<li>saturation：饱和度 - 色彩的纯度，值越高，色彩越纯越浓，越低，色彩越灰越淡。<br><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/10_about_color_mode/saturation.jpg" alt="12"></li>
<li>light：亮度 - 色彩的明暗程度，值越高，月白，直到变成白色，反之变成黑色。该值优先级最高，可以直接影响前两者。。<br><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/10_about_color_mode/light.jpg" alt="12"></li>
</ul>
<h3 id="颜色模式之间的转换"><a href="#颜色模式之间的转换" class="headerlink" title="颜色模式之间的转换"></a>颜色模式之间的转换</h3><p>RGB和HSL都可以将颜色分解成多个属性，要想颜色语法转换，我们需要计算他们的属性。<br>除了hue，其他值都可以用百分比表示，下面的函数中，这些百分比将有小数表示。<br>不过我们不会深入数学公式，只会简单的了解一下，然后转换成js代码。</p>
<h3 id="RGB-转-HSl"><a href="#RGB-转-HSl" class="headerlink" title="RGB 转 HSl"></a>RGB 转 HSl</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rgbToHsl</span>(<span class="params">r, g, b</span>) </span>&#123;</span><br><span class="line">        r /= <span class="number">255</span>, g /= <span class="number">255</span>, b /= <span class="number">255</span>;</span><br><span class="line">        <span class="keyword">var</span> max = <span class="built_in">Math</span>.max(r, g, b), min = <span class="built_in">Math</span>.min(r, g, b);</span><br><span class="line">        <span class="keyword">var</span> h, s, l = (max + min) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (max == min) &#123;</span><br><span class="line">            h = s = <span class="number">0</span>; <span class="comment">// achromatic</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> d = max - min;</span><br><span class="line">            s = l &gt; <span class="number">0.5</span> ? d / (<span class="number">2</span> - max - min) : d / (max + min);</span><br><span class="line">            <span class="keyword">switch</span> (max) &#123;</span><br><span class="line">                <span class="keyword">case</span> r: h = (g - b) / d + (g &lt; b ? <span class="number">6</span> : <span class="number">0</span>); <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> g: h = (b - r) / d + <span class="number">2</span>; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> b: h = (r - g) / d + <span class="number">4</span>; <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            h /= <span class="number">6</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [h, s, l];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="HSL-转-RGB"><a href="#HSL-转-RGB" class="headerlink" title="HSL 转 RGB"></a>HSL 转 RGB</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hslToRgb</span>(<span class="params">h, s, l</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> r, g, b;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (s == <span class="number">0</span>) &#123;</span><br><span class="line">            r = g = b = l; <span class="comment">// achromatic</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> hue2rgb = <span class="function"><span class="keyword">function</span> <span class="title">hue2rgb</span>(<span class="params">p, q, t</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (t &lt; <span class="number">0</span>) t += <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (t &gt; <span class="number">1</span>) t -= <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (t &lt; <span class="number">1</span> / <span class="number">6</span>) <span class="keyword">return</span> p + (q - p) * <span class="number">6</span> * t;</span><br><span class="line">                <span class="keyword">if</span> (t &lt; <span class="number">1</span> / <span class="number">2</span>) <span class="keyword">return</span> q;</span><br><span class="line">                <span class="keyword">if</span> (t &lt; <span class="number">2</span> / <span class="number">3</span>) <span class="keyword">return</span> p + (q - p) * (<span class="number">2</span> / <span class="number">3</span> - t) * <span class="number">6</span>;</span><br><span class="line">                <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> q = l &lt; <span class="number">0.5</span> ? l * (<span class="number">1</span> + s) : l + s - l * s;</span><br><span class="line">            <span class="keyword">var</span> p = <span class="number">2</span> * l - q;</span><br><span class="line">            r = hue2rgb(p, q, h + <span class="number">1</span> / <span class="number">3</span>);</span><br><span class="line">            g = hue2rgb(p, q, h);</span><br><span class="line">            b = hue2rgb(p, q, h - <span class="number">1</span> / <span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">Math</span>.round(r * <span class="number">255</span>), <span class="built_in">Math</span>.round(g * <span class="number">255</span>), <span class="built_in">Math</span>.round(b * <span class="number">255</span>)];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这样我们就可在RGB和HSl之间进行任意转换，有什么奇怪的需求也就没问题啦<br>比如这个<a href="https://codepen.io/AdamGiese/full/989988044f3b8cf6403e3c60f56dd612" target="_blank" rel="noopener">工具</a></p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul>
<li><a href="https://zhuanlan.zhihu.com/p/25576030" target="_blank" rel="noopener">学会调色，从理解HSL面板开始</a></li>
<li><a href="https://www.zhangxinxu.com/wordpress/2010/03/javascript-hex-rgb-hsl-color-convert/" target="_blank" rel="noopener">JS HEX十六进制与RGB, HSL颜色的相互转换</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/memory/2021/05/09/scroll/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FoxDaxian">
      <meta itemprop="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
      <meta itemprop="image" content="/memory/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fox的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/memory/2021/05/09/scroll/" class="post-title-link" itemprop="url">移动端长列表滚动优化</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-05-09 23:37:00" itemprop="dateCreated datePublished" datetime="2021-05-09T23:37:00+00:00">2021-05-09</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/memory/categories/原理/" itemprop="url" rel="index"><span itemprop="name">原理</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>一个滚动列表，无论是pc端还是移动端，一旦列表内容过长，上千甚至上万，对浏览器的性能肯定是会有影响的。这个影响的根本大部分是在渲染，因为重排相对于重绘更消耗性能。甚至页面初始化后，会显示很长时间的loading，这种体验是很差的。</p>
<p>那有没有办法优化这个问题呢？这个就是这次的主题，无限滚动列表。<br>实现的方式有很多，有好有坏，由于刚开始没有参考资料，自己写了一版。<br>大致原理是，计算当前视口的高度，获取滚动的每一项的高度，用视口高度/每一项的高度，就得到了当前可以容纳的最大项。默认进入页面的时候，第一项肯定是0，然后加上最大项，这就是我们真正需要渲染的数量。然后我们需要给当前所有列表的容器加上一个动态高度，这样才能撑起滚动的元素。<br>容器里面的元素给绝对定位，然后通过translateY将决定定位的元素恢复到正确的位置上，当我们滚动的时候，使用 (当前item的索引 + startindex - buffer) * itemHeight 来获取正确translateY<br>这样，就算你有一亿条数据，也仅仅渲染这几条，当然不会卡顿。</p>
<p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/14_scroll/first.png" alt></p>
<p>但是正如上图所示，如果这时候你向下滚动，由于只渲染了这几条，所以当你滚动的时候下面是什么都没有，是一片白的。那么如何解决这个问题呢？<br>我们需要根据滚动距离动态更新第一项的索引，初始化的时候是0，如果每一项高度是20，那么滚动到21的时候，第一项的索引就编程了1，整体都往后移动了一个，这样列表就增量更新了当前视口的列表，但是渲染的数量还是之前那么多。</p>
<p><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190603135600.png" alt></p>
<p>这样就完成了最基本的无限滚动列表，不过，如果滚动稍微快一点的话，还是有空白，因为增量更新的还没来得及渲染完毕，所以这个时候我们需要前后都加上buffer列表项，以适应这种情况。<br><img src="https://raw.githubusercontent.com/FoxDaxian/FoxDaxian.github.io/master/assets/picgo/20190603135923.png" alt></p>
<p>当滚动开始的时候就会提前渲染增量部分。<br>不过，当你滚动更快的时候，还是会有空白的部分，所以需要实现自定义scroll行为，控制用户滚动速度，即可。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/memory/2021/05/09/snabbdom/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FoxDaxian">
      <meta itemprop="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
      <meta itemprop="image" content="/memory/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fox的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/memory/2021/05/09/snabbdom/" class="post-title-link" itemprop="url">snabbdom</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-05-09 23:37:00" itemprop="dateCreated datePublished" datetime="2021-05-09T23:37:00+00:00">2021-05-09</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/memory/categories/原理浅析/" itemprop="url" rel="index"><span itemprop="name">原理浅析</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="什么是虚拟-dom"><a href="#什么是虚拟-dom" class="headerlink" title="什么是虚拟 dom"></a>什么是虚拟 dom</h3><p>总所周知，操作 dom 有性能成本，而损耗性能的关键就是操作过程中造成的重绘、重排，所以如果我们能减少重绘、重排，就能提升 web 性能，进而改善用户体验，虚拟 dom 也就这么产生了。</p>
<p>虚拟 dom 其实就是一个用来描述 Dom 节点的 json 对象，比如 snabbdom 中的声明是这样的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">interface VNode &#123;</span><br><span class="line">  sel: string | <span class="literal">undefined</span>; <span class="comment">// 选择器 tag + id + classnames，也是sameDom判断条件之一</span></span><br><span class="line">  data: VNodeData | <span class="literal">undefined</span>; <span class="comment">// 看下面</span></span><br><span class="line">  children: <span class="built_in">Array</span>&lt;VNode | string&gt; | <span class="literal">undefined</span>; <span class="comment">// 子元素们(与text冲突)</span></span><br><span class="line">  elm: Node | <span class="literal">undefined</span>; <span class="comment">// Vnode对应的真实Dom</span></span><br><span class="line">  text: string | <span class="literal">undefined</span>; <span class="comment">// 子文本节点(与children冲突)</span></span><br><span class="line">  key: Key | <span class="literal">undefined</span>; <span class="comment">// sameDom判断条件之一</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 VNodeData 如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">interface VNodeData &#123;</span><br><span class="line">  props?: Props;</span><br><span class="line">  attrs?: Attrs;</span><br><span class="line">  class?: Classes;</span><br><span class="line">  style?: VNodeStyle;</span><br><span class="line">  dataset?: Dataset;</span><br><span class="line">  on?: On;</span><br><span class="line">  hero?: Hero;</span><br><span class="line">  attachData?: AttachData;</span><br><span class="line">  hook?: Hooks;</span><br><span class="line">  key?: Key;</span><br><span class="line">  ns?: string; <span class="comment">// for SVGs</span></span><br><span class="line">  fn?: <span class="function"><span class="params">()</span> =&gt;</span> VNode; <span class="comment">// for thunks</span></span><br><span class="line">  args?: <span class="built_in">Array</span>&lt;any&gt;; <span class="comment">// for thunks</span></span><br><span class="line">  [key: string]: any; <span class="comment">// for any other 3rd party module</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的结构就是一个个虚拟 dom，东西少，很清晰，也正是因为这种结构的产生，进而衍生了服务端渲染，因为虚拟 dom 不依赖浏览器的 Dom 相关内容，所以可以在几乎任何环境下共存，搞不好以后还能出个 css 同构呢。</p>
<p>剩下的就是如果操作虚拟 dom，进而刷新浏览器的 ui，snabbdom 中，核心方法暂且说成两个，一个是 patch， 一个是 h。</p>
<h3 id="方法解析"><a href="#方法解析" class="headerlink" title="方法解析"></a>方法解析</h3><h4 id="h"><a href="#h" class="headerlink" title="h"></a>h</h4><p>一个用来生成 Vnode 的方法，snabble 中定义了使用案例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">h</span>(<span class="params">sel: string</span>): <span class="title">VNode</span>;</span></span><br><span class="line"><span class="function"><span class="title">function</span> <span class="title">h</span>(<span class="params">sel: string, data: VNodeData</span>): <span class="title">VNode</span>;</span></span><br><span class="line"><span class="function"><span class="title">function</span> <span class="title">h</span>(<span class="params">sel: string, children: VNodeChildren</span>): <span class="title">VNode</span>;</span></span><br><span class="line"><span class="function"><span class="title">function</span> <span class="title">h</span>(<span class="params">sel: string, data: VNodeData, children: VNodeChildren</span>): <span class="title">VNode</span>;</span></span><br></pre></td></tr></table></figure>

<p>方法内的内容很比较简单，通过对函数参数个数的判断，来取到对应的所需参数，然后调用 Vnode 方法，返回创建的 Vnode 实例。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">vnode</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  sel: string | undefined,</span></span></span><br><span class="line"><span class="function"><span class="params">  data: any | undefined,</span></span></span><br><span class="line"><span class="function"><span class="params">  children: Array&lt;VNode | string&gt; | undefined,</span></span></span><br><span class="line"><span class="function"><span class="params">  text: string | undefined,</span></span></span><br><span class="line"><span class="function"><span class="params">  elm: Element | Text | undefined</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">VNode</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> key = data === <span class="literal">undefined</span> ? <span class="literal">undefined</span> : data.key;</span><br><span class="line">  <span class="keyword">return</span> &#123; sel, data, children, text, elm, key &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h4><p>功能主要是三个，比对两个 Vnode 的差异，然后赋值 Vnode.elm 和更新到 html 上，并调用注入的全局钩子</p>
<ul>
<li>比较 Vnode 的差异<br>使用的是 updateChildren，该方法值取新的和旧的 Vnode 的 child 的 startIdx 和 endIdx，然后进行同级别的比较，之所以这么做是因为对于浏览器的场景是适用的，具体细节不啰嗦，也有很多分享，建议自己去看代码，最后我会把带有注释的代码贴上来，做下记录和分享。</li>
<li>赋值并更新 html<br>这块更简单了，就是调用 createElm 方法，然后赋值给 Vnode，之后调用 htmldomapi 里面封装好的各种 DOM 操作方法，进行 dom 的增删改查，updateChildren 中也有一些增删改查的操作。</li>
<li>调用全局钩子<br>这里的钩子是 snabbdom.bound.js 中挂载的，将 用于操作Vnode.data上属性的钩子方法 挂载到 snabbdom.js 中</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// snabbdom.bound.js</span></span><br><span class="line"><span class="keyword">var</span> patch = init([ <span class="comment">// Init patch function with choosen modules</span></span><br><span class="line">  attributesModule,</span><br><span class="line">  classModule,</span><br><span class="line">  propsModule,</span><br><span class="line">  styleModule,</span><br><span class="line">  eventListenersModule</span><br><span class="line">]) <span class="keyword">as</span> (oldVNode: any, <span class="attr">vnode</span>: any) =&gt; any;</span><br><span class="line"></span><br><span class="line"><span class="comment">// attributesModule.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> attributesModule = &#123;<span class="attr">create</span>: updateAttrs, <span class="attr">update</span>: updateAttrs&#125; <span class="keyword">as</span> Module;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// snabbdom.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局钩子们</span></span><br><span class="line"><span class="keyword">const</span> hooks: (keyof Module)[] = [</span><br><span class="line">  <span class="string">"create"</span>,</span><br><span class="line">  <span class="string">"update"</span>,</span><br><span class="line">  <span class="string">"remove"</span>,</span><br><span class="line">  <span class="string">"destroy"</span>,</span><br><span class="line">  <span class="string">"pre"</span>,</span><br><span class="line">  <span class="string">"post"</span></span><br><span class="line">];</span><br><span class="line"><span class="comment">// 声明全局容器</span></span><br><span class="line"><span class="keyword">let</span> cbs = &#123;&#125; <span class="keyword">as</span> ModuleHooks;</span><br><span class="line">    <span class="comment">// 循环hooks</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; hooks.length; ++i) &#123;</span><br><span class="line">        <span class="comment">// 设置cbs的keys，对应value是数组</span></span><br><span class="line">        cbs[hooks[i]] = [];</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; modules.length; ++j) &#123;</span><br><span class="line">            <span class="comment">// 取modules中的每一项中的当前钩子，然后全部push到cbs中的对应key中</span></span><br><span class="line">            <span class="keyword">const</span> hook = modules[j][hooks[i]];</span><br><span class="line">            <span class="keyword">if</span> (hook !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                (cbs[hooks[i]] <span class="keyword">as</span> <span class="built_in">Array</span>&lt;any&gt;).push(hook);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="typescript类型学习"><a href="#typescript类型学习" class="headerlink" title="typescript类型学习"></a>typescript类型学习</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn</span> (<span class="params">modules: Array&lt;Partial&lt;Module&gt;&gt;</span>)</span>&#123;&#125;</span><br><span class="line"><span class="comment">// 首先 &lt;&gt; 是泛型，所以 Array&lt;&gt;代表是一个数组的类型</span></span><br><span class="line"><span class="comment">// 其次Partial代表 =&gt; type Partial&lt;T&gt; = &#123; [P in keyof T]?: T[P] | undefined; &#125;</span></span><br><span class="line"><span class="comment">// 此处只能卧槽并配以一个demo来解释一下，其中Module是对象，如下</span></span><br><span class="line"><span class="comment">//   &#123;</span></span><br><span class="line"><span class="comment">//     可选的Module中的key?: module当前key对应的value | undefined</span></span><br><span class="line"><span class="comment">//   &#125;,</span></span><br><span class="line"><span class="comment">//   ...</span></span><br><span class="line"><span class="comment">// 上面就是Partial代表的意思，大白话解释一下就是，遍历xxx，key为其中的每一个值，因为有问号，所以转换可选，即不一定必须与xxx中的key一一对应，对应value是可选的</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 整个连起来就是: Array&lt;Partial&lt;Module&gt;&gt; =&gt; </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// [</span></span><br><span class="line"><span class="comment">//   &#123;</span></span><br><span class="line"><span class="comment">//     可选的Module中的key: module当前key对应的value | undefined</span></span><br><span class="line"><span class="comment">//   &#125;,</span></span><br><span class="line"><span class="comment">//   ...</span></span><br><span class="line"><span class="comment">// ]</span></span><br></pre></td></tr></table></figure>

<h3 id="snabbdom-js-注释版-不是很长，但是注释比较随性，所以看起来可能不是很舒服"><a href="#snabbdom-js-注释版-不是很长，但是注释比较随性，所以看起来可能不是很舒服" class="headerlink" title="snabbdom.js 注释版(不是很长，但是注释比较随性，所以看起来可能不是很舒服)"></a>snabbdom.js 注释版(不是很长，但是注释比较随性，所以看起来可能不是很舒服)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* global module, document, Node */</span></span><br><span class="line"><span class="comment">// 钩子函数的type和interface</span></span><br><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">"./modules/module"</span>;</span><br><span class="line"><span class="comment">// 定义了一些type和interface</span></span><br><span class="line"><span class="keyword">import</span> &#123; Hooks &#125; <span class="keyword">from</span> <span class="string">"./hooks"</span>;</span><br><span class="line"><span class="keyword">import</span> vnode, &#123; VNode, VNodeData, Key &#125; <span class="keyword">from</span> <span class="string">"./vnode"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> is <span class="keyword">from</span> <span class="string">"./is"</span>;</span><br><span class="line"><span class="keyword">import</span> htmlDomApi, &#123; DOMAPI &#125; <span class="keyword">from</span> <span class="string">"./htmldomapi"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isUndef</span>(<span class="params">s: any</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> s === <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isDef</span>(<span class="params">s: any</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> s !== <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type VNodeQueue = <span class="built_in">Array</span>&lt;VNode&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> emptyNode = vnode(<span class="string">""</span>, &#123;&#125;, [], <span class="literal">undefined</span>, <span class="literal">undefined</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 key 和 选择器 判断说相同</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sameVnode</span>(<span class="params">vnode1: VNode, vnode2: VNode</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> vnode1.key === vnode2.key &amp;&amp; vnode1.sel === vnode2.sel;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isVnode</span>(<span class="params">vnode: any</span>): <span class="title">vnode</span> <span class="title">is</span> <span class="title">VNode</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> vnode.sel !== <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type KeyToIndexMap = &#123; [key: string]: number &#125;;</span><br><span class="line"></span><br><span class="line">type ArraysOf&lt;T&gt; = &#123;</span><br><span class="line">  [K <span class="keyword">in</span> keyof T]: (T[K])[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Module &#123;</span></span><br><span class="line"><span class="comment">//   pre: PreHook;</span></span><br><span class="line"><span class="comment">//   create: CreateHook;</span></span><br><span class="line"><span class="comment">//   update: UpdateHook;</span></span><br><span class="line"><span class="comment">//   destroy: DestroyHook;</span></span><br><span class="line"><span class="comment">//   remove: RemoveHook;</span></span><br><span class="line"><span class="comment">//   post: PostHook;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// type[] =&gt; [a: type, b: type, ...]</span></span><br><span class="line">type ModuleHooks = ArraysOf&lt;Module&gt;;</span><br><span class="line"><span class="comment">// ModuleHooks =&gt; &#123;</span></span><br><span class="line"><span class="comment">//   pre: [prefn1, prefn2],</span></span><br><span class="line"><span class="comment">//   ...</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历 child Vnodes 返回一个 键为 key value 的当前 索引的 对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createKeyToOldIdx</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  children: Array&lt;VNode&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  beginIdx: number,</span></span></span><br><span class="line"><span class="function"><span class="params">  endIdx: number</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">KeyToIndexMap</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> i: number,</span><br><span class="line">    map: KeyToIndexMap = &#123;&#125;,</span><br><span class="line">    key: Key | <span class="literal">undefined</span>,</span><br><span class="line">    ch;</span><br><span class="line">  <span class="keyword">for</span> (i = beginIdx; i &lt;= endIdx; ++i) &#123;</span><br><span class="line">    ch = children[i];</span><br><span class="line">    <span class="keyword">if</span> (ch != <span class="literal">null</span>) &#123;</span><br><span class="line">      key = ch.key;</span><br><span class="line">      <span class="keyword">if</span> (key !== <span class="literal">undefined</span>) map[key] = i;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hooks: (keyof Module)[] = [</span><br><span class="line">  <span class="string">"create"</span>,</span><br><span class="line">  <span class="string">"update"</span>,</span><br><span class="line">  <span class="string">"remove"</span>,</span><br><span class="line">  <span class="string">"destroy"</span>,</span><br><span class="line">  <span class="string">"pre"</span>,</span><br><span class="line">  <span class="string">"post"</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">"./h"</span>;</span><br><span class="line"><span class="keyword">export</span> &#123; thunk &#125; <span class="keyword">from</span> <span class="string">"./thunk"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 首先 Array&lt;Partial&lt;Module&gt;&gt; 中的 &lt;&gt; 是泛型，其次 Partial&lt;xxx&gt; 是关键字，相当于 [key in keyof xxx]?: xxx[key] | undefined，</span></span><br><span class="line"><span class="comment">// 大白话解释一下就是，遍历xxx，key为其中的每一个值，因为有问号，所以转换可选，即不一定必须与xxx中的key一一对应，对应value是可选的</span></span><br><span class="line"><span class="comment">// 所以Array&lt;Partial&lt;Module&gt;&gt;的意思就是</span></span><br><span class="line"><span class="comment">// [</span></span><br><span class="line"><span class="comment">//   &#123;</span></span><br><span class="line"><span class="comment">//     可选的Module中的key: module当前key对应的value | undefined</span></span><br><span class="line"><span class="comment">//   &#125;,</span></span><br><span class="line"><span class="comment">//   ...</span></span><br><span class="line"><span class="comment">// ]</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params">modules: Array&lt;Partial&lt;Module&gt;&gt;, domApi?: DOMAPI</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// as 或者 &lt;&gt; 表明编码者明确知道该变量的类型，并指定</span></span><br><span class="line">  <span class="keyword">let</span> i: number,</span><br><span class="line">    j: number,</span><br><span class="line">    cbs = &#123;&#125; <span class="keyword">as</span> ModuleHooks;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取操作dom的所有api</span></span><br><span class="line">  <span class="keyword">const</span> api: DOMAPI = domApi !== <span class="literal">undefined</span> ? domApi : htmlDomApi;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; hooks.length; ++i) &#123;</span><br><span class="line">    <span class="comment">// cb[hooks中的每一个] = []</span></span><br><span class="line">    cbs[hooks[i]] = [];</span><br><span class="line">    <span class="comment">// modules:</span></span><br><span class="line">    <span class="comment">// [&#123;</span></span><br><span class="line">    <span class="comment">//   create: fn</span></span><br><span class="line">    <span class="comment">// &#125;]</span></span><br><span class="line">    <span class="comment">// 遍历modules，将数组的每一项(key为hooks其一)中的每一项统一添加到cbs中</span></span><br><span class="line">    <span class="comment">// 结果为 cbs</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//   create: [fn1, fn2]</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; modules.length; ++j) &#123;</span><br><span class="line">      <span class="comment">// 判断传入的参数modules中有没有当前hooks，有的话则push</span></span><br><span class="line">      <span class="keyword">const</span> hook = modules[j][hooks[i]];</span><br><span class="line">      <span class="keyword">if</span> (hook !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">        (cbs[hooks[i]] <span class="keyword">as</span> <span class="built_in">Array</span>&lt;any&gt;).push(hook);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回vnode描述</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">emptyNodeAt</span>(<span class="params">elm: Element</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> id = elm.id ? <span class="string">"#"</span> + elm.id : <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">const</span> c = elm.className ? <span class="string">"."</span> + elm.className.split(<span class="string">" "</span>).join(<span class="string">"."</span>) : <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">return</span> vnode(</span><br><span class="line">      api.tagName(elm).toLowerCase() + id + c,</span><br><span class="line">      &#123;&#125;,</span><br><span class="line">      [],</span><br><span class="line">      <span class="literal">undefined</span>,</span><br><span class="line">      elm</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过childElm的父元素 移除childElm</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">createRmCb</span>(<span class="params">childElm: Node, listeners: number</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">rmCb</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (--listeners === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> parent = api.parentNode(childElm);</span><br><span class="line">        api.removeChild(parent, childElm);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据 vnode 创建真实的 dom</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">createElm</span>(<span class="params">vnode: VNode, insertedVnodeQueue: VNodeQueue</span>): <span class="title">Node</span> </span>&#123;</span><br><span class="line">    <span class="comment">// data 是 描述 DOM Node 节点的对象</span></span><br><span class="line">    <span class="keyword">let</span> i: any,</span><br><span class="line">      data = vnode.data;</span><br><span class="line">    <span class="keyword">if</span> (data !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isDef((i = data.hook)) &amp;&amp; isDef((i = i.init))) &#123;</span><br><span class="line">        <span class="comment">// 调用hooks的init方法</span></span><br><span class="line">        i(vnode);</span><br><span class="line">        data = vnode.data;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// VNode的选择器，nodeName+id+class的组合</span></span><br><span class="line">    <span class="keyword">let</span> children = vnode.children,</span><br><span class="line">      sel = vnode.sel;</span><br><span class="line">    <span class="comment">// 创建html注释</span></span><br><span class="line">    <span class="keyword">if</span> (sel === <span class="string">"!"</span>) &#123;</span><br><span class="line">      <span class="comment">// &lt;!-- &lt;div&gt;&lt;/div&gt; --&gt;</span></span><br><span class="line">      <span class="keyword">if</span> (isUndef(vnode.text)) &#123;</span><br><span class="line">        vnode.text = <span class="string">""</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      vnode.elm = api.createComment(vnode.text <span class="keyword">as</span> string);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sel !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="comment">/* 如果有选择器 */</span> <span class="comment">// Parse selector</span></span><br><span class="line">      <span class="comment">// 获取id的索引值</span></span><br><span class="line">      <span class="keyword">const</span> hashIdx = sel.indexOf(<span class="string">"#"</span>);</span><br><span class="line">      <span class="comment">// 从id的索引位置开始，或许class的索引值</span></span><br><span class="line">      <span class="keyword">const</span> dotIdx = sel.indexOf(<span class="string">"."</span>, hashIdx);</span><br><span class="line">      <span class="comment">// 如果有id或class那么返回对应的索引，否则为长度</span></span><br><span class="line">      <span class="keyword">const</span> hash = hashIdx &gt; <span class="number">0</span> ? hashIdx : sel.length;</span><br><span class="line">      <span class="keyword">const</span> dot = dotIdx &gt; <span class="number">0</span> ? dotIdx : sel.length;</span><br><span class="line">      <span class="comment">// 获取dom的tagname</span></span><br><span class="line">      <span class="keyword">const</span> tag =</span><br><span class="line">        hashIdx !== <span class="number">-1</span> || dotIdx !== <span class="number">-1</span></span><br><span class="line">          ? sel.slice(<span class="number">0</span>, <span class="built_in">Math</span>.min(hash, dot))</span><br><span class="line">          : sel;</span><br><span class="line">      <span class="comment">// 创建真实的el或者elns，赋值给当前vnode的elm属性上，又赋值给elm，因为是对象，所以是引用类型，可以在之后直接使用</span></span><br><span class="line">      <span class="keyword">const</span> elm = (vnode.elm =</span><br><span class="line">        isDef(data) &amp;&amp; isDef((i = (data <span class="keyword">as</span> VNodeData).ns))</span><br><span class="line">          ? api.createElementNS(i, tag)</span><br><span class="line">          : api.createElement(tag));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 设置  id  和 class</span></span><br><span class="line">      <span class="keyword">if</span> (hash &lt; dot) elm.setAttribute(<span class="string">"id"</span>, sel.slice(hash + <span class="number">1</span>, dot));</span><br><span class="line">      <span class="keyword">if</span> (dotIdx &gt; <span class="number">0</span>)</span><br><span class="line">        elm.setAttribute(<span class="string">"class"</span>, sel.slice(dot + <span class="number">1</span>).replace(<span class="regexp">/\./g</span>, <span class="string">" "</span>));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 调用create hook</span></span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cbs.create.length; ++i) cbs.create[i](emptyNode, vnode);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 处理 dom 的子dom元素们</span></span><br><span class="line">      <span class="keyword">if</span> (is.array(children)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; children.length; ++i) &#123;</span><br><span class="line">          <span class="keyword">const</span> ch = children[i];</span><br><span class="line">          <span class="keyword">if</span> (ch != <span class="literal">null</span>) &#123;</span><br><span class="line">            api.appendChild(elm, createElm(ch <span class="keyword">as</span> VNode, insertedVnodeQueue));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (is.primitive(vnode.text)) &#123;</span><br><span class="line">        api.appendChild(elm, api.createTextNode(vnode.text));</span><br><span class="line">      &#125;</span><br><span class="line">      i = (vnode.data <span class="keyword">as</span> VNodeData).hook; <span class="comment">// Reuse variable</span></span><br><span class="line">      <span class="keyword">if</span> (isDef(i)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i.create) i.create(emptyNode, vnode);</span><br><span class="line">        <span class="keyword">if</span> (i.insert) insertedVnodeQueue.push(vnode);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="comment">/* 否则创建文本节点 */</span> <span class="keyword">else</span> &#123;</span><br><span class="line">      vnode.elm = api.createTextNode(vnode.text <span class="keyword">as</span> string);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回创建后的 真实dom</span></span><br><span class="line">    <span class="keyword">return</span> vnode.elm;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 插入Vnodes</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">addVnodes</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    parentElm: Node,</span></span></span><br><span class="line"><span class="function"><span class="params">    before: Node | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    vnodes: Array&lt;VNode&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    startIdx: number,</span></span></span><br><span class="line"><span class="function"><span class="params">    endIdx: number,</span></span></span><br><span class="line"><span class="function"><span class="params">    insertedVnodeQueue: VNodeQueue</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (; startIdx &lt;= endIdx; ++startIdx) &#123;</span><br><span class="line">      <span class="keyword">const</span> ch = vnodes[startIdx];</span><br><span class="line">      <span class="keyword">if</span> (ch != <span class="literal">null</span>) &#123;</span><br><span class="line">        api.insertBefore(parentElm, createElm(ch, insertedVnodeQueue), before);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">invokeDestroyHook</span>(<span class="params">vnode: VNode</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> i: any,</span><br><span class="line">      j: number,</span><br><span class="line">      data = vnode.data;</span><br><span class="line">    <span class="keyword">if</span> (data !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="comment">// 调用Vnode的销毁hooks</span></span><br><span class="line">      <span class="keyword">if</span> (isDef((i = data.hook)) &amp;&amp; isDef((i = i.destroy))) i(vnode);</span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cbs.destroy.length; ++i) cbs.destroy[i](vnode);</span><br><span class="line">      <span class="comment">// 递归子元素</span></span><br><span class="line">      <span class="keyword">if</span> (vnode.children !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; vnode.children.length; ++j) &#123;</span><br><span class="line">          i = vnode.children[j];</span><br><span class="line">          <span class="keyword">if</span> (i != <span class="literal">null</span> &amp;&amp; <span class="keyword">typeof</span> i !== <span class="string">"string"</span>) &#123;</span><br><span class="line">            invokeDestroyHook(i);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">removeVnodes</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    parentElm: Node,</span></span></span><br><span class="line"><span class="function"><span class="params">    vnodes: Array&lt;VNode&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    startIdx: number,</span></span></span><br><span class="line"><span class="function"><span class="params">    endIdx: number</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 循环remore传入的Vnodes</span></span><br><span class="line">    <span class="keyword">for</span> (; startIdx &lt;= endIdx; ++startIdx) &#123;</span><br><span class="line">      <span class="keyword">let</span> i: any,</span><br><span class="line">        listeners: number,</span><br><span class="line">        rm: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>,</span><br><span class="line">        ch = vnodes[startIdx];</span><br><span class="line">      <span class="keyword">if</span> (ch != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果是有选择器</span></span><br><span class="line">        <span class="keyword">if</span> (isDef(ch.sel)) &#123;</span><br><span class="line">          invokeDestroyHook(ch);</span><br><span class="line">          listeners = cbs.remove.length + <span class="number">1</span>;</span><br><span class="line">          rm = createRmCb(ch.elm <span class="keyword">as</span> Node, listeners);</span><br><span class="line">          <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cbs.remove.length; ++i) cbs.remove[i](ch, rm);</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            isDef((i = ch.data)) &amp;&amp;</span><br><span class="line">            isDef((i = i.hook)) &amp;&amp;</span><br><span class="line">            isDef((i = i.remove))</span><br><span class="line">          ) &#123;</span><br><span class="line">            i(ch, rm);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            rm();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// Text node</span></span><br><span class="line">          api.removeChild(parentElm, ch.elm <span class="keyword">as</span> Node);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// updateChildren接受的第一个参数是oldVnode的elm，更新的就是这个elm，更新的结果elm还是旧的，不过里面的child发生了变化</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">updateChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    parentElm: Node,</span></span></span><br><span class="line"><span class="function"><span class="params">    oldCh: Array&lt;VNode&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    newCh: Array&lt;VNode&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    insertedVnodeQueue: VNodeQueue</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// old child是待更新的vnode</span></span><br><span class="line">    <span class="comment">// 两个初始值为0的startindex</span></span><br><span class="line">    <span class="keyword">let</span> oldStartIdx = <span class="number">0</span>,</span><br><span class="line">      newStartIdx = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果长度为0，那么length - 1 为 -1，然后下面的while条件就不会通过了</span></span><br><span class="line">    <span class="comment">// 获取old child的长度</span></span><br><span class="line">    <span class="keyword">let</span> oldEndIdx = oldCh.length - <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 获取old child的第一个vnode</span></span><br><span class="line">    <span class="keyword">let</span> oldStartVnode = oldCh[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// 获取old child的最后一个vnode</span></span><br><span class="line">    <span class="keyword">let</span> oldEndVnode = oldCh[oldEndIdx];</span><br><span class="line">    <span class="comment">// 获取new child的最后长度 =&gt; 也就是最后一个vnode的索引</span></span><br><span class="line">    <span class="keyword">let</span> newEndIdx = newCh.length - <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 获取new child的第一个vnode</span></span><br><span class="line">    <span class="keyword">let</span> newStartVnode = newCh[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// 获取new child的最后一个vnode</span></span><br><span class="line">    <span class="keyword">let</span> newEndVnode = newCh[newEndIdx];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> oldKeyToIdx: any;</span><br><span class="line">    <span class="keyword">let</span> idxInOld: number;</span><br><span class="line">    <span class="keyword">let</span> elmToMove: VNode;</span><br><span class="line">    <span class="keyword">let</span> before: any;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ======while的开始====== */</span></span><br><span class="line">    <span class="keyword">while</span> (oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) &#123;</span><br><span class="line">      <span class="comment">/* ======一个if的开始====== */</span></span><br><span class="line">      <span class="comment">// 获取old child的第一个Vnode</span></span><br><span class="line">      <span class="keyword">if</span> (oldStartVnode == <span class="literal">null</span>) &#123;</span><br><span class="line">        oldStartVnode = oldCh[++oldStartIdx]; <span class="comment">// Vnode might have been moved left</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldEndVnode == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">/* 获取old child 最后一个Vnode */</span> oldEndVnode = oldCh[--oldEndIdx];</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newStartVnode == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">/* 获取new child 第一个Vnode */</span> newStartVnode = newCh[++newStartIdx];</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newEndVnode == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">/* 获取new child 最后一个Vnode */</span> newEndVnode = newCh[--newEndIdx];</span><br><span class="line">        <span class="comment">// 上面几步是获取合法的 old child 和 new child的第一个和最后一个Vnode</span></span><br><span class="line">        <span class="comment">// 下面进行old child 和 new chile 的更新，并更新 oldStartVnode 和 newStartVnode</span></span><br><span class="line">        <span class="comment">// ！！！！！！ 下面两个比较是同步推进，也就是说 正序 和 倒叙比较 new child 和 old child</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sameVnode(oldStartVnode, newStartVnode)) &#123;</span><br><span class="line">        patchVnode(oldStartVnode, newStartVnode, insertedVnodeQueue);</span><br><span class="line">        oldStartVnode = oldCh[++oldStartIdx];</span><br><span class="line">        newStartVnode = newCh[++newStartIdx];</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sameVnode(oldEndVnode, newEndVnode)) &#123;</span><br><span class="line">        <span class="comment">/* 同上，不过对比的是最后一组Vnode */</span> patchVnode(</span><br><span class="line">          oldEndVnode,</span><br><span class="line">          newEndVnode,</span><br><span class="line">          insertedVnodeQueue</span><br><span class="line">        );</span><br><span class="line">        oldEndVnode = oldCh[--oldEndIdx];</span><br><span class="line">        newEndVnode = newCh[--newEndIdx];</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sameVnode(oldStartVnode, newEndVnode)) &#123;</span><br><span class="line">        <span class="comment">/* 比较的是 old child 的第一个 和 new child的最后一个 */</span> <span class="comment">// Vnode moved right</span></span><br><span class="line">        patchVnode(oldStartVnode, newEndVnode, insertedVnodeQueue);</span><br><span class="line">        api.insertBefore(</span><br><span class="line">          parentElm,</span><br><span class="line">          oldStartVnode.elm <span class="keyword">as</span> Node,</span><br><span class="line">          api.nextSibling(oldEndVnode.elm <span class="keyword">as</span> Node)</span><br><span class="line">        );</span><br><span class="line">        oldStartVnode = oldCh[++oldStartIdx];</span><br><span class="line">        newEndVnode = newCh[--newEndIdx];</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sameVnode(oldEndVnode, newStartVnode)) &#123;</span><br><span class="line">        <span class="comment">/* 同上 */</span> <span class="comment">// Vnode moved left</span></span><br><span class="line">        patchVnode(oldEndVnode, newStartVnode, insertedVnodeQueue);</span><br><span class="line">        api.insertBefore(</span><br><span class="line">          parentElm,</span><br><span class="line">          oldEndVnode.elm <span class="keyword">as</span> Node,</span><br><span class="line">          oldStartVnode.elm <span class="keyword">as</span> Node</span><br><span class="line">        );</span><br><span class="line">        oldEndVnode = oldCh[--oldEndIdx];</span><br><span class="line">        newStartVnode = newCh[++newStartIdx];</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (oldKeyToIdx === <span class="literal">undefined</span>) &#123;</span><br><span class="line">          <span class="comment">// 获取childVnodes中的 每一个key对应的位置</span></span><br><span class="line">          oldKeyToIdx = createKeyToOldIdx(oldCh, oldStartIdx, oldEndIdx);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取new的Vnode的位置(索引)</span></span><br><span class="line">        idxInOld = oldKeyToIdx[newStartVnode.key <span class="keyword">as</span> string];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isUndef(idxInOld)) &#123;</span><br><span class="line">          <span class="comment">// New element</span></span><br><span class="line">          api.insertBefore(</span><br><span class="line">            parentElm,</span><br><span class="line">            createElm(newStartVnode, insertedVnodeQueue),</span><br><span class="line">            oldStartVnode.elm <span class="keyword">as</span> Node</span><br><span class="line">          );</span><br><span class="line">          newStartVnode = newCh[++newStartIdx];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          elmToMove = oldCh[idxInOld];</span><br><span class="line">          <span class="keyword">if</span> (elmToMove.sel !== newStartVnode.sel) &#123;</span><br><span class="line">            api.insertBefore(</span><br><span class="line">              parentElm,</span><br><span class="line">              createElm(newStartVnode, insertedVnodeQueue),</span><br><span class="line">              oldStartVnode.elm <span class="keyword">as</span> Node</span><br><span class="line">            );</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            patchVnode(elmToMove, newStartVnode, insertedVnodeQueue);</span><br><span class="line">            oldCh[idxInOld] = <span class="literal">undefined</span> <span class="keyword">as</span> any;</span><br><span class="line">            api.insertBefore(</span><br><span class="line">              parentElm,</span><br><span class="line">              elmToMove.elm <span class="keyword">as</span> Node,</span><br><span class="line">              oldStartVnode.elm <span class="keyword">as</span> Node</span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">          newStartVnode = newCh[++newStartIdx];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/* ======一个if的结束====== */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* ======while的结束====== */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这两个 || 代表  至少长度为1，因为如果为0的话 endIdx 为 -1， -1 不会小于等于0，也就是说</span></span><br><span class="line">    <span class="comment">// old child 或者 new child 至少一个长度部位0，如果满足的话进入if</span></span><br><span class="line">    <span class="keyword">if</span> (oldStartIdx &lt;= oldEndIdx || newStartIdx &lt;= newEndIdx) &#123;</span><br><span class="line">      <span class="comment">// 如果old child为空数组，也就是没有child(不代表没有Text)</span></span><br><span class="line">      <span class="keyword">if</span> (oldStartIdx &gt; oldEndIdx) &#123;</span><br><span class="line">        before = newCh[newEndIdx + <span class="number">1</span>] == <span class="literal">null</span> ? <span class="literal">null</span> : newCh[newEndIdx + <span class="number">1</span>].elm;</span><br><span class="line">        addVnodes(</span><br><span class="line">          parentElm,</span><br><span class="line">          before,</span><br><span class="line">          newCh,</span><br><span class="line">          newStartIdx,</span><br><span class="line">          newEndIdx,</span><br><span class="line">          insertedVnodeQueue</span><br><span class="line">        );</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        removeVnodes(parentElm, oldCh, oldStartIdx, oldEndIdx);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* ==========patchVnode开始========== */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">patchVnode</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    oldVnode: VNode,</span></span></span><br><span class="line"><span class="function"><span class="params">    vnode: VNode,</span></span></span><br><span class="line"><span class="function"><span class="params">    insertedVnodeQueue: VNodeQueue</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> i: any, <span class="attr">hook</span>: any;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果有，那么获取vnode.data中的 prepatch(patch前的钩子函数)</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      isDef((i = vnode.data)) &amp;&amp;</span><br><span class="line">      isDef((hook = i.hook)) &amp;&amp;</span><br><span class="line">      isDef((i = hook.prepatch))</span><br><span class="line">    ) &#123;</span><br><span class="line">      i(oldVnode, vnode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> elm = (vnode.elm = oldVnode.elm <span class="keyword">as</span> Node);</span><br><span class="line">    <span class="comment">// 旧的子dom们</span></span><br><span class="line">    <span class="keyword">let</span> oldCh = oldVnode.children;</span><br><span class="line">    <span class="comment">// 新的子dom们</span></span><br><span class="line">    <span class="keyword">let</span> ch = vnode.children;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 引用类型的(指针)判断相等</span></span><br><span class="line">    <span class="keyword">if</span> (oldVnode === vnode) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vnode.data !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cbs.update.length; ++i) cbs.update[i](oldVnode, vnode);</span><br><span class="line">      i = vnode.data.hook;</span><br><span class="line">      <span class="keyword">if</span> (isDef(i) &amp;&amp; isDef((i = i.update))) i(oldVnode, vnode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 不是text 类型</span></span><br><span class="line">    <span class="keyword">if</span> (isUndef(vnode.text)) &#123;</span><br><span class="line">      <span class="comment">// 如果新旧vnode都有child</span></span><br><span class="line">      <span class="keyword">if</span> (isDef(oldCh) &amp;&amp; isDef(ch)) &#123;</span><br><span class="line">        <span class="comment">// 并且不相等</span></span><br><span class="line">        <span class="keyword">if</span> (oldCh !== ch)</span><br><span class="line">          <span class="comment">// 进行更新</span></span><br><span class="line">          updateChildren(</span><br><span class="line">            elm,</span><br><span class="line">            oldCh <span class="keyword">as</span> <span class="built_in">Array</span>&lt;VNode&gt;,</span><br><span class="line">            ch <span class="keyword">as</span> <span class="built_in">Array</span>&lt;VNode&gt;,</span><br><span class="line">            insertedVnodeQueue</span><br><span class="line">          );</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDef(ch)) &#123;</span><br><span class="line">        <span class="comment">/* new child 有子节点 old child 没有 */</span> <span class="keyword">if</span> (isDef(oldVnode.text))</span><br><span class="line">          api.setTextContent(elm, <span class="string">""</span>);</span><br><span class="line">        <span class="comment">// 直接新增</span></span><br><span class="line">        addVnodes(</span><br><span class="line">          elm,</span><br><span class="line">          <span class="literal">null</span>,</span><br><span class="line">          ch <span class="keyword">as</span> <span class="built_in">Array</span>&lt;VNode&gt;,</span><br><span class="line">          <span class="number">0</span>,</span><br><span class="line">          (ch <span class="keyword">as</span> <span class="built_in">Array</span>&lt;VNode&gt;).length - <span class="number">1</span>,</span><br><span class="line">          insertedVnodeQueue</span><br><span class="line">        );</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDef(oldCh)) &#123;</span><br><span class="line">        <span class="comment">/* old child有子节点，new child 没有 */</span> <span class="comment">// 直接删除</span></span><br><span class="line">        removeVnodes(</span><br><span class="line">          elm,</span><br><span class="line">          oldCh <span class="keyword">as</span> <span class="built_in">Array</span>&lt;VNode&gt;,</span><br><span class="line">          <span class="number">0</span>,</span><br><span class="line">          (oldCh <span class="keyword">as</span> <span class="built_in">Array</span>&lt;VNode&gt;).length - <span class="number">1</span></span><br><span class="line">        );</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDef(oldVnode.text)) &#123;</span><br><span class="line">        <span class="comment">/* 新旧都没有子节点 */</span> <span class="comment">// 通过textContent设置文本内容，textContent本身会防止XSS攻击</span></span><br><span class="line">        <span class="comment">// https://developer.mozilla.org/zh-CN/docs/Web/API/Node/textContent</span></span><br><span class="line">        api.setTextContent(elm, <span class="string">""</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldVnode.text !== vnode.text) &#123;</span><br><span class="line">      <span class="comment">/* 如果text节点不一样 */</span> <span class="comment">// 如果old child 有 chile 那么remove</span></span><br><span class="line">      <span class="keyword">if</span> (isDef(oldCh)) &#123;</span><br><span class="line">        removeVnodes(</span><br><span class="line">          elm,</span><br><span class="line">          oldCh <span class="keyword">as</span> <span class="built_in">Array</span>&lt;VNode&gt;,</span><br><span class="line">          <span class="number">0</span>,</span><br><span class="line">          (oldCh <span class="keyword">as</span> <span class="built_in">Array</span>&lt;VNode&gt;).length - <span class="number">1</span></span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 设置为new Vnode 的text</span></span><br><span class="line">      api.setTextContent(elm, vnode.text <span class="keyword">as</span> string);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用postpath钩子</span></span><br><span class="line">    <span class="keyword">if</span> (isDef(hook) &amp;&amp; isDef((i = hook.postpatch))) &#123;</span><br><span class="line">      i(oldVnode, vnode);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* ==========patchVnode结束========== */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">patch</span>(<span class="params">oldVnode: VNode | Element, vnode: VNode</span>): <span class="title">VNode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> i: number, <span class="attr">elm</span>: Node, <span class="attr">parent</span>: Node;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> insertedVnodeQueue: VNodeQueue = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cbs.pre.length; ++i) cbs.pre[i]();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isVnode(oldVnode)) &#123;</span><br><span class="line">      oldVnode = emptyNodeAt(oldVnode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sameVnode(oldVnode, vnode)) &#123;</span><br><span class="line">      patchVnode(oldVnode, vnode, insertedVnodeQueue);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      elm = oldVnode.elm <span class="keyword">as</span> Node;</span><br><span class="line">      parent = api.parentNode(elm);</span><br><span class="line"></span><br><span class="line">      createElm(vnode, insertedVnodeQueue);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (parent !== <span class="literal">null</span>) &#123;</span><br><span class="line">        api.insertBefore(parent, vnode.elm <span class="keyword">as</span> Node, api.nextSibling(elm));</span><br><span class="line">        removeVnodes(parent, [oldVnode], <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; insertedVnodeQueue.length; ++i) &#123;</span><br><span class="line">      (((insertedVnodeQueue[i].data <span class="keyword">as</span> VNodeData).hook <span class="keyword">as</span> Hooks).insert <span class="keyword">as</span> any)(</span><br><span class="line">        insertedVnodeQueue[i]</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cbs.post.length; ++i) cbs.post[i]();</span><br><span class="line">    <span class="keyword">return</span> vnode;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/memory/2021/05/09/splitChunks/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FoxDaxian">
      <meta itemprop="description" content="遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。">
      <meta itemprop="image" content="/memory/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fox的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/memory/2021/05/09/splitChunks/" class="post-title-link" itemprop="url">webpack4分包方案</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-05-09 23:37:00" itemprop="dateCreated datePublished" datetime="2021-05-09T23:37:00+00:00">2021-05-09</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/memory/categories/经验总结/" itemprop="url" rel="index"><span itemprop="name">经验总结</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>webpack4放弃了 commonsChunkPlugin，使用更方便灵活智能的 splitChunks 来做分包的操作。</p>
<p>下面有几个例子，并且我们假设所有的chunks大小至少为30kb(采用splitChunks默认配置)</p>
<h3 id="vendors"><a href="#vendors" class="headerlink" title="vendors"></a>vendors</h3><h5 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h5><p>chunk-a: react react-dom 其他组件<br>chunk-b: react react-dom 其他组件<br>chunk-c: angular 其他组件<br>chunk-d: angular 其他组件</p>
<h5 id="产出"><a href="#产出" class="headerlink" title="产出"></a>产出</h5><p>vendors-chunk-a-chunk-b: react react-dom<br>vendors-chunk-c-chunk-d: angular<br>chunk-a 至 chunk-d: 对应的其他组件</p>
<h3 id="重复的vendors"><a href="#重复的vendors" class="headerlink" title="重复的vendors"></a>重复的vendors</h3><h5 id="入口-1"><a href="#入口-1" class="headerlink" title="入口"></a>入口</h5><p>chunk-a: react react-dom 其他组件<br>chunk-b: react react-dom lodash 其他组件<br>chunk-c: react react-dom lodash 其他组件</p>
<h5 id="产出-1"><a href="#产出-1" class="headerlink" title="产出"></a>产出</h5><p>vendors-chunk-a-chunk-b-chunk-c: react react-dom<br>vendors-chunk-b-chunk-c: lodash<br>chunk-a 至 chunk-c: 对应的其他组件</p>
<h3 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h3><h5 id="入口-2"><a href="#入口-2" class="headerlink" title="入口"></a>入口</h5><p>chunk-a: vue 其他组件 shared组件<br>chunk-b: vue 其他组件 shared组件<br>chunk-c: vue 其他组件 shared组件</p>
<p>假设这里的shared体积超过30kb，这时候webpack会创建vendors和commons两个块</p>
<h5 id="产出-2"><a href="#产出-2" class="headerlink" title="产出"></a>产出</h5><p>vendors-chunk-a-chunk-b-chunk-c: vue<br>commons-chunk-a-chunk-b-chunk-c: shared组件<br>chunk-a 至 chunk-c: 对应的其他组件</p>
<p>如果shared提交小于30kb，webpack不会特意提出来，webpack认为如果仅仅为了减少下载体积的话，这样做是不值得的。</p>
<h3 id="多个共享模块"><a href="#多个共享模块" class="headerlink" title="多个共享模块"></a>多个共享模块</h3><h5 id="入口-3"><a href="#入口-3" class="headerlink" title="入口"></a>入口</h5><p>chunk-a: react react-dom 其他组件 react组件<br>chunk-b: react react-dom angular 其他组件<br>chunk-c: react react-dom angular 其他组件 react组件 angular组件<br>chunk-d: angular 其他组件 angular组件</p>
<h5 id="产出-3"><a href="#产出-3" class="headerlink" title="产出"></a>产出</h5><p>vendors-chunk-a-chunk-b-chunk-c: react react-dom<br>vendors-chunk-b-chunk-c-chunk-d: angular<br>commons-chunk-a-chunk-c: react组件<br>commons-chunk-c-chunk-d: angular组件<br>chunk-a 至 chunk-d: 对应的其他组件</p>
<h3 id="关于webpack默认配置"><a href="#关于webpack默认配置" class="headerlink" title="关于webpack默认配置"></a>关于webpack默认配置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">splitChunks: &#123;</span><br><span class="line">    chunks: <span class="string">"async"</span>,</span><br><span class="line">    minSize: <span class="number">30000</span>,</span><br><span class="line">    minChunks: <span class="number">1</span>,</span><br><span class="line">    maxAsyncRequests: <span class="number">5</span>,</span><br><span class="line">    maxInitialRequests: <span class="number">3</span>,</span><br><span class="line">    automaticNameDelimiter: <span class="string">'~'</span>,</span><br><span class="line">    name: <span class="literal">true</span>,</span><br><span class="line">    cacheGroups: &#123;</span><br><span class="line">      vendors: &#123;</span><br><span class="line">          test: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">          priority: <span class="number">-10</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="keyword">default</span>: &#123;</span><br><span class="line">              minChunks: <span class="number">2</span>,</span><br><span class="line">              priority: <span class="number">-20</span>,</span><br><span class="line">              reuseExistingChunk: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>chunks: 表示从哪些chunks里抽取代码，有三个值：<ol>
<li>initial：初始块，分开打包异步\非异步模块</li>
<li>async：按需加载块, 类似initial，但是不会把同步引入的模块提取到vendors中</li>
<li>all：全部块，无视异步\非异步，如果有异步，统一为异步，也就是提取成一个块，而不是放到入口文件打包内容中</li>
</ol>
</li>
</ul>
<p><a href="https://www.webpackjs.com/api/module-methods/#import-" target="_blank" rel="noopener">通过import()控制模块的一些属性</a></p>
<p>initial情况下，如果两个入口一个是同步引入，一个是异步引入，那么会分开打包，同步的直接将引入包打到入口文件的打包文件里，异步的会分出单独的块，按需引入<br>all情况下，如果一个异步一个同步，会统一分出一个单独的块，然后引入</p>
<ul>
<li>minSize代表最小块大小，如果超出那么则分包，该值为压缩前的。也就是先分包，再压缩</li>
<li>minchunks表示最小引用次数，默认为1</li>
<li>maxAsyncRequests: 按需加载时候最大的并行请求数，默认为5</li>
<li>maxInitialRequests: 一个入口最大的并行请求数，默认为3</li>
<li>automaticNameDelimiter表示打包后人口文件名之间的连接符</li>
<li>name表示拆分出来块的名字</li>
<li>cacheGroups：缓存组，除了上面所有属性外，还包括<ul>
<li>test：匹配条件，只有满足才会进行相应分包，支持函数 正则 字符串</li>
<li>priority：执行优先级，默认为0</li>
<li>reuseExistingChunk：如果当前代码块包含的模块已经存在，那么不在生成重复的块</li>
</ul>
</li>
</ul>
<h3 id="几种配置示例（依赖优先级priority）"><a href="#几种配置示例（依赖优先级priority）" class="headerlink" title="几种配置示例（依赖优先级priority）"></a>几种配置示例（依赖优先级priority）</h3><h5 id="个人感觉其实只要玩好cacheGroups，就能完成各种各样的分包"><a href="#个人感觉其实只要玩好cacheGroups，就能完成各种各样的分包" class="headerlink" title="个人感觉其实只要玩好cacheGroups，就能完成各种各样的分包"></a>个人感觉其实只要玩好cacheGroups，就能完成各种各样的分包</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将所有node_modules中应用2次以上的抽成common块</span></span><br><span class="line">optimization: &#123;</span><br><span class="line">  splitChunks: &#123;</span><br><span class="line">    cacheGroups: &#123;</span><br><span class="line">      common: &#123;</span><br><span class="line">        test: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">        name: <span class="string">'common'</span>,</span><br><span class="line">        chunks: <span class="string">'initial'</span>,</span><br><span class="line">        priority: <span class="number">2</span>,</span><br><span class="line">        minChunks: <span class="number">2</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 把所有超过2次的达成common，不局限于node_modules</span></span><br><span class="line">optimization: &#123;</span><br><span class="line">  cacheGroups: &#123;</span><br><span class="line">    common: &#123;</span><br><span class="line">      name: <span class="string">'common'</span>,</span><br><span class="line">      chunks: <span class="string">'initial'</span>,</span><br><span class="line">      priority: <span class="number">2</span>,</span><br><span class="line">      minChunks: <span class="number">2</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 额外提取react相关基础模块，然后抽取引入超过两次的模块到common</span></span><br><span class="line">optiomization: &#123;</span><br><span class="line">  cacheGroups: &#123;</span><br><span class="line">    reactBase: &#123;</span><br><span class="line">      name: <span class="string">'reactBase'</span>,</span><br><span class="line">      test: <span class="function">(<span class="params"><span class="built_in">module</span></span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="regexp">/react|redux|prop-types/</span>.test(<span class="built_in">module</span>.context);</span><br><span class="line">      &#125;,</span><br><span class="line">      chunks: <span class="string">'initial'</span>,</span><br><span class="line">      priority: <span class="number">10</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    common: &#123;</span><br><span class="line">      name: <span class="string">'common'</span>,</span><br><span class="line">      chunks: <span class="string">'initial'</span>,</span><br><span class="line">      priority: <span class="number">2</span>,</span><br><span class="line">      minChunks: <span class="number">2</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果提取出来的包依然很大，你又想利用好缓存，你可以这样做</span></span><br><span class="line"><span class="comment">// 这样你的每一个node_modules包都是一个chunks，对缓存很友好，会节约很多用户流量，虽然流量已经不之前</span></span><br><span class="line">optimization: &#123;</span><br><span class="line">  cacheGroups: &#123;</span><br><span class="line">    vendor: &#123;</span><br><span class="line">      test: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">      name(<span class="built_in">module</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> packageName = <span class="built_in">module</span>.context.match(<span class="regexp">/[\\/]node_modules[\\/](.*?)([\\/]|$)/</span>)[<span class="number">1</span>];</span><br><span class="line">        <span class="comment">// 避免服务端不支持@</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">`npm.<span class="subst">$&#123;packageName.replace(<span class="string">'@'</span>, <span class="string">''</span>)&#125;</span>`</span>;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h3><p><a href="https://medium.com/webpack/webpack-4-code-splitting-chunk-graph-and-the-splitchunks-optimization-be739a861366" target="_blank" rel="noopener">Code Splitting, chunk graph and the splitChunks optimization</a><br><a href="https://imweb.io/topic/5b66dd601402769b60847149" target="_blank" rel="noopener">webpack4 splitchunks实践探索</a><br><a href="https://medium.com/dailyjs/webpack-4-splitchunks-plugin-d9fbbe091fd0" target="_blank" rel="noopener">chunks解释</a><br><a href="https://medium.com/hackernoon/the-100-correct-way-to-split-your-chunks-with-webpack-f8a9df5b7758#id_token=eyJhbGciOiJSUzI1NiIsImtpZCI6IjYwZjQwNjBlNThkNzVmZDNmNzBiZWZmODhjNzk0YTc3NTMyN2FhMzEiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20iLCJuYmYiOjE1NjYyMTI5OTEsImF1ZCI6IjIxNjI5NjAzNTgzNC1rMWs2cWUwNjBzMnRwMmEyamFtNGxqZGNtczAwc3R0Zy5hcHBzLmdvb2dsZXVzZXJjb250ZW50LmNvbSIsInN1YiI6IjExMTA4NzYzNDY0Nzc3OTk5MDIyNCIsImVtYWlsIjoiOTQ1MDM5MDM2QHFxLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJhenAiOiIyMTYyOTYwMzU4MzQtazFrNnFlMDYwczJ0cDJhMmphbTRsamRjbXMwMHN0dGcuYXBwcy5nb29nbGV1c2VyY29udGVudC5jb20iLCJuYW1lIjoi5Yav5LiW6ZuoIiwicGljdHVyZSI6Imh0dHBzOi8vbGgzLmdvb2dsZXVzZXJjb250ZW50LmNvbS8tanVBdFJLck93ZjgvQUFBQUFBQUFBQUkvQUFBQUFBQUFBQUEvQUNIaTNyZkVWU253cW1TSG81LTh1eWQ3Y0J5dnlUSnBuZy9zOTYtYy9waG90by5qcGciLCJnaXZlbl9uYW1lIjoi5LiW6ZuoIiwiZmFtaWx5X25hbWUiOiLlhq8iLCJpYXQiOjE1NjYyMTMyOTEsImV4cCI6MTU2NjIxNjg5MSwianRpIjoiZjhmMzdhZWFjMjA0NTVjMTNkNDU1ZjU2NjYxYjBiZDcwMmViNmNiYiJ9.r4nXLCswsDW8a4TDA4CEDu-8tN2Ez4NMmpKiR4Lw7uPq5ecvKH6fx8IZ-80V3l7P3AZ_hw-37f-6caTJBjiKT_MHLTt_qSSDIlvkhy2DU19X7-JxZfVoBRXgoMuPUJpOUPoak972TB-6w2pXtGxt0Dyk6jc4IKO4DMT1O9YvyiD-gwBggrhoi82DvLeyPLH6tkcav458gfU475J6U1l1p8T8Sk21QZB_ASraptxFTTaQdwGCDxYPGBpyuESmh5F5QTcq81qwb2dnpZN75-nd7FW1rggAaWpVAi4C3WDILR_TwEjkCf_wAv8UfF4fogy4Xr1acHuwNaLc9RoFBJHbNA" target="_blank" rel="noopener">vendors过大的解决方案</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/memory/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/memory/">1</a><a class="page-number" href="/memory/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/memory/page/4/">4</a><a class="extend next" rel="next" href="/memory/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">FoxDaxian</p>
              <div class="site-description motion-element" itemprop="description">遇到好玩的，稀奇的，新鲜的，记录下来，分享出去。</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/memory/archives/">
                
                    <span class="site-state-item-count">40</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">categories</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">FoxDaxian</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.2.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/memory/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/memory/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/memory/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/memory/js/utils.js?v=7.2.0"></script>

  <script src="/memory/js/motion.js?v=7.2.0"></script>



  
  


  <script src="/memory/js/schemes/muse.js?v=7.2.0"></script>



  

  


  <script src="/memory/js/next-boot.js?v=7.2.0"></script>


  

  

  

  



  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
